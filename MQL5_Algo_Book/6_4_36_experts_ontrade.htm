<!DOCTYPE html>
<html>
  <head>
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1" />
  <title>6.4.36 OnTrade event</title>
  <meta name="keywords" content="" />
  <link type="text/css" href="default.css" rel="stylesheet" />

   <script type="text/javascript" src="jquery.js"></script>
   <script type="text/javascript" src="helpman_settings.js"></script>
   <script type="text/javascript" src="helpman_topicinit.js"></script>


</head>

<body style="background-color:#FFFFFF; font-family:'Trebuchet MS',Tahoma,Arial,Helvetica,sans-serif; margin:0px;">



<table width="100%" height="49"  border="0" cellpadding="0" cellspacing="0" style="margin-top:0px; background-color:#1660af;">
  <tr>
    <td></td>
    <td valign="middle">
      <table style="margin-top:4px; margin-bottom:5px;" width="100%"  border="0" cellspacing="0" cellpadding="5">
        <tr valign="middle">
          <td class="nav">
<a class="h_m" href="index.htm">          MQL5 Programming for Traders </a> / <a class="h_m" href="part6.htm"> Part 6. Trading automation </a> / <a class="h_m" href="6_4_experts.htm"> 6.4 Creating Expert Advisors </a>/ 6.4.36 OnTrade event
          </td>
          <td width="70" align="right">
          <a href="6_4_35_experts_sync_vs_async.htm"><img style="vertical-align:middle;" src="previous.png" alt="?????" width="27" height="27" border=0></a>&nbsp;
          <a href="6_4_37_experts_trade_state.htm"><img style="vertical-align:middle;" src="next.png" alt="??????" width="27" height="27" border="0"></a>
          </td>
        </tr>
      </table>
    </td>
    <td width="5"></td>
  </tr>
</table>



<div id="help">
<p class="p_H3"><span class="f_H3">6.4.36 OnTrade event</span></p>
<p class="p_Text"><span class="f_Text">The </span><span class="f_Text" style="font-style: italic;">OnTrade</span><span class="f_Text"> event occurs when changing the list of placed orders and open positions, the history of orders, and the history of deals. Any trading action (placing/activating/deleting a pending order, opening/closing a position, setting protective levels, etc.) changes the history of orders and deals and/or the list of positions and current orders accordingly. The initiator of an action can be a user, a program, or a server.</span></p>
<p class="p_Text"><span class="f_Text">To receive the event in a program, you should describe the corresponding handler.</span></p>
<p class="p_H4"><span class="f_H4">void OnTrade(void)</span></p>
<p class="p_Text"><span class="f_Text">In the case of sending trade requests using </span><span class="f_Text" style="font-style: italic;">OrderSend/OrderSendAsync</span><span class="f_Text">, one request will trigger multiple </span><span class="f_Text" style="font-style: italic;">OnTrade</span><span class="f_Text"> events since processing usually takes place in several stages and each operation can change the state of orders, positions, and trading history.</span></p>
<p class="p_Text"><span class="f_Text">In general, there is no exact ratio in the number of </span><span class="f_Text" style="font-style: italic;">OnTrade</span><span class="f_Text"> and </span><span class="f_Text" style="font-style: italic;">OnTradeTransaction</span><span class="f_Text"> calls. </span><span class="f_Text" style="font-style: italic;">OnTrade</span><span class="f_Text"> is called after the corresponding calls </span><span class="f_Text" style="font-style: italic;">OnTradeTransaction</span><span class="f_Text">.</span></p>
<p class="p_Text"><span class="f_Text">Since the </span><span class="f_Text" style="font-style: italic;">OnTrade</span><span class="f_Text"> event is of a generalized nature and does not specify the essence of the operation, it is less popular with developers of MQL programs. It is usually necessary to check all aspects of the trading account state in the code and compare it with some saved state, that is, with the applied cache of trading entities used in the trading strategy. In the simplest case, you can, for example, remember the ticket of the created order in the </span><span class="f_Text" style="font-style: italic;">OnTrade</span><span class="f_Text"> handler to interrogate all its properties. However, this may imply the &quot;unnecessary&quot; analysis of a large number of incidental events that are not related to a specific order.</span></p>
<p class="p_Text"><span class="f_Text">We will talk about the possibility of applied caching of the trading environment and history in the section on <a href="6_4_38_experts_multisymbol.htm" class="topiclink">multicurrency Expert Advisors</a>.</span></p>
<p class="p_Text"><span class="f_Text">To further explore </span><span class="f_Text" style="font-style: italic;">OnTrade</span><span class="f_Text">, let's deal with an Expert Advisor implementing a strategy on two OCO (&quot;One Cancels Other&quot;) pending orders. It will place a pair of breakout stop orders and wait for one of them to trigger, after which the second one will be removed. For clarity, we will provide support for both types of trading events, </span><span class="f_Text" style="font-style: italic;">OnTrade</span><span class="f_Text"> and </span><span class="f_Text" style="font-style: italic;">OnTradeTransaction</span><span class="f_Text">, so that the working logic will run either from one handler or another, as chosen by the user.</span></p>
<p class="p_Text"><span class="f_Text">The source code is available in the </span><span class="f_Text" style="font-style: italic;">OCO2.mq5</span><span class="f_Text"> file. Its input parameters include the lot size </span><span class="f_Text" style="font-style: italic;">Volume</span><span class="f_Text"> (default is 0 which means minimum), the </span><span class="f_Text" style="font-style: italic;">Distance2SLTP</span><span class="f_Text"> distance in points to place each of the orders and it also determines the protective levels, the expiration date </span><span class="f_Text" style="font-style: italic;">Expiration</span><span class="f_Text"> in seconds from the setup time, and the event switcher </span><span class="f_Text" style="font-style: italic;">ActivationBy</span><span class="f_Text"> (default, </span><span class="f_Text" style="font-style: italic;">OnTradeTransaction</span><span class="f_Text">). Since </span><span class="f_Text" style="font-style: italic;">Distance2SLTP</span><span class="f_Text"> sets both the offset from the current price and the distance to the stop loss, the stop losses of the two orders are the same and equal to the price at the time of setting.</span></p>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; page-break-after: avoid; border-color: #d8dfea; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExample" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExample" style="color: #0000ff;">enum</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">EVENT_TYPE</span>
<br><span class="f_CodeExample">{</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">ON_TRANSACTION</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #808080;">//&nbsp;OnTradeTransaction</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">ON_TRADE</span><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #808080;">//&nbsp;OnTrade</span>
<br><span class="f_CodeExample">};</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span>
<br><span class="f_CodeExample" style="color: #0000ff;">input</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">double</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">Volume</span><span class="f_CodeExample">;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #808080;">//&nbsp;Volume&nbsp;(0&nbsp;-&nbsp;minimal&nbsp;lot)</span>
<br><span class="f_CodeExample" style="color: #0000ff;">input</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">uint</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">Distance2SLTP</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #333333;">500</span><span class="f_CodeExample">;&nbsp;</span><span class="f_CodeExample" style="color: #808080;">//&nbsp;Distance&nbsp;Indent/SL/TP&nbsp;(points)</span>
<br><span class="f_CodeExample" style="color: #0000ff;">input</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">ulong</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">Magic</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #333333;">1234567890</span><span class="f_CodeExample">;</span>
<br><span class="f_CodeExample" style="color: #0000ff;">input</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">ulong</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">Deviation</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #333333;">10</span><span class="f_CodeExample">;</span>
<br><span class="f_CodeExample" style="color: #0000ff;">input</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">ulong</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">Expiration</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #333333;">0</span><span class="f_CodeExample">;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #808080;">//&nbsp;Expiration&nbsp;(seconds&nbsp;in&nbsp;future,&nbsp;3600&nbsp;-&nbsp;1&nbsp;hour,&nbsp;etc)</span>
<br><span class="f_CodeExample" style="color: #0000ff;">input</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">EVENT_TYPE</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">ActivationBy</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #333333;">ON_TRANSACTION</span><span class="f_CodeExample">;</span></p>
</td>
</tr>
</table>
</div>
<p class="p_Text"><span class="f_Text">To simplify the initialization of request structures, we will describe our own </span><span class="f_Text" style="font-style: italic;">MqlTradeRequestSyncOCO</span><span class="f_Text"> structure derived from </span><span class="f_Text" style="font-style: italic;">MqlTradeRequestSync</span><span class="f_Text">.</span></p>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; page-break-after: avoid; border-color: #d8dfea; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExample" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExample" style="color: #0000ff;">struct</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">MqlTradeRequestSyncOCO</span><span class="f_CodeExample">:&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">public</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">MqlTradeRequestSync</span>
<br><span class="f_CodeExample">{</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">MqlTradeRequestSyncOCO</span><span class="f_CodeExample">()</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;{</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">symbol</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">_Symbol</span><span class="f_CodeExample">;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">magic</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #333333;">Magic</span><span class="f_CodeExample">;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">deviation</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #333333;">Deviation</span><span class="f_CodeExample">;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">if</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">Expiration</span><span class="f_CodeExample">&nbsp;&gt;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">0</span><span class="f_CodeExample">)</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">type_time</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #ff0000;">ORDER_TIME_SPECIFIED</span><span class="f_CodeExample">;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">expiration</span><span class="f_CodeExample">&nbsp;=&nbsp;(</span><span class="f_CodeExample" style="color: #0000ff;">datetime</span><span class="f_CodeExample">)(</span><span class="f_CodeExample" style="color: #0000ff;">TimeCurrent</span><span class="f_CodeExample">()&nbsp;+&nbsp;</span><span class="f_CodeExample" style="color: #333333;">Expiration</span><span class="f_CodeExample">);</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;}</span>
<br><span class="f_CodeExample">};</span></p>
</td>
</tr>
</table>
</div>
<p class="p_Text"><span class="f_Text">At the global level, let's introduce several objects and variables.</span></p>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; page-break-after: avoid; border-color: #d8dfea; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExample" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExample" style="color: #333333;">OrderFilter</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">orders</span><span class="f_CodeExample">;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #808080;">//&nbsp;object&nbsp;for&nbsp;selecting&nbsp;orders</span>
<br><span class="f_CodeExample" style="color: #333333;">PositionFilter</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">trades</span><span class="f_CodeExample">;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #808080;">//&nbsp;object&nbsp;for&nbsp;selecting&nbsp;positions</span>
<br><span class="f_CodeExample" style="color: #0000ff;">bool</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">FirstTick</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">false</span><span class="f_CodeExample">;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #808080;">//&nbsp;or&nbsp;single&nbsp;processing&nbsp;of&nbsp;OnTick&nbsp;at&nbsp;start</span>
<br><span class="f_CodeExample" style="color: #0000ff;">ulong</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">ExecutionCount</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #333333;">0</span><span class="f_CodeExample">;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #808080;">//&nbsp;counter&nbsp;of&nbsp;trading&nbsp;strategy&nbsp;calls&nbsp;RunStrategy()</span></p>
</td>
</tr>
</table>
</div>
<p class="p_Text"><span class="f_Text">All trading logic, except for the start moment, will be triggered by trading events. In the </span><span class="f_Text" style="font-style: italic;">OnInit</span><span class="f_Text"> handler, we set up filter objects and wait for the first tick (set </span><span class="f_Text" style="font-style: italic;">FirstTick</span><span class="f_Text"> to </span><span class="f_Text" style="font-style: italic;">true</span><span class="f_Text">).</span></p>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; page-break-after: avoid; border-color: #d8dfea; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExample" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExample" style="color: #0000ff;">int</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">OnInit</span><span class="f_CodeExample">()</span>
<br><span class="f_CodeExample">{</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">FirstTick</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">true</span><span class="f_CodeExample">;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">orders</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">let</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #ff0000;">ORDER_MAGIC</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">Magic</span><span class="f_CodeExample">).</span><span class="f_CodeExample" style="color: #333333;">let</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #ff0000;">ORDER_SYMBOL</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">_Symbol</span><span class="f_CodeExample">)</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.</span><span class="f_CodeExample" style="color: #333333;">let</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #ff0000;">ORDER_TYPE</span><span class="f_CodeExample">,&nbsp;(</span><span class="f_CodeExample" style="color: #333333;">1</span><span class="f_CodeExample">&nbsp;&lt;&lt;&nbsp;</span><span class="f_CodeExample" style="color: #ff0000;">ORDER_TYPE_BUY_STOP</span><span class="f_CodeExample">)&nbsp;|&nbsp;(</span><span class="f_CodeExample" style="color: #333333;">1</span><span class="f_CodeExample">&nbsp;&lt;&lt;&nbsp;</span><span class="f_CodeExample" style="color: #ff0000;">ORDER_TYPE_SELL_STOP</span><span class="f_CodeExample">),</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">IS</span><span class="f_CodeExample">::</span><span class="f_CodeExample" style="color: #333333;">OR_BITWISE</span><span class="f_CodeExample">);</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">trades</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">let</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #ff0000;">POSITION_MAGIC</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">Magic</span><span class="f_CodeExample">).</span><span class="f_CodeExample" style="color: #333333;">let</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #ff0000;">POSITION_SYMBOL</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">_Symbol</span><span class="f_CodeExample">);</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">return</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #ff0000;">INIT_SUCCEEDED</span><span class="f_CodeExample">;</span>
<br><span class="f_CodeExample">}</span></p>
</td>
</tr>
</table>
</div>
<p class="p_Text"><span class="f_Text">We are only interested in stop orders (buy/sell) and positions with a specific magic number and the current symbol.</span></p>
<p class="p_Text"><span class="f_Text">In the </span><span class="f_Text" style="font-style: italic;">OnTick</span><span class="f_Text"> function, we once call the main part of the algorithm designed as </span><span class="f_Text" style="font-style: italic;">RunStrategy</span><span class="f_Text"> (we will describe it below). Further, this function will be called only from </span><span class="f_Text" style="font-style: italic;">OnTrade</span><span class="f_Text"> or </span><span class="f_Text" style="font-style: italic;">OnTradeTransaction</span><span class="f_Text">.</span></p>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; page-break-after: avoid; border-color: #d8dfea; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExample" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExample" style="color: #0000ff;">void</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">OnTick</span><span class="f_CodeExample">()</span>
<br><span class="f_CodeExample">{</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">if</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">FirstTick</span><span class="f_CodeExample">)</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;{</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">RunStrategy</span><span class="f_CodeExample">();</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">FirstTick</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">false</span><span class="f_CodeExample">;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;}</span>
<br><span class="f_CodeExample">}</span></p>
</td>
</tr>
</table>
</div>
<p class="p_Text"><span class="f_Text">For example, when the </span><span class="f_Text" style="font-style: italic;">OnTrade</span><span class="f_Text"> mode is enabled, this fragment works.</span></p>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; page-break-after: avoid; border-color: #d8dfea; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExample" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExample" style="color: #0000ff;">void</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">OnTrade</span><span class="f_CodeExample">()</span>
<br><span class="f_CodeExample">{</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">static</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">ulong</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">count</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #333333;">0</span><span class="f_CodeExample">;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">PrintFormat</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #008080;">&quot;OnTrade(%d)&quot;</span><span class="f_CodeExample">,&nbsp;++</span><span class="f_CodeExample" style="color: #333333;">count</span><span class="f_CodeExample">);</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">if</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">ActivationBy</span><span class="f_CodeExample">&nbsp;==&nbsp;</span><span class="f_CodeExample" style="color: #333333;">ON_TRADE</span><span class="f_CodeExample">)</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;{</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">RunStrategy</span><span class="f_CodeExample">();</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;}</span>
<br><span class="f_CodeExample">}</span></p>
</td>
</tr>
</table>
</div>
<p class="p_Text"><span class="f_Text">Note that the </span><span class="f_Text" style="font-style: italic;">OnTrade</span><span class="f_Text"> handler calls are counted regardless of whether the strategy is activated here or not. Similarly, the relevant events are counted in the </span><span class="f_Text" style="font-style: italic;">OnTradeTransaction</span><span class="f_Text"> handler (even if they occur in vain). This is done in order to be able to see both events and their counters in the log at the same time.</span></p>
<p class="p_Text"><span class="f_Text">When the </span><span class="f_Text" style="font-style: italic;">OnTradeTransaction</span><span class="f_Text"> mode is on, obviously, </span><span class="f_Text" style="font-style: italic;">RunStrategy</span><span class="f_Text"> starts from there.</span></p>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; page-break-after: avoid; border-color: #d8dfea; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExample" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExample" style="color: #0000ff;">void</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">OnTradeTransaction</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #0000ff;">const</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">MqlTradeTransaction</span><span class="f_CodeExample">&nbsp;&amp;</span><span class="f_CodeExample" style="color: #333333;">transaction</span><span class="f_CodeExample">,</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">const</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">MqlTradeRequest</span><span class="f_CodeExample">&nbsp;&amp;</span><span class="f_CodeExample" style="color: #333333;">request</span><span class="f_CodeExample">,</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">const</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">MqlTradeResult</span><span class="f_CodeExample">&nbsp;&amp;</span><span class="f_CodeExample" style="color: #333333;">result</span><span class="f_CodeExample">)</span>
<br><span class="f_CodeExample">{</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">static</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">ulong</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">count</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #333333;">0</span><span class="f_CodeExample">;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">PrintFormat</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #008080;">&quot;OnTradeTransaction(%d)&quot;</span><span class="f_CodeExample">,&nbsp;++</span><span class="f_CodeExample" style="color: #333333;">count</span><span class="f_CodeExample">);</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">Print</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">TU</span><span class="f_CodeExample">::</span><span class="f_CodeExample" style="color: #333333;">StringOf</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">transaction</span><span class="f_CodeExample">));</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">if</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">ActivationBy</span><span class="f_CodeExample">&nbsp;!=&nbsp;</span><span class="f_CodeExample" style="color: #333333;">ON_TRANSACTION</span><span class="f_CodeExample">)&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">return</span><span class="f_CodeExample">;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">if</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">transaction</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">type</span><span class="f_CodeExample">&nbsp;==&nbsp;</span><span class="f_CodeExample" style="color: #ff0000;">TRADE_TRANSACTION_ORDER_DELETE</span><span class="f_CodeExample">)</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;{</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #808080;">//&nbsp;why&nbsp;not&nbsp;here?&nbsp;for&nbsp;answer,&nbsp;see&nbsp;the&nbsp;text</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #808080;">/*&nbsp;//&nbsp;this&nbsp;won't&nbsp;work&nbsp;online:&nbsp;m.isReady()&nbsp;==&nbsp;false&nbsp;because&nbsp;order&nbsp;temporarily&nbsp;lost</span>
<br><span class="f_CodeExample" style="color: #808080;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OrderMonitor&nbsp;m(transaction.order);</span>
<br><span class="f_CodeExample" style="color: #808080;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(m.isReady()&nbsp;&amp;&amp;&nbsp;m.get(ORDER_MAGIC)&nbsp;==&nbsp;Magic&nbsp;&amp;&amp;&nbsp;m.get(ORDER_SYMBOL)&nbsp;==&nbsp;_Symbol)</span>
<br><span class="f_CodeExample" style="color: #808080;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span>
<br><span class="f_CodeExample" style="color: #808080;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RunStrategy();</span>
<br><span class="f_CodeExample" style="color: #808080;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span>
<br><span class="f_CodeExample" style="color: #808080;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;}</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">else</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">if</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">transaction</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">type</span><span class="f_CodeExample">&nbsp;==&nbsp;</span><span class="f_CodeExample" style="color: #ff0000;">TRADE_TRANSACTION_HISTORY_ADD</span><span class="f_CodeExample">)</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;{</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">OrderMonitor</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">m</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">transaction</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">order</span><span class="f_CodeExample">);</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">if</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">m</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">isReady</span><span class="f_CodeExample">()&nbsp;&amp;&amp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">m</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">get</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #ff0000;">ORDER_MAGIC</span><span class="f_CodeExample">)&nbsp;==&nbsp;</span><span class="f_CodeExample" style="color: #333333;">Magic</span><span class="f_CodeExample">&nbsp;&amp;&amp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">m</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">get</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #ff0000;">ORDER_SYMBOL</span><span class="f_CodeExample">)&nbsp;==&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">_Symbol</span><span class="f_CodeExample">)</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #808080;">//&nbsp;the&nbsp;ORDER_STATE&nbsp;property&nbsp;does&nbsp;not&nbsp;matter&nbsp;-&nbsp;in&nbsp;any&nbsp;case,&nbsp;you&nbsp;need&nbsp;to&nbsp;remove&nbsp;the&nbsp;remaining</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #808080;">//&nbsp;if(transaction.order_state&nbsp;==&nbsp;ORDER_STATE_FILLED</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #808080;">//&nbsp;||&nbsp;transaction.order_state&nbsp;==&nbsp;ORDER_STATE_CANCELED&nbsp;...)</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">RunStrategy</span><span class="f_CodeExample">();</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;}</span>
<br><span class="f_CodeExample">}</span></p>
</td>
</tr>
</table>
</div>
<p class="p_Text"><span class="f_Text">It should be noted that when trading online, a triggered pending order may disappear from the trading environment for some time due to being transferred from the existing ones to history. When we receive the TRADE_TRANSACTION_ORDER_DELETE event, the order has already been removed from the active list but has not yet appeared in history. It only gets there when we receive the TRADE_TRANSACTION_HISTORY_ADD event. This behavior is not observed in the <a href="6_5_tester.htm" class="topiclink">tester</a>, that is, a deleted order is immediately added to history and is available there for selecting and reading properties already in the TRADE_TRANSACTION_ORDER_DELETE phase.</span></p>
<p class="p_Text"><span class="f_Text">In both trade event handlers, we count and log the number of calls. For the case with </span><span class="f_Text" style="font-style: italic;">OnTrade</span><span class="f_Text">, it must match </span><span class="f_Text" style="font-style: italic;">ExecutionCount</span><span class="f_Text"> which we will soon see inside </span><span class="f_Text" style="font-style: italic;">RunStrategy</span><span class="f_Text">. But for </span><span class="f_Text" style="font-style: italic;">OnTradeTransaction</span><span class="f_Text">, the counter and </span><span class="f_Text" style="font-style: italic;">ExecutionCount</span><span class="f_Text"> will differ significantly because the strategy here is called very selectively, for one type of event. Based on this, we can conclude that </span><span class="f_Text" style="font-style: italic;">OnTradeTransaction</span><span class="f_Text"> allows for a more efficient use of resources by calling the algorithm only when appropriate.</span></p>
<p class="p_Text"><span class="f_Text">The </span><span class="f_Text" style="font-style: italic;">ExecutionCount</span><span class="f_Text"> counter is output to the log when the Expert Advisor is unloaded.</span></p>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; page-break-after: avoid; border-color: #d8dfea; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExample" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExample" style="color: #0000ff;">void</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">OnDeinit</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #0000ff;">const</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">int</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">r</span><span class="f_CodeExample">)</span>
<br><span class="f_CodeExample">{</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">Print</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #008080;">&quot;ExecutionCount&nbsp;=&nbsp;&quot;</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">ExecutionCount</span><span class="f_CodeExample">);</span>
<br><span class="f_CodeExample">}</span></p>
</td>
</tr>
</table>
</div>
<p class="p_Text"><span class="f_Text">Now, finally, let's introduce the </span><span class="f_Text" style="font-style: italic;">RunStrategy</span><span class="f_Text"> function. The promised counter is incremented at the very beginning.</span></p>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; page-break-after: avoid; border-color: #d8dfea; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExample" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExample" style="color: #0000ff;">void</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">RunStrategy</span><span class="f_CodeExample">()</span>
<br><span class="f_CodeExample">{</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">ExecutionCount</span><span class="f_CodeExample">++;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;...</span></p>
</td>
</tr>
</table>
</div>
<p class="p_Text"><span class="f_Text">Next, two arrays are described for receiving order tickets and their statuses from the </span><span class="f_Text" style="font-style: italic;">orders</span><span class="f_Text"> filter object.</span></p>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; page-break-after: avoid; border-color: #d8dfea; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExample" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">ulong</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">tickets</span><span class="f_CodeExample">[];</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">ulong</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">states</span><span class="f_CodeExample">[];</span></p>
</td>
</tr>
</table>
</div>
<p class="p_Text"><span class="f_Text">To begin with, we will request orders that fall under our conditions. If there are two of them, everything is fine, and nothing needs to be done.</span></p>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; page-break-after: avoid; border-color: #d8dfea; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExample" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">orders</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">select</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #ff0000;">ORDER_STATE</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">tickets</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">states</span><span class="f_CodeExample">);</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">const</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">int</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">n</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">ArraySize</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">tickets</span><span class="f_CodeExample">);</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">if</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">n</span><span class="f_CodeExample">&nbsp;==&nbsp;</span><span class="f_CodeExample" style="color: #333333;">2</span><span class="f_CodeExample">)&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">return</span><span class="f_CodeExample">;&nbsp;</span><span class="f_CodeExample" style="color: #808080;">//&nbsp;OK&nbsp;-&nbsp;standard&nbsp;state</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;...</span></p>
</td>
</tr>
</table>
</div>
<p class="p_Text"><span class="f_Text">If one order remains, then the other one was triggered and the remaining one must be deleted.</span></p>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; page-break-after: avoid; border-color: #d8dfea; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExample" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">if</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">n</span><span class="f_CodeExample">&nbsp;&gt;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">0</span><span class="f_CodeExample">)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #808080;">//&nbsp;1&nbsp;or&nbsp;2+&nbsp;orders&nbsp;is&nbsp;an&nbsp;error,&nbsp;you&nbsp;need&nbsp;to&nbsp;delete&nbsp;everything</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;{</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #808080;">//&nbsp;delete&nbsp;all&nbsp;matching&nbsp;orders,&nbsp;except&nbsp;for&nbsp;partially&nbsp;filled&nbsp;ones</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">MqlTradeRequestSyncOCO</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">r</span><span class="f_CodeExample">;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">for</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #0000ff;">int</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">i</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #333333;">0</span><span class="f_CodeExample">;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">i</span><span class="f_CodeExample">&nbsp;&lt;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">n</span><span class="f_CodeExample">;&nbsp;++</span><span class="f_CodeExample" style="color: #333333;">i</span><span class="f_CodeExample">)</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">if</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">states</span><span class="f_CodeExample">[</span><span class="f_CodeExample" style="color: #333333;">i</span><span class="f_CodeExample">]&nbsp;!=&nbsp;</span><span class="f_CodeExample" style="color: #ff0000;">ORDER_STATE_PARTIAL</span><span class="f_CodeExample">)</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">r</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">remove</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">tickets</span><span class="f_CodeExample">[</span><span class="f_CodeExample" style="color: #333333;">i</span><span class="f_CodeExample">])&nbsp;&amp;&amp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">r</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">completed</span><span class="f_CodeExample">();</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;}</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;...</span></p>
</td>
</tr>
</table>
</div>
<p class="p_Text"><span class="f_Text">Otherwise, there are no orders. Therefore, you need to check if there is an open position: for this, we use another </span><span class="f_Text" style="font-style: italic;">trades</span><span class="f_Text"> filter object but the results are added to the same receiving array </span><span class="f_Text" style="font-style: italic;">tickets</span><span class="f_Text">. If there is no position, we place a new pair of orders.</span></p>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; page-break-after: avoid; border-color: #d8dfea; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExample" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">else</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #808080;">//&nbsp;n&nbsp;==&nbsp;0</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;{</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #808080;">//&nbsp;if&nbsp;there&nbsp;are&nbsp;no&nbsp;open&nbsp;positions,&nbsp;place&nbsp;2&nbsp;orders</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">if</span><span class="f_CodeExample">(!</span><span class="f_CodeExample" style="color: #333333;">trades</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">select</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">tickets</span><span class="f_CodeExample">))</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">MqlTradeRequestSyncOCO</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">r</span><span class="f_CodeExample">;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">SymbolMonitor</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">sm</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #0000ff;">_Symbol</span><span class="f_CodeExample">);</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">const</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">double</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">point</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #333333;">sm</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">get</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #ff0000;">SYMBOL_POINT</span><span class="f_CodeExample">);</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">const</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">double</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">lot</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #333333;">Volume</span><span class="f_CodeExample">&nbsp;==&nbsp;</span><span class="f_CodeExample" style="color: #333333;">0</span><span class="f_CodeExample">&nbsp;?&nbsp;</span><span class="f_CodeExample" style="color: #333333;">sm</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">get</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #ff0000;">SYMBOL_VOLUME_MIN</span><span class="f_CodeExample">)&nbsp;:&nbsp;</span><span class="f_CodeExample" style="color: #333333;">Volume</span><span class="f_CodeExample">;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">const</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">double</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">buy</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #333333;">sm</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">get</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #ff0000;">SYMBOL_BID</span><span class="f_CodeExample">)&nbsp;+&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">point</span><span class="f_CodeExample">&nbsp;*&nbsp;</span><span class="f_CodeExample" style="color: #333333;">Distance2SLTP</span><span class="f_CodeExample">;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">const</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">double</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">sell</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #333333;">sm</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">get</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #ff0000;">SYMBOL_BID</span><span class="f_CodeExample">)&nbsp;-&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">point</span><span class="f_CodeExample">&nbsp;*&nbsp;</span><span class="f_CodeExample" style="color: #333333;">Distance2SLTP</span><span class="f_CodeExample">;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">r</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">buyStop</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">lot</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">buy</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">buy</span><span class="f_CodeExample">&nbsp;-&nbsp;</span><span class="f_CodeExample" style="color: #333333;">Distance2SLTP</span><span class="f_CodeExample">&nbsp;*&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">point</span><span class="f_CodeExample">,</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">buy</span><span class="f_CodeExample">&nbsp;+&nbsp;</span><span class="f_CodeExample" style="color: #333333;">Distance2SLTP</span><span class="f_CodeExample">&nbsp;*&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">point</span><span class="f_CodeExample">)&nbsp;&amp;&amp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">r</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">completed</span><span class="f_CodeExample">();</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">r</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">sellStop</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">lot</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">sell</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">sell</span><span class="f_CodeExample">&nbsp;+&nbsp;</span><span class="f_CodeExample" style="color: #333333;">Distance2SLTP</span><span class="f_CodeExample">&nbsp;*&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">point</span><span class="f_CodeExample">,</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">sell</span><span class="f_CodeExample">&nbsp;-&nbsp;</span><span class="f_CodeExample" style="color: #333333;">Distance2SLTP</span><span class="f_CodeExample">&nbsp;*&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">point</span><span class="f_CodeExample">)&nbsp;&amp;&amp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">r</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">completed</span><span class="f_CodeExample">();</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;}</span>
<br><span class="f_CodeExample">}</span></p>
</td>
</tr>
</table>
</div>
<p class="p_Text"><span class="f_Text">Let's run the Expert Advisor in the tester with default settings, on the EURUSD pair. The following image shows the testing process.</span></p>
<p class="p_ImageCaption"><img class="help" alt="Expert with a pair of pending stop orders based on the OCO strategy in the tester" title="Expert with a pair of pending stop orders based on the OCO strategy in the tester" width="600" height="400" style="margin:0 auto 0 auto;width:600px;height:400px;border:none" src="oco2test.png"/></p>
<p class="p_ImageCaption"><span class="f_ImageCaption">Expert Advisor with a pair of pending stop orders based on the OCO strategy in the tester</span></p>
<p class="p_Text"><span class="f_Text">At the stage of placing a pair of orders, we will see the following entries in the log.</span></p>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; page-break-after: avoid; border-color: #d8dfea; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">buy&nbsp;stop&nbsp;0.01&nbsp;EURUSD&nbsp;at&nbsp;1.11151&nbsp;sl:&nbsp;1.10651&nbsp;tp:&nbsp;1.11651&nbsp;(1.10646&nbsp;/&nbsp;1.10683)</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">sell&nbsp;stop&nbsp;0.01&nbsp;EURUSD&nbsp;at&nbsp;1.10151&nbsp;sl:&nbsp;1.10651&nbsp;tp:&nbsp;1.09651&nbsp;(1.10646&nbsp;/&nbsp;1.10683)</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">OnTradeTransaction(1)</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">TRADE_TRANSACTION_ORDER_ADD,&nbsp;#=2(ORDER_TYPE_BUY_STOP/ORDER_STATE_PLACED),&nbsp;ORDER_TIME_GTC,&nbsp;EURUSD,&nbsp;&raquo;</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;&nbsp;&nbsp;&raquo;&nbsp;@&nbsp;1.11151,&nbsp;SL=1.10651,&nbsp;TP=1.11651,&nbsp;V=0.01</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">OnTrade(1)</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">OnTradeTransaction(2)</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">TRADE_TRANSACTION_REQUEST</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">OnTradeTransaction(3)</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">TRADE_TRANSACTION_ORDER_ADD,&nbsp;#=3(ORDER_TYPE_SELL_STOP/ORDER_STATE_PLACED),&nbsp;ORDER_TIME_GTC,&nbsp;EURUSD,&nbsp;&raquo;</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;&nbsp;&nbsp;&raquo;&nbsp;@&nbsp;1.10151,&nbsp;SL=1.10651,&nbsp;TP=1.09651,&nbsp;V=0.01</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">OnTrade(2)</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">OnTradeTransaction(4)</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">TRADE_TRANSACTION_REQUEST</span></p>
</td>
</tr>
</table>
</div>
<p class="p_Text"><span class="f_Text">As soon as one of the orders is triggered, this is what happens:</span></p>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; page-break-after: avoid; border-color: #d8dfea; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">order&nbsp;[#3&nbsp;sell&nbsp;stop&nbsp;0.01&nbsp;EURUSD&nbsp;at&nbsp;1.10151]&nbsp;triggered</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">deal&nbsp;#2&nbsp;sell&nbsp;0.01&nbsp;EURUSD&nbsp;at&nbsp;1.10150&nbsp;done&nbsp;(based&nbsp;on&nbsp;order&nbsp;#3)</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">deal&nbsp;performed&nbsp;[#2&nbsp;sell&nbsp;0.01&nbsp;EURUSD&nbsp;at&nbsp;1.10150]</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">order&nbsp;performed&nbsp;sell&nbsp;0.01&nbsp;at&nbsp;1.10150&nbsp;[#3&nbsp;sell&nbsp;stop&nbsp;0.01&nbsp;EURUSD&nbsp;at&nbsp;1.10151]</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">OnTradeTransaction(5)</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">TRADE_TRANSACTION_DEAL_ADD,&nbsp;D=2(DEAL_TYPE_SELL),&nbsp;#=3(ORDER_TYPE_BUY/ORDER_STATE_STARTED),&nbsp;&raquo;</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;&nbsp;&nbsp;&raquo;&nbsp;EURUSD,&nbsp;@&nbsp;1.10150,&nbsp;SL=1.10651,&nbsp;TP=1.09651,&nbsp;V=0.01,&nbsp;P=3</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">OnTrade(3)</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">OnTradeTransaction(6)</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">TRADE_TRANSACTION_ORDER_DELETE,&nbsp;#=3(ORDER_TYPE_SELL_STOP/ORDER_STATE_FILLED),&nbsp;ORDER_TIME_GTC,&nbsp;&raquo;</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;&nbsp;&nbsp;&raquo;&nbsp;EURUSD,&nbsp;@&nbsp;1.10151,&nbsp;SL=1.10651,&nbsp;TP=1.09651,&nbsp;V=0.01,&nbsp;P=3</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">OnTrade(4)</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">OnTradeTransaction(7)</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">TRADE_TRANSACTION_HISTORY_ADD,&nbsp;#=3(ORDER_TYPE_SELL_STOP/ORDER_STATE_FILLED),&nbsp;ORDER_TIME_GTC,&nbsp;&raquo;</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;&nbsp;&nbsp;&raquo;&nbsp;EURUSD,&nbsp;@&nbsp;1.10151,&nbsp;SL=1.10651,&nbsp;TP=1.09651,&nbsp;P=3</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">order&nbsp;canceled&nbsp;[#2&nbsp;buy&nbsp;stop&nbsp;0.01&nbsp;EURUSD&nbsp;at&nbsp;1.11151]</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">OnTrade(5)</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">OnTradeTransaction(8)</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">TRADE_TRANSACTION_ORDER_DELETE,&nbsp;#=2(ORDER_TYPE_BUY_STOP/ORDER_STATE_CANCELED),&nbsp;ORDER_TIME_GTC,&nbsp;&raquo;</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;&nbsp;&nbsp;&raquo;&nbsp;EURUSD,&nbsp;@&nbsp;1.11151,&nbsp;SL=1.10651,&nbsp;TP=1.11651,&nbsp;V=0.01</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">OnTrade(6)</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">OnTradeTransaction(9)</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">TRADE_TRANSACTION_HISTORY_ADD,&nbsp;#=2(ORDER_TYPE_BUY_STOP/ORDER_STATE_CANCELED),&nbsp;ORDER_TIME_GTC,&nbsp;&raquo;</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;&nbsp;&nbsp;&raquo;&nbsp;EURUSD,&nbsp;@&nbsp;1.11151,&nbsp;SL=1.10651,&nbsp;TP=1.11651,&nbsp;V=0.01</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">OnTrade(7)</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">OnTradeTransaction(10)</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">TRADE_TRANSACTION_REQUEST</span></p>
</td>
</tr>
</table>
</div>
<p class="p_Text"><span class="f_Text">Order #3 was deleted by itself, and order #2 was deleted (canceled) by our Expert Advisor.</span></p>
<p class="p_Text"><span class="f_Text">If we run the Expert Advisor with only the mode of operation through the </span><span class="f_Text" style="font-style: italic;">OnTrade</span><span class="f_Text"> event changed in settings, we should get completely similar financial results (ceteris paribus, that is, for example, if random delays in tick generation are not included). The only thing that will be different is the number of </span><span class="f_Text" style="font-style: italic;">RunStrategy</span><span class="f_Text"> function calls. For example, for 4 months of 2022 on EURUSD, H1 with 88 trades, we will get the following approximate metrics of </span><span class="f_Text" style="font-style: italic;">ExecutionCount</span><span class="f_Text"> (what matters is the ratio, not the absolute values associated with your broker's ticks):</span></p>
<ul>
<li class="p_li"><span class="f_li">OnTradeTransaction  132</span></li>
<li class="p_li"><span class="f_li">OnTrade  438</span></li>
</ul>
<p class="p_Text"><span class="f_Text">This is a practical proof of the possibility of building more selective algorithms based on </span><span class="f_Text" style="font-style: italic;">OnTradeTransaction</span><span class="f_Text"> compared with </span><span class="f_Text" style="font-style: italic;">OnTrade</span><span class="f_Text">.</span></p>
<p class="p_Text"><span class="f_Text">This </span><span class="f_Text" style="font-style: italic;">OCO2.mq5</span><span class="f_Text"> Expert Advisor version reacts to actions with orders and positions quite straightforwardly. In particular, as soon as the previous position is closed by stop loss or take profit, it will place two new orders. If you delete one of the orders manually, the Expert Advisor will immediately delete the second one and then recreate a new pair with an offset from the current price. You can improve the behavior by embedding a schedule similar to what is done in the grid Expert Advisor and not reacting to canceled orders in the history (although, please note that MQL5 does not provide means for finding out whether an order was canceled manually or programmatically). We will present a different direction for improving this Expert Advisor when exploring the <a href="7_3_calendar.htm" class="topiclink">economic calendar</a> API.</span></p>
<p class="p_Text"><span class="f_Text">In addition, an interesting mode is already available in the current version, related to setting the expiration date for pending orders in the input variable </span><span class="f_Text" style="font-style: italic;">Expiration</span><span class="f_Text">. If a pair of orders does not trigger, then, immediately after their expiration, a new pair is placed relative to the changed new current price. As an independent exercise, you can try to optimize the Expert Advisor in the tester by changing </span><span class="f_Text" style="font-style: italic;">Expiration</span><span class="f_Text"> and </span><span class="f_Text" style="font-style: italic;">Distance2SLTP</span><span class="f_Text">. Programmatic work with the tester, including in the optimization mode, will be covered in the <a href="6_5_tester.htm" class="topiclink">next chapter</a>.</span></p>
<p class="p_Text"><span class="f_Text">Below is one of the setting options (</span><span class="f_Text" style="font-style: italic;">Distance2SLTP=250</span><span class="f_Text">, </span><span class="f_Text" style="font-style: italic;">Expiration=5000</span><span class="f_Text">) found over a period of 16 months from the beginning of 2021 for the EURUSD pair.</span></p>
<p class="p_ImageCaption"><img class="help" alt="Test Run Results of the OCO2 Expert Advisor" title="Test Run Results of the OCO2 Expert Advisor" width="600" height="400" style="margin:0 auto 0 auto;width:600px;height:400px;border:none" src="oco2_test_250_5000.png"/></p>
<p class="p_ImageCaption"><span class="f_ImageCaption">Test run results of the OCO2 Expert Advisor</span></p>

</div>

</body>
</html>
