<!DOCTYPE html>
<html>
  <head>
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1" />
  <title>7.6.16 Example of searching for trading strategy using SQLite</title>
  <meta name="keywords" content="" />
  <link type="text/css" href="default.css" rel="stylesheet" />

   <script type="text/javascript" src="jquery.js"></script>
   <script type="text/javascript" src="helpman_settings.js"></script>
   <script type="text/javascript" src="helpman_topicinit.js"></script>


</head>

<body style="background-color:#FFFFFF; font-family:'Trebuchet MS',Tahoma,Arial,Helvetica,sans-serif; margin:0px;">



<table width="100%" height="49"  border="0" cellpadding="0" cellspacing="0" style="margin-top:0px; background-color:#1660af;">
  <tr>
    <td></td>
    <td valign="middle">
      <table style="margin-top:4px; margin-bottom:5px;" width="100%"  border="0" cellspacing="0" cellpadding="5">
        <tr valign="middle">
          <td class="nav">
<a class="h_m" href="index.htm">          MQL5 Programming for Traders </a> / <a class="h_m" href="part7.htm"> Part 7. Advanced language tools </a> / <a class="h_m" href="7_6_sqlite.htm"> 7.6 SQLite database </a>/ 7.6.16 Example of searching for a trading strategy using SQLite
          </td>
          <td width="70" align="right">
          <a href="7_6_15_sqlite_print.htm"><img style="vertical-align:middle;" src="previous.png" alt="?????" width="27" height="27" border=0></a>&nbsp;
          <a href="7_7_libraries.htm"><img style="vertical-align:middle;" src="next.png" alt="??????" width="27" height="27" border="0"></a>
          </td>
        </tr>
      </table>
    </td>
    <td width="5"></td>
  </tr>
</table>



<div id="help">
<p class="p_H3"><span class="f_H3">7.6.16 Example of searching for a trading strategy using SQLite</span></p>
<p class="p_Text"><span class="f_Text">Let's try to use SQLite to solve practical problems. We will import structures into the </span><span class="f_Text" style="font-style: italic;">MqlRates</span><span class="f_Text"> database with the history of quotes and analyze them in order to identify patterns and search for potential trading strategies. Of course, any chosen logic can also be implemented in MQL5, but SQL allows you to do it in a different way, in many cases more efficiently and using many interesting built-in SQL functions. The subject of the book, aimed at learning MQL5, does not allow going deep into this technology, but we mention it as worthy of the attention of an algorithmic trader.</span></p>
<p class="p_Text"><span class="f_Text">The script for converting quotes history into a database format is called </span><span class="f_Text" style="font-style: italic;">DBquotesImport.mq5</span><span class="f_Text">. In the input parameters, you can set the prefix of the database name and the size of the transaction (the number of records in one transaction).</span></p>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; page-break-after: avoid; border-color: #d8dfea; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExample" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExample" style="color: #0000ff;">input</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">string</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">Database</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #008080;">&quot;MQL5Book/DB/Quotes&quot;</span><span class="f_CodeExample">;</span>
<br><span class="f_CodeExample" style="color: #0000ff;">input</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">int</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">TransactionSize</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #333333;">1000</span><span class="f_CodeExample">;</span></p>
</td>
</tr>
</table>
</div>
<p class="p_Text"><span class="f_Text">To add </span><span class="f_Text" style="font-style: italic;">MqlRates</span><span class="f_Text"> structures to the database using our ORM layer, the script defines an auxiliary </span><span class="f_Text" style="font-style: italic;">MqlRatesDB</span><span class="f_Text"> structure which provides the rules for binding structure fields to base columns. Since our script only writes data to the database and does not read it from there, it does not need to be bound using the </span><span class="f_Text" style="font-style: italic;">DatabaseReadBind</span><span class="f_Text"> function, which would impose a restriction on the &quot;simplicity&quot; of the structure. The absence of a constraint makes it possible to derive the </span><span class="f_Text" style="font-style: italic;">MqlRatesDB</span><span class="f_Text"> structure from </span><span class="f_Text" style="font-style: italic;">MqlRates</span><span class="f_Text"> (and do not repeat the description of the fields).</span></p>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; page-break-after: avoid; border-color: #d8dfea; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExample" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExample" style="color: #0000ff;">struct</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">MqlRatesDB</span><span class="f_CodeExample">:&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">public</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">MqlRates</span>
<br><span class="f_CodeExample">{</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #808080;">/*&nbsp;for&nbsp;reference:</span>
<br><span class="f_CodeExample" style="color: #808080;">&nbsp;&nbsp;&nbsp;</span>
<br><span class="f_CodeExample" style="color: #808080;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;datetime&nbsp;time;</span>
<br><span class="f_CodeExample" style="color: #808080;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;double&nbsp;&nbsp;&nbsp;open;</span>
<br><span class="f_CodeExample" style="color: #808080;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;double&nbsp;&nbsp;&nbsp;high;</span>
<br><span class="f_CodeExample" style="color: #808080;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;double&nbsp;&nbsp;&nbsp;low;</span>
<br><span class="f_CodeExample" style="color: #808080;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;double&nbsp;&nbsp;&nbsp;close;</span>
<br><span class="f_CodeExample" style="color: #808080;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;long&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tick_volume;</span>
<br><span class="f_CodeExample" style="color: #808080;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;spread;</span>
<br><span class="f_CodeExample" style="color: #808080;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;long&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;real_volume;</span>
<br><span class="f_CodeExample" style="color: #808080;">&nbsp;&nbsp;&nbsp;*/</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">bool</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">bindAll</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">DBQuery</span><span class="f_CodeExample">&nbsp;&amp;</span><span class="f_CodeExample" style="color: #333333;">q</span><span class="f_CodeExample">)&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">const</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;{</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">return</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">q</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">bind</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">0</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">time</span><span class="f_CodeExample">)</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;&amp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">q</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">bind</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">1</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">open</span><span class="f_CodeExample">)</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;&amp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">q</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">bind</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">2</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">high</span><span class="f_CodeExample">)</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;&amp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">q</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">bind</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">3</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">low</span><span class="f_CodeExample">)</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;&amp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">q</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">bind</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">4</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">close</span><span class="f_CodeExample">)</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;&amp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">q</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">bind</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">5</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">tick_volume</span><span class="f_CodeExample">)</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;&amp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">q</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">bind</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">6</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">spread</span><span class="f_CodeExample">)</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;&amp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">q</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">bind</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">7</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">real_volume</span><span class="f_CodeExample">);</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;}</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">long</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">rowid</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #0000ff;">const</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">long</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">setter</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #333333;">0</span><span class="f_CodeExample">)</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;{</span>
<br><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #808080;">//&nbsp;rowid&nbsp;is&nbsp;set&nbsp;by&nbsp;us&nbsp;according&nbsp;to&nbsp;the&nbsp;bar&nbsp;time</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">return</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">time</span><span class="f_CodeExample">;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;}</span>
<br><span class="f_CodeExample">};</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span>
<br><span class="f_CodeExample" style="color: #ff0000;">DB_FIELD_C1</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">MqlRatesDB</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">datetime</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">time</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">DB_CONSTRAINT</span><span class="f_CodeExample">::</span><span class="f_CodeExample" style="color: #333333;">PRIMARY_KEY</span><span class="f_CodeExample">);</span>
<br><span class="f_CodeExample" style="color: #ff0000;">DB_FIELD</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">MqlRatesDB</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">double</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">open</span><span class="f_CodeExample">);</span>
<br><span class="f_CodeExample" style="color: #ff0000;">DB_FIELD</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">MqlRatesDB</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">double</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">high</span><span class="f_CodeExample">);</span>
<br><span class="f_CodeExample" style="color: #ff0000;">DB_FIELD</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">MqlRatesDB</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">double</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">low</span><span class="f_CodeExample">);</span>
<br><span class="f_CodeExample" style="color: #ff0000;">DB_FIELD</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">MqlRatesDB</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">double</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">close</span><span class="f_CodeExample">);</span>
<br><span class="f_CodeExample" style="color: #ff0000;">DB_FIELD</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">MqlRatesDB</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">long</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">tick_volume</span><span class="f_CodeExample">);</span>
<br><span class="f_CodeExample" style="color: #ff0000;">DB_FIELD</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">MqlRatesDB</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">int</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">spread</span><span class="f_CodeExample">);</span>
<br><span class="f_CodeExample" style="color: #ff0000;">DB_FIELD</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">MqlRatesDB</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">long</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">real_volume</span><span class="f_CodeExample">);</span></p>
</td>
</tr>
</table>
</div>
<p class="p_Text"><span class="f_Text">The database name is formed from the prefix </span><span class="f_Text" style="font-style: italic;">Database</span><span class="f_Text">, name, and timeframe of the current chart on which the script is running. A single table &quot;MqlRatesDB&quot; is created in the database with the field configuration specified by the DB_FIELD macros. Please note that the primary key will not be generated by the database, but is taken directly from the bars, from the </span><span class="f_Text" style="font-style: italic;">time</span><span class="f_Text"> field (bar opening time).</span></p>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; page-break-after: avoid; border-color: #d8dfea; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExample" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExample" style="color: #0000ff;">void</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">OnStart</span><span class="f_CodeExample">()</span>
<br><span class="f_CodeExample">{</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">Print</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #008080;">&quot;&quot;</span><span class="f_CodeExample">);</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">DBSQLite</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">db</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">Database</span><span class="f_CodeExample">&nbsp;+&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">_Symbol</span><span class="f_CodeExample">&nbsp;+&nbsp;</span><span class="f_CodeExample" style="color: #333333;">PeriodToString</span><span class="f_CodeExample">());</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">if</span><span class="f_CodeExample">(!</span><span class="f_CodeExample" style="color: #ff0000;">PRTF</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">db</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">isOpen</span><span class="f_CodeExample">()))&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">return</span><span class="f_CodeExample">;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #ff0000;">PRTF</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">db</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">deleteTable</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #0000ff;">typename</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">MqlRatesDB</span><span class="f_CodeExample">)));</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">if</span><span class="f_CodeExample">(!</span><span class="f_CodeExample" style="color: #ff0000;">PRTF</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">db</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">createTable</span><span class="f_CodeExample">&lt;</span><span class="f_CodeExample" style="color: #333333;">MqlRatesDB</span><span class="f_CodeExample">&gt;(</span><span class="f_CodeExample" style="color: #0000ff;">true</span><span class="f_CodeExample">)))&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">return</span><span class="f_CodeExample">;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;...</span></p>
</td>
</tr>
</table>
</div>
<p class="p_Text"><span class="f_Text">Next, using packages of </span><span class="f_Text" style="font-style: italic;">TransactionSize</span><span class="f_Text"> bars, we request bars from the history and add them to the table. This is a job of the helper function </span><span class="f_Text" style="font-style: italic;">ReadChunk</span><span class="f_Text">, called in a loop as long as there is data (the function returns </span><span class="f_Text" style="font-style: italic;">true</span><span class="f_Text">) or the user won't stop the script manually. The function code is shown below.</span></p>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; page-break-after: avoid; border-color: #d8dfea; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExample" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">int</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">offset</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #333333;">0</span><span class="f_CodeExample">;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">while</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">ReadChunk</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">db</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">offset</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">TransactionSize</span><span class="f_CodeExample">)&nbsp;&amp;&amp;&nbsp;!</span><span class="f_CodeExample" style="color: #0000ff;">IsStopped</span><span class="f_CodeExample">())</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;{</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">offset</span><span class="f_CodeExample">&nbsp;+=&nbsp;</span><span class="f_CodeExample" style="color: #333333;">TransactionSize</span><span class="f_CodeExample">;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;}</span></p>
</td>
</tr>
</table>
</div>
<p class="p_Text"><span class="f_Text">Upon completion of the process, we ask the database for the number of generated records in the table and output it to the log.</span></p>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; page-break-after: avoid; border-color: #d8dfea; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExample" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">DBRow</span><span class="f_CodeExample">&nbsp;*</span><span class="f_CodeExample" style="color: #333333;">rows</span><span class="f_CodeExample">[];</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">if</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">db</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">prepare</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #0000ff;">StringFormat</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #008080;">&quot;SELECT&nbsp;COUNT(*)&nbsp;FROM&nbsp;%s&quot;</span><span class="f_CodeExample">,</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">typename</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">MqlRatesDB</span><span class="f_CodeExample">))).</span><span class="f_CodeExample" style="color: #333333;">readAll</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">rows</span><span class="f_CodeExample">))</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;{</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">Print</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #008080;">&quot;Records&nbsp;added:&nbsp;&quot;</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">rows</span><span class="f_CodeExample">[</span><span class="f_CodeExample" style="color: #333333;">0</span><span class="f_CodeExample">][</span><span class="f_CodeExample" style="color: #333333;">0</span><span class="f_CodeExample">].</span><span class="f_CodeExample" style="color: #333333;">integer_value</span><span class="f_CodeExample">);</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;}</span>
<br><span class="f_CodeExample">}</span></p>
</td>
</tr>
</table>
</div>
<p class="p_Text"><span class="f_Text">The </span><span class="f_Text" style="font-style: italic;">ReadChunk</span><span class="f_Text"> function looks as follows.</span></p>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; page-break-after: avoid; border-color: #d8dfea; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExample" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExample" style="color: #0000ff;">bool</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">ReadChunk</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">DBSQLite</span><span class="f_CodeExample">&nbsp;&amp;</span><span class="f_CodeExample" style="color: #333333;">db</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">const</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">int</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">offset</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">const</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">int</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">size</span><span class="f_CodeExample">)</span>
<br><span class="f_CodeExample">{</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">MqlRates</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">rates</span><span class="f_CodeExample">[];</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">MqlRatesDB</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">ratesDB</span><span class="f_CodeExample">[];</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">const</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">int</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">n</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">CopyRates</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #0000ff;">_Symbol</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #ff0000;">PERIOD_CURRENT</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">offset</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">size</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">rates</span><span class="f_CodeExample">);</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">if</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">n</span><span class="f_CodeExample">&nbsp;&gt;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">0</span><span class="f_CodeExample">)</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;{</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">DBTransaction</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">tr</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">db</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">true</span><span class="f_CodeExample">);</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">Print</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">rates</span><span class="f_CodeExample">[</span><span class="f_CodeExample" style="color: #333333;">0</span><span class="f_CodeExample">].</span><span class="f_CodeExample" style="color: #333333;">time</span><span class="f_CodeExample">);</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">ArrayResize</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">ratesDB</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">n</span><span class="f_CodeExample">);</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">for</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #0000ff;">int</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">i</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #333333;">0</span><span class="f_CodeExample">;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">i</span><span class="f_CodeExample">&nbsp;&lt;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">n</span><span class="f_CodeExample">;&nbsp;++</span><span class="f_CodeExample" style="color: #333333;">i</span><span class="f_CodeExample">)</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">ratesDB</span><span class="f_CodeExample">[</span><span class="f_CodeExample" style="color: #333333;">i</span><span class="f_CodeExample">]&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #333333;">rates</span><span class="f_CodeExample">[</span><span class="f_CodeExample" style="color: #333333;">i</span><span class="f_CodeExample">];</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">return</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">db</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">insert</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">ratesDB</span><span class="f_CodeExample">);</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;}</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">else</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;{</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">Print</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #008080;">&quot;CopyRates&nbsp;failed:&nbsp;&quot;</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">_LastError</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #008080;">&quot;&nbsp;&quot;</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">E2S</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #0000ff;">_LastError</span><span class="f_CodeExample">));</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;}</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">return</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">false</span><span class="f_CodeExample">;</span>
<br><span class="f_CodeExample">}</span></p>
</td>
</tr>
</table>
</div>
<p class="p_Text"><span class="f_Text">It calls the built-in </span><span class="f_Text" style="font-style: italic;">CopyRates</span><span class="f_Text"> function through which the </span><span class="f_Text" style="font-style: italic;">rates</span><span class="f_Text"> bars array is filled. Then the bars are transferred to the </span><span class="f_Text" style="font-style: italic;">ratesDB </span><span class="f_Text">array so that using just one statement </span><span class="f_Text" style="font-style: italic;">db.insert(ratesDB)</span><span class="f_Text"> we could write information to the database (we have formalized in </span><span class="f_Text" style="font-style: italic;">MqlRatesDB</span><span class="f_Text"> how to do it correctly).</span></p>
<p class="p_Text"><span class="f_Text">The presence of the </span><span class="f_Text" style="font-style: italic;">DBTransaction</span><span class="f_Text"> object (with the automatic &quot;commit&quot; option enabled) inside the block means that all operations with the array are &quot;overlaid&quot; with a transaction. To indicate progress, during the processing of each block of bars, the label of the first bar is displayed in the log.</span></p>
<p class="p_Text"><span class="f_Text">While the function </span><span class="f_Text" style="font-style: italic;">CopyRates</span><span class="f_Text"> returns the data and their insertion into the database is successful, the loop in </span><span class="f_Text" style="font-style: italic;">OnStart</span><span class="f_Text"> continues with the shift of the numbers of the copied bars deep into the history. When the end of the available history or the bar limit set in the terminal settings is reached, </span><span class="f_Text" style="font-style: italic;">CopyRates</span><span class="f_Text"> will return error 4401 (HISTORY_NOT_FOUND) and the script will exit.</span></p>
<p class="p_Text"><span class="f_Text">Let's run the script on the EURUSD, H1 chart. The log should show something like this.</span></p>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; page-break-after: avoid; border-color: #d8dfea; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExample" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;db.isOpen()=true&nbsp;/&nbsp;ok</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;db.deleteTable(typename(MqlRatesDB))=true&nbsp;/&nbsp;ok</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;db.createTable&lt;MqlRatesDB&gt;(true)=true&nbsp;/&nbsp;ok</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;2022.06.29&nbsp;20:00:00</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;2022.05.03&nbsp;04:00:00</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;2022.03.04&nbsp;10:00:00</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;...</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;CopyRates&nbsp;failed:&nbsp;4401&nbsp;HISTORY_NOT_FOUND</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;Records&nbsp;added:&nbsp;100000</span></p>
</td>
</tr>
</table>
</div>
<p class="p_Text"><span class="f_Text">We now have the base </span><span class="f_Text" style="font-style: italic;">QuotesEURUSDH1.sqlite</span><span class="f_Text">, on which you can experiment to test various trading hypotheses. You can open it in the MetaEditor to make sure that the data is transferred correctly.</span></p>
<p class="p_Text"><span class="f_Text">Let's check one of the simplest strategies based on regularities in history. We will find the statistics of two consecutive bars in the same direction, broken down by intraday time and day of the week. If there is a tangible advantage for some combination of time and day of the week, it can be considered in the future as a signal to enter the market in the direction of the first bar.</span></p>
<p class="p_Text"><span class="f_Text">First, let's design an SQL query that requests quotes for a certain period and calculates the price movement on each bar, that is, the difference between adjacent opening prices.</span></p>
<p class="p_Text"><span class="f_Text">Since the time for bars is stored as a number of seconds (by the standards of </span><span class="f_Text" style="font-style: italic;">datetime</span><span class="f_Text"> in MQL5 and, concurrently, the &quot;Unix epoch&quot; of SQL), it is desirable to convert their display to a string for easy reading, so let's start the SELECT query from the </span><span class="f_Text" style="font-style: italic;">datetime</span><span class="f_Text"> field based on DATETIME function:</span></p>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; page-break-after: avoid; border-color: #d8dfea; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExample" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExample">SELECT</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;DATETIME(time,&nbsp;'unixepoch')&nbsp;as&nbsp;datetime,&nbsp;open,&nbsp;...</span></p>
</td>
</tr>
</table>
</div>
<p class="p_Text"><span class="f_Text">This field will not participate in the analysis and is given here only for the user. After that, the price is displayed for reference, so that we can check the calculation of price increments by debug printing.</span></p>
<p class="p_Text"><span class="f_Text">Since we are going to, if necessary, select a certain period from the entire file, the condition will require the </span><span class="f_Text" style="font-style: italic;">time</span><span class="f_Text"> field in &quot;a pure form&quot;, and it should also be added to the request. In addition, according to the planned analysis of quotes, we will need to isolate from the bar label its intraday time, as well as the day of the week (their numbering corresponds to that adopted in MQL5, 0 is Sunday). Let's call the last two columns of the query </span><span class="f_Text" style="font-style: italic;">intraday</span><span class="f_Text"> and </span><span class="f_Text" style="font-style: italic;">day</span><span class="f_Text">, respectively, and the TIME and STRFTIME functions are used to get them.</span></p>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; page-break-after: avoid; border-color: #d8dfea; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExample" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExample">SELECT</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;DATETIME(time,&nbsp;'unixepoch')&nbsp;as&nbsp;datetime,&nbsp;open,</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;time,</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;TIME(time,&nbsp;'unixepoch')&nbsp;AS&nbsp;intraday,</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;STRFTIME('%w',&nbsp;time,&nbsp;'unixepoch')&nbsp;AS&nbsp;day,&nbsp;...</span></p>
</td>
</tr>
</table>
</div>
<p class="p_Text"><span class="f_Text">To calculate the price increment in SQL, you can use the LAG function. It returns the value of the specified column with an offset of the specified number of rows. For example, </span><span class="f_Text" style="font-style: italic;">LAG(X, 1)</span><span class="f_Text"> means getting the </span><span class="f_Text" style="font-style: italic;">X</span><span class="f_Text"> value in the previous entry, with the second parameter 1 that means the offset defaulting to 1, i.e. it can be omitted to get the equivalent entry </span><span class="f_Text" style="font-style: italic;">LAG(X)</span><span class="f_Text">. To get the value of the next entry, call </span><span class="f_Text" style="font-style: italic;">LAG(X,-1)</span><span class="f_Text">. In any case, when using LAG, an additional syntactic construction is required that specifies the sorting order of records, in the simplest case, in the form of </span><span class="f_Text" style="font-style: italic;">OVER(ORDER BY column)</span><span class="f_Text">.</span></p>
<p class="p_Text"><span class="f_Text">Thus, to get the price increment between the opening prices of two neighboring bars, we write:</span></p>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; page-break-after: avoid; border-color: #d8dfea; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExample" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;...</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;(LAG(open,-1)&nbsp;OVER&nbsp;(ORDER&nbsp;BY&nbsp;time)&nbsp;-&nbsp;open)&nbsp;AS&nbsp;delta,&nbsp;...</span></p>
</td>
</tr>
</table>
</div>
<p class="p_Text"><span class="f_Text">This column is predictive because it looks into the future.</span></p>
<p class="p_Text"><span class="f_Text">We can reveal that two bars formed in the same direction by multiplying increments by them: positive values indicate a consistent rise or fall:</span></p>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; page-break-after: avoid; border-color: #d8dfea; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;&nbsp;&nbsp;...</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;&nbsp;&nbsp;(LAG(open,-1)&nbsp;OVER&nbsp;(ORDER&nbsp;BY&nbsp;time)&nbsp;-&nbsp;open)&nbsp;*&nbsp;(open&nbsp;-&nbsp;LAG(open)&nbsp;OVER&nbsp;(ORDER&nbsp;BY&nbsp;time))</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AS&nbsp;product,&nbsp;...</span></p>
</td>
</tr>
</table>
</div>
<p class="p_Text"><span class="f_Text">This indicator is chosen as the simplest to use in calculation: for real trading systems, you can choose a more complex criterion.</span></p>
<p class="p_Text"><span class="f_Text">To evaluate the profit generated by the system on the backtest, you need to multiply the direction of the previous bar (which acts as an indicator of future movement) by the price increment on the next bar. The direction is calculated in the column </span><span class="f_Text" style="font-style: italic;">direction</span><span class="f_Text"> (using the SIGN function), for reference only. The profit estimate in the </span><span class="f_Text" style="font-style: italic;">estimate</span><span class="f_Text"> column is the product of the previous movement </span><span class="f_Text" style="font-style: italic;">direction</span><span class="f_Text"> and the increment of the next bar (</span><span class="f_Text" style="font-style: italic;">delta</span><span class="f_Text">): if the direction is preserved, we get a positive result (in points).</span></p>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; page-break-after: avoid; border-color: #d8dfea; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;&nbsp;&nbsp;...</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;&nbsp;&nbsp;SIGN(open&nbsp;-&nbsp;LAG(open)&nbsp;OVER&nbsp;(ORDER&nbsp;BY&nbsp;time))&nbsp;AS&nbsp;direction,</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;&nbsp;&nbsp;(LAG(open,-1)&nbsp;OVER&nbsp;(ORDER&nbsp;BY&nbsp;time)&nbsp;-&nbsp;open)&nbsp;*&nbsp;SIGN(open&nbsp;-&nbsp;LAG(open)&nbsp;OVER&nbsp;(ORDER&nbsp;BY&nbsp;time))</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AS&nbsp;estimate&nbsp;...</span></p>
</td>
</tr>
</table>
</div>
<p class="p_Quote"><span class="f_Quote">In expressions in an SQL command, you cannot use AS aliases defined in the same command. That is why we cannot determine </span><span class="f_Quote" style="font-style: italic;">estimate</span><span class="f_Quote"> as </span><span class="f_Quote" style="font-style: italic;">delta * direction</span><span class="f_Quote">, and we have to repeat the calculation of the product explicitly. However, we recall that columns </span><span class="f_Quote" style="font-style: italic;">delta</span><span class="f_Quote"> and </span><span class="f_Quote" style="font-style: italic;">direction</span><span class="f_Quote"> are not needed for programmatic analysis and are added here only to visualize the table in front of the user.</span></p>
<p class="p_Text"><span class="f_Text">At the end of the SQL command, we specify the table from which the selection is made, and the filtering conditions for the backtest date range: two parameters &quot;from&quot; and &quot;to&quot;.</span></p>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; page-break-after: avoid; border-color: #d8dfea; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExample" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExample">...</span>
<br><span class="f_CodeExample">FROM&nbsp;MqlRatesDB</span>
<br><span class="f_CodeExample">WHERE&nbsp;(time&nbsp;&gt;=&nbsp;?1&nbsp;AND&nbsp;time&nbsp;&lt;&nbsp;?2)</span></p>
</td>
</tr>
</table>
</div>
<p class="p_Text"><span class="f_Text">Optionally, we can add a constraint </span><span class="f_Text" style="font-style: italic;">LIMIT?3</span><span class="f_Text"> (and enter some small value, for example, 10) so that visual verification of the query results at first does not force you to look through tens of thousands of records.</span></p>
<p class="p_Text"><span class="f_Text">You can check the operation of the SQL command using the </span><span class="f_Text" style="font-style: italic;">DatabasePrint</span><span class="f_Text"> function, however, the function, unfortunately, does not allow you to work with prepared queries with parameters. Therefore, we will have to replace SQL parameter preparation '?n' with query string formatting using </span><span class="f_Text" style="font-style: italic;">StringFormat</span><span class="f_Text"> and substitute parameter values there. Alternatively, it would be possible to completely avoid </span><span class="f_Text" style="font-style: italic;">DatabasePrint</span><span class="f_Text"> and output the results to the log independently, line by line (through an array </span><span class="f_Text" style="font-style: italic;">DBRow</span><span class="f_Text">).</span></p>
<p class="p_Text"><span class="f_Text">Thus, the final fragment of the request will turn into:</span></p>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; page-break-after: avoid; border-color: #d8dfea; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExample" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;...</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;WHERE&nbsp;(time&nbsp;&gt;=&nbsp;%ld&nbsp;AND&nbsp;time&nbsp;&lt;&nbsp;%ld)</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;ORDER&nbsp;BY&nbsp;time&nbsp;LIMIT&nbsp;%d;</span></p>
</td>
</tr>
</table>
</div>
<p class="p_Text"><span class="f_Text">It should be noted that the </span><span class="f_Text" style="font-style: italic;">datetime</span><span class="f_Text"> values in this query will be coming from MQL5 in the &quot;machine&quot; format, i.e., the number of seconds since the beginning of 1970. If we want to debug the same SQL query in the MetaEditor, then it is more convenient to write the date range condition using date literals (strings), as follows:</span></p>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; page-break-after: avoid; border-color: #d8dfea; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExample" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;WHERE&nbsp;(time&nbsp;&gt;=&nbsp;STRFTIME('%s',&nbsp;'2015-01-01')&nbsp;AND&nbsp;time&nbsp;&lt;&nbsp;STRFTIME('%s',&nbsp;'2021-01-01'))</span></p>
</td>
</tr>
</table>
</div>
<p class="p_Text"><span class="f_Text">Again, we need to use the STRFTIME function here (the '%s' modifier in SQL sets the transfer of the specified date string to the &quot;Unix epoch&quot; label; the fact that '%s' resembles an MQL5 format string is just a coincidence).</span></p>
<p class="p_Text"><span class="f_Text">Save the designed SQL query in a separate text file </span><span class="f_Text" style="font-style: italic;">DBQuotesIntradayLag.sql</span><span class="f_Text"> and connect it as a resource to the test script of the same name, </span><span class="f_Text" style="font-style: italic;">DBQuotesIntradayLag.mq5</span><span class="f_Text">.</span></p>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; page-break-after: avoid; border-color: #d8dfea; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExample" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExample" style="color: #0000ff;">#resource</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #008080;">&quot;DBQuotesIntradayLag.sql&quot;</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">as</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">string</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">sql1</span></p>
</td>
</tr>
</table>
</div>
<p class="p_Text"><span class="f_Text">The first parameter of the script allows you to set a prefix in the name of the database, which should already exist after launching </span><span class="f_Text" style="font-style: italic;">DBquotesImport.mq5</span><span class="f_Text"> on the chart with the same symbol and timeframe. The subsequent inputs are for the date range and length limit of the debug printout to the log.</span></p>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; page-break-after: avoid; border-color: #d8dfea; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExample" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExample" style="color: #0000ff;">input</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">string</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">Database</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #008080;">&quot;MQL5Book/DB/Quotes&quot;</span><span class="f_CodeExample">;</span>
<br><span class="f_CodeExample" style="color: #0000ff;">input</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">datetime</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">SubsetStart</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #333333;">D</span><span class="f_CodeExample">'</span><span class="f_CodeExample" style="color: #333333;">2022</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">01</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">01</span><span class="f_CodeExample">';</span>
<br><span class="f_CodeExample" style="color: #0000ff;">input</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">datetime</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">SubsetStop</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #333333;">D</span><span class="f_CodeExample">'</span><span class="f_CodeExample" style="color: #333333;">2023</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">01</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">01</span><span class="f_CodeExample">';</span>
<br><span class="f_CodeExample" style="color: #0000ff;">input</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">int</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">Limit</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #333333;">10</span><span class="f_CodeExample">;</span></p>
</td>
</tr>
</table>
</div>
<p class="p_Text"><span class="f_Text">The table with quotes is known in advance, from the previous script.</span></p>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; page-break-after: avoid; border-color: #d8dfea; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExample" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExample" style="color: #0000ff;">const</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">string</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">Table</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #008080;">&quot;MqlRatesDB&quot;</span><span class="f_CodeExample">;</span></p>
</td>
</tr>
</table>
</div>
<p class="p_Text"><span class="f_Text">In the </span><span class="f_Text" style="font-style: italic;">OnStart</span><span class="f_Text"> function, we open the database and make sure that the quotes table is available.</span></p>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; page-break-after: avoid; border-color: #d8dfea; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExample" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExample" style="color: #0000ff;">void</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">OnStart</span><span class="f_CodeExample">()</span>
<br><span class="f_CodeExample">{</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">Print</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #008080;">&quot;&quot;</span><span class="f_CodeExample">);</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">DBSQLite</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">db</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">Database</span><span class="f_CodeExample">&nbsp;+&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">_Symbol</span><span class="f_CodeExample">&nbsp;+&nbsp;</span><span class="f_CodeExample" style="color: #333333;">PeriodToString</span><span class="f_CodeExample">());</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">if</span><span class="f_CodeExample">(!</span><span class="f_CodeExample" style="color: #ff0000;">PRTF</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">db</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">isOpen</span><span class="f_CodeExample">()))&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">return</span><span class="f_CodeExample">;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">if</span><span class="f_CodeExample">(!</span><span class="f_CodeExample" style="color: #ff0000;">PRTF</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">db</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">hasTable</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">Table</span><span class="f_CodeExample">)))&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">return</span><span class="f_CodeExample">;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;...</span></p>
</td>
</tr>
</table>
</div>
<p class="p_Text"><span class="f_Text">Next, we substitute the parameters in the SQL query string. We pay attention not only to the substitution of SQL parameters '?n' for format sequences but also double the percent symbols '%' first because otherwise the function </span><span class="f_Text" style="font-style: italic;">StringFormat</span><span class="f_Text"> will perceive them as its own commands, and will not miss them in SQL.</span></p>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; page-break-after: avoid; border-color: #d8dfea; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExample" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">string</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">sqlrep</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #333333;">sql1</span><span class="f_CodeExample">;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">StringReplace</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">sqlrep</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #008080;">&quot;%&quot;</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #008080;">&quot;%%&quot;</span><span class="f_CodeExample">);</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">StringReplace</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">sqlrep</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #008080;">&quot;?1&quot;</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #008080;">&quot;%ld&quot;</span><span class="f_CodeExample">);</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">StringReplace</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">sqlrep</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #008080;">&quot;?2&quot;</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #008080;">&quot;%ld&quot;</span><span class="f_CodeExample">);</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">StringReplace</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">sqlrep</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #008080;">&quot;?3&quot;</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #008080;">&quot;%d&quot;</span><span class="f_CodeExample">);</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">const</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">string</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">sqlfmt</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">StringFormat</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">sqlrep</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">SubsetStart</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">SubsetStop</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">Limit</span><span class="f_CodeExample">);</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">Print</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">sqlfmt</span><span class="f_CodeExample">);</span></p>
</td>
</tr>
</table>
</div>
<p class="p_Text"><span class="f_Text">All these manipulations were required only to execute the request in the context of the </span><span class="f_Text" style="font-style: italic;">DatabasePrint</span><span class="f_Text"> function. In the working version of the analytical script, we would read the results of the query and analyze them programmatically, bypassing formatting and calling </span><span class="f_Text" style="font-style: italic;">DatabasePrint</span><span class="f_Text">.</span></p>
<p class="p_Text"><span class="f_Text">Finally, let's execute the SQL query and output the table with the results to the log.</span></p>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; page-break-after: avoid; border-color: #d8dfea; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExample" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">DatabasePrint</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">db</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">getHandle</span><span class="f_CodeExample">(),&nbsp;</span><span class="f_CodeExample" style="color: #333333;">sqlfmt</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">0</span><span class="f_CodeExample">);</span>
<br><span class="f_CodeExample">}</span></p>
</td>
</tr>
</table>
</div>
<p class="p_Text"><span class="f_Text">Here is what we will see for 10 bars EURUSD,H1 at the beginning of 2022.</span></p>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; page-break-after: avoid; border-color: #d8dfea; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">db.isOpen()=true&nbsp;/&nbsp;ok</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">db.hasTable(Table)=true&nbsp;/&nbsp;ok</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SELECT</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DATETIME(time,&nbsp;'unixepoch')&nbsp;as&nbsp;datetime,</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;open,</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;time,</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TIME(time,&nbsp;'unixepoch')&nbsp;AS&nbsp;intraday,</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;STRFTIME('%w',&nbsp;time,&nbsp;'unixepoch')&nbsp;AS&nbsp;day,</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(LAG(open,-1)&nbsp;OVER&nbsp;(ORDER&nbsp;BY&nbsp;time)&nbsp;-&nbsp;open)&nbsp;AS&nbsp;delta,</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SIGN(open&nbsp;-&nbsp;LAG(open)&nbsp;OVER&nbsp;(ORDER&nbsp;BY&nbsp;time))&nbsp;AS&nbsp;direction,</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(LAG(open,-1)&nbsp;OVER&nbsp;(ORDER&nbsp;BY&nbsp;time)&nbsp;-&nbsp;open)&nbsp;*&nbsp;(open&nbsp;-&nbsp;LAG(open)&nbsp;OVER&nbsp;(ORDER&nbsp;BY&nbsp;time))</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AS&nbsp;product,</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(LAG(open,-1)&nbsp;OVER&nbsp;(ORDER&nbsp;BY&nbsp;time)&nbsp;-&nbsp;open)&nbsp;*&nbsp;SIGN(open&nbsp;-&nbsp;LAG(open)&nbsp;OVER&nbsp;(ORDER&nbsp;BY&nbsp;time))</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AS&nbsp;estimate</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FROM&nbsp;MqlRatesDB</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WHERE&nbsp;(time&nbsp;&gt;=&nbsp;1640995200&nbsp;AND&nbsp;time&nbsp;&lt;&nbsp;1672531200)</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ORDER&nbsp;BY&nbsp;time&nbsp;LIMIT&nbsp;10;</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;#|&nbsp;datetime&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;open&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;time&nbsp;intraday&nbsp;day&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;delta&nbsp;dir&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;product&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;estimate</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">--+------------------------------------------------------------------------------------------------</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;1|&nbsp;2022-01-03&nbsp;00:00:00&nbsp;1.13693&nbsp;1641168000&nbsp;00:00:00&nbsp;1&nbsp;&nbsp;0.0003200098&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;2|&nbsp;2022-01-03&nbsp;01:00:00&nbsp;1.13725&nbsp;1641171600&nbsp;01:00:00&nbsp;1&nbsp;&nbsp;2.999999e-05&nbsp;&nbsp;1&nbsp;&nbsp;9.5999478e-09&nbsp;&nbsp;2.999999e-05&nbsp;</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;3|&nbsp;2022-01-03&nbsp;02:00:00&nbsp;1.13728&nbsp;1641175200&nbsp;02:00:00&nbsp;1&nbsp;&nbsp;-0.001060006&nbsp;&nbsp;1&nbsp;-3.1799748e-08&nbsp;&nbsp;-0.001060006&nbsp;</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;4|&nbsp;2022-01-03&nbsp;03:00:00&nbsp;1.13622&nbsp;1641178800&nbsp;03:00:00&nbsp;1&nbsp;-0.0003400007&nbsp;-1&nbsp;&nbsp;3.6040028e-07&nbsp;&nbsp;0.0003400007&nbsp;</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;5|&nbsp;2022-01-03&nbsp;04:00:00&nbsp;1.13588&nbsp;1641182400&nbsp;04:00:00&nbsp;1&nbsp;&nbsp;-0.001579991&nbsp;-1&nbsp;&nbsp;5.3719982e-07&nbsp;&nbsp;&nbsp;0.001579991&nbsp;</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;6|&nbsp;2022-01-03&nbsp;05:00:00&nbsp;&nbsp;1.1343&nbsp;1641186000&nbsp;05:00:00&nbsp;1&nbsp;&nbsp;0.0005299919&nbsp;-1&nbsp;-8.3739827e-07&nbsp;-0.0005299919&nbsp;</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;7|&nbsp;2022-01-03&nbsp;06:00:00&nbsp;1.13483&nbsp;1641189600&nbsp;06:00:00&nbsp;1&nbsp;-0.0007699937&nbsp;&nbsp;1&nbsp;-4.0809905e-07&nbsp;-0.0007699937&nbsp;</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;8|&nbsp;2022-01-03&nbsp;07:00:00&nbsp;1.13406&nbsp;1641193200&nbsp;07:00:00&nbsp;1&nbsp;-0.0002600149&nbsp;-1&nbsp;&nbsp;2.0020098e-07&nbsp;&nbsp;0.0002600149&nbsp;</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;9|&nbsp;2022-01-03&nbsp;08:00:00&nbsp;&nbsp;1.1338&nbsp;1641196800&nbsp;08:00:00&nbsp;1&nbsp;&nbsp;&nbsp;0.000510001&nbsp;-1&nbsp;-1.3260079e-07&nbsp;&nbsp;-0.000510001&nbsp;</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">10|&nbsp;2022-01-03&nbsp;09:00:00&nbsp;1.13431&nbsp;1641200400&nbsp;09:00:00&nbsp;1&nbsp;&nbsp;0.0004800036&nbsp;&nbsp;1&nbsp;&nbsp;2.4480023e-07&nbsp;&nbsp;0.0004800036&nbsp;</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">...</span></p>
</td>
</tr>
</table>
</div>
<p class="p_Text"><span class="f_Text">It is easy to make sure that the intraday time of the bar is correctly allocated, as well as the day of the week - 1, which corresponds to Monday. You can also check the delta increment. The </span><span class="f_Text" style="font-style: italic;">product</span><span class="f_Text"> and </span><span class="f_Text" style="font-style: italic;">estimate</span><span class="f_Text"> values are empty on the first row because they require the missing previous row to be calculated.</span></p>
<p class="p_Text"><span class="f_Text">Let's complicate our SQL query by grouping records with the same time of day combinations (</span><span class="f_Text" style="font-style: italic;">intraday</span><span class="f_Text">) and day of the week (</span><span class="f_Text" style="font-style: italic;">day</span><span class="f_Text">), and calculating a certain target indicator that characterizes the success of trading for each of these combinations. Let's take as such an indicator the average cell size </span><span class="f_Text" style="font-style: italic;">product </span><span class="f_Text">divided by the standard deviation of the same products. The larger the average product of price increments of neighboring bars, the greater the expected profit, and the smaller the spread of these products, the more stable the forecast. The name of the indicator in the SQL query is </span><span class="f_Text" style="font-style: italic;">objective</span><span class="f_Text">.</span></p>
<p class="p_Text"><span class="f_Text">In addition to the target indicator, we will also calculate the profit estimate (</span><span class="f_Text" style="font-style: italic;">backtest_profit</span><span class="f_Text">) and profit factor (</span><span class="f_Text" style="font-style: italic;">backtest_PF</span><span class="f_Text">). We will estimate profit as the sum of price increments (</span><span class="f_Text" style="font-style: italic;">estimate</span><span class="f_Text">) for all bars in the context of intraday time and day of the week (the size of the opening bar as a price increment is an analog of the future profit in points per one bar). The profit factor is traditionally the quotient of positive and negative increments.</span></p>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; page-break-after: avoid; border-color: #d8dfea; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;&nbsp;&nbsp;SELECT</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AVG(product)&nbsp;/&nbsp;STDDEV(product)&nbsp;AS&nbsp;objective,</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SUM(estimate)&nbsp;AS&nbsp;backtest_profit,</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SUM(CASE&nbsp;WHEN&nbsp;estimate&nbsp;&gt;=&nbsp;0&nbsp;THEN&nbsp;estimate&nbsp;ELSE&nbsp;0&nbsp;END)&nbsp;/</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SUM(CASE&nbsp;WHEN&nbsp;estimate&nbsp;&lt;&nbsp;0&nbsp;THEN&nbsp;-estimate&nbsp;ELSE&nbsp;0&nbsp;END)&nbsp;AS&nbsp;backtest_PF,</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;intraday,&nbsp;day</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;&nbsp;&nbsp;FROM</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;&nbsp;&nbsp;(</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SELECT</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;time,</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TIME(time,&nbsp;'unixepoch')&nbsp;AS&nbsp;intraday,</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;STRFTIME('%w',&nbsp;time,&nbsp;'unixepoch')&nbsp;AS&nbsp;day,</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(LAG(open,-1)&nbsp;OVER&nbsp;(ORDER&nbsp;BY&nbsp;time)&nbsp;-&nbsp;open)&nbsp;AS&nbsp;delta,</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SIGN(open&nbsp;-&nbsp;LAG(open)&nbsp;OVER&nbsp;(ORDER&nbsp;BY&nbsp;time))&nbsp;AS&nbsp;direction,</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(LAG(open,-1)&nbsp;OVER&nbsp;(ORDER&nbsp;BY&nbsp;time)&nbsp;-&nbsp;open)&nbsp;*&nbsp;(open&nbsp;-&nbsp;LAG(open)&nbsp;OVER&nbsp;(ORDER&nbsp;BY&nbsp;time))</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AS&nbsp;product,</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(LAG(open,-1)&nbsp;OVER&nbsp;(ORDER&nbsp;BY&nbsp;time)&nbsp;-&nbsp;open)&nbsp;*&nbsp;SIGN(open&nbsp;-&nbsp;LAG(open)&nbsp;OVER&nbsp;(ORDER&nbsp;BY&nbsp;time))</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AS&nbsp;estimate</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FROM&nbsp;MqlRatesDB</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WHERE&nbsp;(time&nbsp;&gt;=&nbsp;STRFTIME('%s',&nbsp;'2015-01-01')&nbsp;AND&nbsp;time&nbsp;&lt;&nbsp;STRFTIME('%s',&nbsp;'2021-01-01'))</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;&nbsp;&nbsp;)</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;&nbsp;&nbsp;GROUP&nbsp;BY&nbsp;intraday,&nbsp;day</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;&nbsp;&nbsp;ORDER&nbsp;BY&nbsp;objective&nbsp;DESC</span></p>
</td>
</tr>
</table>
</div>
<p class="p_Text"><span class="f_Text">The first SQL query has become nested, from which we now accumulate data with an external SQL query. Grouping by all combinations of time and day of the week provides an &quot;extra&quot; from </span><span class="f_Text" style="font-style: italic;">GROUP BY intraday, day</span><span class="f_Text">. In addition, we have added sorting by target indicator (</span><span class="f_Text" style="font-style: italic;">ORDER BY objective DESC</span><span class="f_Text">) so that the best options are at the top of the table.</span></p>
<p class="p_Text"><span class="f_Text">In the nested query, we removed the LIMIT parameter, because the number of groups became acceptable, much less than the number of analyzed bars. So, for H1 we get 120 options (24 * 5).</span></p>
<p class="p_Text"><span class="f_Text">The extended query is placed in the text file </span><span class="f_Text" style="font-style: italic;">DBQuotesIntradayLagGroup.sql</span><span class="f_Text">, which in turn is connected as a resource to the test script of the same name, </span><span class="f_Text" style="font-style: italic;">DBQuotesIntradayLagGroup.mq5</span><span class="f_Text">. Its source code differs little from the previous one, so we will immediately show the result of its launch for the default date range: from the beginning of 2015 to the beginning of 2021 (excluding 2021 and 2022).</span></p>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; page-break-after: avoid; border-color: #d8dfea; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">db.isOpen()=true&nbsp;/&nbsp;ok</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">db.hasTable(Table)=true&nbsp;/&nbsp;ok</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;&nbsp;&nbsp;SELECT</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AVG(product)&nbsp;/&nbsp;STDDEV(product)&nbsp;AS&nbsp;objective,</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SUM(estimate)&nbsp;AS&nbsp;backtest_profit,</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SUM(CASE&nbsp;WHEN&nbsp;estimate&nbsp;&gt;=&nbsp;0&nbsp;THEN&nbsp;estimate&nbsp;ELSE&nbsp;0&nbsp;END)&nbsp;/</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SUM(CASE&nbsp;WHEN&nbsp;estimate&nbsp;&lt;&nbsp;0&nbsp;THEN&nbsp;-estimate&nbsp;ELSE&nbsp;0&nbsp;END)&nbsp;AS&nbsp;backtest_PF,</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;intraday,&nbsp;day</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;&nbsp;&nbsp;FROM</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;&nbsp;&nbsp;(</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SELECT</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FROM&nbsp;MqlRatesDB</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WHERE&nbsp;(time&nbsp;&gt;=&nbsp;1420070400&nbsp;AND&nbsp;time&nbsp;&lt;&nbsp;1609459200)</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;&nbsp;&nbsp;)</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;&nbsp;&nbsp;GROUP&nbsp;BY&nbsp;intraday,&nbsp;day</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;&nbsp;&nbsp;ORDER&nbsp;BY&nbsp;objective&nbsp;DESC</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;&nbsp;#|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;objective&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;backtest_profit&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;backtest_PF&nbsp;intraday&nbsp;day</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">---+---------------------------------------------------------------------------</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;&nbsp;1|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0.16713214428916&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0.073200000000001&nbsp;&nbsp;1.46040631486258&nbsp;16:00:00&nbsp;5&nbsp;&nbsp;&nbsp;</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;&nbsp;2|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0.118128291843983&nbsp;&nbsp;&nbsp;&nbsp;0.0433099999999995&nbsp;&nbsp;1.33678071539657&nbsp;20:00:00&nbsp;3&nbsp;&nbsp;&nbsp;</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;&nbsp;3|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0.103701251751617&nbsp;&nbsp;&nbsp;0.00929999999999853&nbsp;&nbsp;1.14148790506616&nbsp;05:00:00&nbsp;2&nbsp;&nbsp;&nbsp;</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;&nbsp;4|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0.102930330078208&nbsp;&nbsp;&nbsp;&nbsp;0.0164399999999973&nbsp;&nbsp;&nbsp;1.1932071923845&nbsp;08:00:00&nbsp;4&nbsp;&nbsp;&nbsp;</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;&nbsp;5|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0.089531492651001&nbsp;&nbsp;&nbsp;&nbsp;0.0064300000000006&nbsp;&nbsp;1.10167615433271&nbsp;07:00:00&nbsp;2&nbsp;&nbsp;&nbsp;</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;&nbsp;6|&nbsp;&nbsp;&nbsp;&nbsp;0.0827628326995007&nbsp;-8.99999999970369e-05&nbsp;0.999601152226913&nbsp;17:00:00&nbsp;4&nbsp;&nbsp;&nbsp;</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;&nbsp;7|&nbsp;&nbsp;&nbsp;&nbsp;0.0823433025146974&nbsp;&nbsp;&nbsp;&nbsp;0.0159700000000012&nbsp;&nbsp;1.21665988332657&nbsp;21:00:00&nbsp;1&nbsp;&nbsp;&nbsp;</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;&nbsp;8|&nbsp;&nbsp;&nbsp;&nbsp;0.0767938336191962&nbsp;&nbsp;&nbsp;0.00522999999999874&nbsp;&nbsp;1.04226945769012&nbsp;13:00:00&nbsp;1&nbsp;&nbsp;&nbsp;</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;&nbsp;9|&nbsp;&nbsp;&nbsp;&nbsp;0.0657741522256548&nbsp;&nbsp;&nbsp;&nbsp;0.0162299999999986&nbsp;&nbsp;1.09699976093712&nbsp;15:00:00&nbsp;2&nbsp;&nbsp;&nbsp;</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;10|&nbsp;&nbsp;&nbsp;&nbsp;0.0635243373432768&nbsp;&nbsp;&nbsp;0.00932000000000044&nbsp;&nbsp;1.08294766820933&nbsp;22:00:00&nbsp;3</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">...&nbsp;&nbsp;&nbsp;</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">110|&nbsp;&nbsp;&nbsp;-0.0814131025461459&nbsp;&nbsp;&nbsp;-0.0189100000000015&nbsp;0.820605255668329&nbsp;21:00:00&nbsp;5&nbsp;&nbsp;&nbsp;</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">111|&nbsp;&nbsp;&nbsp;-0.0899571263478305&nbsp;&nbsp;&nbsp;-0.0321900000000028&nbsp;0.721250432975386&nbsp;22:00:00&nbsp;4&nbsp;&nbsp;&nbsp;</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">112|&nbsp;&nbsp;&nbsp;-0.0909772560603298&nbsp;&nbsp;&nbsp;-0.0226100000000016&nbsp;0.851161872161138&nbsp;19:00:00&nbsp;4&nbsp;&nbsp;&nbsp;</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">113|&nbsp;&nbsp;&nbsp;-0.0961794181717023&nbsp;&nbsp;-0.00846999999999931&nbsp;0.936377976414036&nbsp;12:00:00&nbsp;5&nbsp;&nbsp;&nbsp;</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">114|&nbsp;&nbsp;&nbsp;&nbsp;-0.108868074018582&nbsp;&nbsp;&nbsp;-0.0246099999999998&nbsp;0.634920634920637&nbsp;00:00:00&nbsp;5&nbsp;&nbsp;&nbsp;</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">115|&nbsp;&nbsp;&nbsp;&nbsp;-0.109368419185336&nbsp;&nbsp;&nbsp;-0.0250700000000013&nbsp;0.744496534855268&nbsp;08:00:00&nbsp;2&nbsp;&nbsp;&nbsp;</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">116|&nbsp;&nbsp;&nbsp;&nbsp;-0.121893581607986&nbsp;&nbsp;&nbsp;-0.0234599999999998&nbsp;0.610945273631843&nbsp;00:00:00&nbsp;3&nbsp;&nbsp;&nbsp;</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">117|&nbsp;&nbsp;&nbsp;&nbsp;-0.135416609546408&nbsp;&nbsp;&nbsp;-0.0898899999999971&nbsp;0.343437294573087&nbsp;00:00:00&nbsp;1&nbsp;&nbsp;&nbsp;</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">118|&nbsp;&nbsp;&nbsp;&nbsp;-0.142128458003631&nbsp;&nbsp;&nbsp;-0.0255200000000018&nbsp;0.681835182645536&nbsp;06:00:00&nbsp;4&nbsp;&nbsp;&nbsp;</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">119|&nbsp;&nbsp;&nbsp;&nbsp;-0.142196924506816&nbsp;&nbsp;&nbsp;-0.0205700000000004&nbsp;0.629769618430515&nbsp;00:00:00&nbsp;2&nbsp;&nbsp;&nbsp;</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">120|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-0.15200009633513&nbsp;&nbsp;&nbsp;-0.0301499999999988&nbsp;0.708864426419475&nbsp;02:00:00&nbsp;1&nbsp;&nbsp;&nbsp;</span></p>
</td>
</tr>
</table>
</div>
<p class="p_Text"><span class="f_Text">Thus, the analysis tells us that the 16-hour H1 bar on Friday is the best candidate to continue the trend based on the previous bar. Next in preference is the Wednesday 20 o'clock bar. And so on.</span></p>
<p class="p_Text"><span class="f_Text">However, it is desirable to check the found settings on the forward period.</span></p>
<p class="p_Text"><span class="f_Text">To do this, we can execute the current SQL query not only on the &quot;past&quot; date range (in our test until 2021) but once more in the &quot;future&quot; (from the beginning of 2021). The results of both queries should be joined (JOIN) by our groups (</span><span class="f_Text" style="font-style: italic;">intraday</span><span class="f_Text">, </span><span class="f_Text" style="font-style: italic;">day</span><span class="f_Text">). Then, while maintaining the sorting by the target indicator, we will see in the adjacent columns the profit and profit factor for the same combinations of time and day of the week, and how much they sank.</span></p>
<p class="p_Text"><span class="f_Text">Here's the final SQL query (abbreviated):</span></p>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; page-break-after: avoid; border-color: #d8dfea; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">SELECT&nbsp;*&nbsp;FROM</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">(</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;&nbsp;&nbsp;SELECT</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AVG(product)&nbsp;/&nbsp;STDDEV(product)&nbsp;AS&nbsp;objective,</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SUM(estimate)&nbsp;AS&nbsp;backtest_profit,</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SUM(CASE&nbsp;WHEN&nbsp;estimate&nbsp;&gt;=&nbsp;0&nbsp;THEN&nbsp;estimate&nbsp;ELSE&nbsp;0&nbsp;END)&nbsp;/&nbsp;</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SUM(CASE&nbsp;WHEN&nbsp;estimate&nbsp;&lt;&nbsp;0&nbsp;THEN&nbsp;-estimate&nbsp;ELSE&nbsp;0&nbsp;END)&nbsp;AS&nbsp;backtest_PF,</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;intraday,&nbsp;day</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;&nbsp;&nbsp;FROM</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;&nbsp;&nbsp;(</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SELECT&nbsp;...</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FROM&nbsp;MqlRatesDB</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WHERE&nbsp;(time&nbsp;&gt;=&nbsp;STRFTIME('%s',&nbsp;'2015-01-01')&nbsp;AND&nbsp;time&nbsp;&lt;&nbsp;STRFTIME('%s',&nbsp;'2021-01-01'))</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;&nbsp;&nbsp;)</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;&nbsp;&nbsp;GROUP&nbsp;BY&nbsp;intraday,&nbsp;day</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">)&nbsp;backtest</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">JOIN</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">(</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;&nbsp;&nbsp;SELECT</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SUM(estimate)&nbsp;AS&nbsp;forward_profit,</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SUM(CASE&nbsp;WHEN&nbsp;estimate&nbsp;&gt;=&nbsp;0&nbsp;THEN&nbsp;estimate&nbsp;ELSE&nbsp;0&nbsp;END)&nbsp;/</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SUM(CASE&nbsp;WHEN&nbsp;estimate&nbsp;&lt;&nbsp;0&nbsp;THEN&nbsp;-estimate&nbsp;ELSE&nbsp;0&nbsp;END)&nbsp;AS&nbsp;forward_PF,</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;intraday,&nbsp;day</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;&nbsp;&nbsp;FROM</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;&nbsp;&nbsp;(</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SELECT&nbsp;...</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FROM&nbsp;MqlRatesDB</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WHERE&nbsp;(time&nbsp;&gt;=&nbsp;STRFTIME('%s',&nbsp;'2021-01-01'))</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;&nbsp;&nbsp;)</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;&nbsp;&nbsp;GROUP&nbsp;BY&nbsp;intraday,&nbsp;day</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">)&nbsp;forward</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">USING(intraday,&nbsp;day)</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">ORDER&nbsp;BY&nbsp;objective&nbsp;DESC</span></p>
</td>
</tr>
</table>
</div>
<p class="p_Text"><span class="f_Text">The full text of the request is provided in the file </span><span class="f_Text" style="font-style: italic;">DBQuotesIntradayBackAndForward.sql</span><span class="f_Text">. It is connected as a resource in the script </span><span class="f_Text" style="font-style: italic;">DBQuotesIntradayBackAndForward.mq5</span><span class="f_Text">.</span></p>
<p class="p_Text"><span class="f_Text">By running the script with default settings, we get the following indicators (with abbreviations):</span></p>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; page-break-after: avoid; border-color: #d8dfea; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;#|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;objective&nbsp;&nbsp;&nbsp;&nbsp;backtest_profit&nbsp;&nbsp;&nbsp;&nbsp;backtest_PF&nbsp;intraday&nbsp;day&nbsp;forward_profit&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;forward_PF</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">--+------------------------------------------------------------------------------------------------</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;1|&nbsp;&nbsp;&nbsp;0.16713214428916&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0.073200000001&nbsp;&nbsp;1.46040631486&nbsp;16:00:00&nbsp;5&nbsp;&nbsp;&nbsp;0.004920000048&nbsp;&nbsp;1.12852664576&nbsp;</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;2|&nbsp;&nbsp;0.118128291843983&nbsp;&nbsp;&nbsp;&nbsp;0.0433099999995&nbsp;&nbsp;1.33678071539&nbsp;20:00:00&nbsp;3&nbsp;&nbsp;&nbsp;0.007880000055&nbsp;&nbsp;&nbsp;&nbsp;1.277856135&nbsp;</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;3|&nbsp;&nbsp;0.103701251751617&nbsp;&nbsp;&nbsp;0.00929999999853&nbsp;&nbsp;1.14148790506&nbsp;05:00:00&nbsp;2&nbsp;&nbsp;&nbsp;0.002210000082&nbsp;&nbsp;1.12149532710&nbsp;</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;4|&nbsp;&nbsp;0.102930330078208&nbsp;&nbsp;&nbsp;&nbsp;0.0164399999973&nbsp;&nbsp;&nbsp;1.1932071923&nbsp;08:00:00&nbsp;4&nbsp;&nbsp;&nbsp;0.001409999969&nbsp;&nbsp;1.07253086419&nbsp;</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;5|&nbsp;&nbsp;0.089531492651001&nbsp;&nbsp;&nbsp;&nbsp;0.0064300000006&nbsp;&nbsp;1.10167615433&nbsp;07:00:00&nbsp;2&nbsp;&nbsp;-0.009119999869&nbsp;0.561749159058&nbsp;</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;6|&nbsp;0.0827628326995007&nbsp;-8.99999999970e-05&nbsp;0.999601152226&nbsp;17:00:00&nbsp;4&nbsp;&nbsp;&nbsp;0.009070000091&nbsp;&nbsp;1.18809622563&nbsp;</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;7|&nbsp;0.0823433025146974&nbsp;&nbsp;&nbsp;&nbsp;0.0159700000012&nbsp;&nbsp;1.21665988332&nbsp;21:00:00&nbsp;1&nbsp;&nbsp;&nbsp;&nbsp;0.00250999999&nbsp;&nbsp;1.12131464475&nbsp;</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;8|&nbsp;0.0767938336191962&nbsp;&nbsp;&nbsp;0.00522999999874&nbsp;&nbsp;1.04226945769&nbsp;13:00:00&nbsp;1&nbsp;&nbsp;-0.008490000055&nbsp;0.753913043478&nbsp;</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">&nbsp;9|&nbsp;0.0657741522256548&nbsp;&nbsp;&nbsp;&nbsp;0.0162299999986&nbsp;&nbsp;1.09699976093&nbsp;15:00:00&nbsp;2&nbsp;&nbsp;&nbsp;&nbsp;0.01423999997&nbsp;&nbsp;1.34979120609&nbsp;</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">10|&nbsp;0.0635243373432768&nbsp;&nbsp;&nbsp;0.00932000000044&nbsp;&nbsp;1.08294766820&nbsp;22:00:00&nbsp;3&nbsp;&nbsp;&nbsp;-0.00456999993&nbsp;0.828967065868</span></p>
<p class="p_CodeExampleCondensed" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExampleCondensed">...&nbsp;</span></p>
</td>
</tr>
</table>
</div>
<p class="p_Text"><span class="f_Text">So, the trading system with the best trading schedules found continues to show profit in the &quot;future&quot; period, although not as large as on the backtest.</span></p>
<p class="p_Text"><span class="f_Text">Of course, the considered example is only a particular case of a trading system. We could, for example, find combinations of the time and day of the week when a reversal strategy works on neighboring bars, or based on other principles altogether (analysis of ticks, calendar, portfolio of trading signals, etc.).</span></p>
<p class="p_Text"><span class="f_Text">The bottom line is that the SQLite engine provides many convenient tools that would need to be implemented in MQL5 on your own. To tell the truth, learning SQL takes time. The platform allows you to choose the optimal combination of two technologies for efficient programming.</span></p>

</div>

</body>
</html>
