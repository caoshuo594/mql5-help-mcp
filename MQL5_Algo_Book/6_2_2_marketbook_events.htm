<!DOCTYPE html>
<html>
  <head>
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1" />
  <title>6.2. Receiving events about changes in the depth of market</title>
  <meta name="keywords" content="" />
  <link type="text/css" href="default.css" rel="stylesheet" />

   <script type="text/javascript" src="jquery.js"></script>
   <script type="text/javascript" src="helpman_settings.js"></script>
   <script type="text/javascript" src="helpman_topicinit.js"></script>


</head>

<body style="background-color:#FFFFFF; font-family:'Trebuchet MS',Tahoma,Arial,Helvetica,sans-serif; margin:0px;">



<table width="100%" height="49"  border="0" cellpadding="0" cellspacing="0" style="margin-top:0px; background-color:#1660af;">
  <tr>
    <td></td>
    <td valign="middle">
      <table style="margin-top:4px; margin-bottom:5px;" width="100%"  border="0" cellspacing="0" cellpadding="5">
        <tr valign="middle">
          <td class="nav">
<a class="h_m" href="index.htm">          MQL5 Programming for Traders </a> / <a class="h_m" href="part6.htm"> Part 6. Trading automation </a> / <a class="h_m" href="6_2_marketbook.htm"> 6.2 Depth of Market </a>/ 6.2.2 Receiving events about changes in the Depth of Market
          </td>
          <td width="70" align="right">
          <a href="6_2_1_marketbook_add_release.htm"><img style="vertical-align:middle;" src="previous.png" alt="?????" width="27" height="27" border=0></a>&nbsp;
          <a href="6_2_3_marketbook_get.htm"><img style="vertical-align:middle;" src="next.png" alt="??????" width="27" height="27" border="0"></a>
          </td>
        </tr>
      </table>
    </td>
    <td width="5"></td>
  </tr>
</table>



<div id="help">
<p class="p_H3"><span class="f_H3">6.2. Receiving events about changes in the Depth of Market</span></p>
<p class="p_Text"><span class="f_Text">The </span><span class="f_Text" style="font-style: italic;">OnBookEvent</span><span class="f_Text"> event is generated by the terminal when the order book status changes. The event is processed by the </span><span class="f_Text" style="font-style: italic;">OnBookEvent</span><span class="f_Text"> function defined in the source code. In order for the terminal to start sending </span><span class="f_Text" style="font-style: italic;">OnBookEvent</span><span class="f_Text"> notifications to the MQL program for a specific symbol, you must first subscribe to receive them using the </span><span class="f_Text" style="font-style: italic;"><a href="6_2_1_marketbook_add_release.htm" class="topiclink">MarketBookAdd</a></span><span class="f_Text"> function.</span></p>
<p class="p_Text"><span class="f_Text">To unsubscribe from receiving the </span><span class="f_Text" style="font-style: italic;">OnBookEvent</span><span class="f_Text"> event for a symbol, call the </span><span class="f_Text" style="font-style: italic;"><a href="6_2_1_marketbook_add_release.htm" class="topiclink">MarketBookRelease</a></span><span class="f_Text"> function.</span></p>
<p class="p_Text"><span class="f_Text">The </span><span class="f_Text" style="font-style: italic;">OnBookEvent</span><span class="f_Text"> event is broadcast, which means that it is enough for one MQL program on the chart to subscribe to </span><span class="f_Text" style="font-style: italic;">OnBookEvent</span><span class="f_Text"> events, and all other programs on the same chart will also start receiving the events provided they have the </span><span class="f_Text" style="font-style: italic;">OnBookEvent</span><span class="f_Text"> handler in the code. Therefore, it is necessary to analyze the name of the symbol, which is passed to the handler as a parameter.</span></p>
<p class="p_Text"><span class="f_Text">The </span><span class="f_Text" style="font-style: italic;">OnBookEvent</span><span class="f_Text"> handler prototype is as follows.</span></p>
<p class="p_H4"><span class="f_H4">void OnBookEvent(const string &amp;symbol)</span></p>
<p class="p_Text"><span class="f_Text" style="font-style: italic;">OnBookEvent</span><span class="f_Text"> events are queued even if the processing of the previous </span><span class="f_Text" style="font-style: italic;">OnBookEvent</span><span class="f_Text"> event has not yet been completed.</span></p>
<p class="p_Text"><span class="f_Text">It is important that the events </span><span class="f_Text" style="font-style: italic;">OnBookEvent</span><span class="f_Text"> are only notifications and do not provide the state of the order book. To get the Depth of Market data, call the </span><span class="f_Text" style="font-style: italic;"><a href="6_2_3_marketbook_get.htm" class="topiclink">MarketBookGet</a></span><span class="f_Text"> function.</span></p>
<p class="p_Text"><span class="f_Text">It should be noted, however, that the </span><span class="f_Text" style="font-style: italic;">MarketBookGet</span><span class="f_Text"> call, even if it is made directly from the </span><span class="f_Text" style="font-style: italic;">OnBookEvent</span><span class="f_Text"> handler, will receive the current state of the order book at the time when </span><span class="f_Text" style="font-style: italic;">MarketBookGet</span><span class="f_Text"> is called, which does not necessarily match the order book state that triggered sending of the event </span><span class="f_Text" style="font-style: italic;">OnBookEvent</span><span class="f_Text">. This can happen when a sequence of very fast order book changes arrives at the terminal.</span></p>
<p class="p_Text"><span class="f_Text">In this regard, in order to obtain the most complete chronology of Depth of Market changes, we need to write an implementation of </span><span class="f_Text" style="font-style: italic;">OnBookEvent</span><span class="f_Text"> and prioritize the optimization by the execution speed.</span></p>
<p class="p_Text"><span class="f_Text">At the same time, there is no guaranteed way to get all unique Depth of Market states in MQL5.</span></p>
<p class="p_Quote"><span class="f_Quote">If your program started receiving notifications successfully, and then they disappeared when the market was open (and ticks continue to come), this may indicate problems in the subscription. In particular, another MQL program which is poorly designed could unsubscribe more times than required. In such cases, it is recommended to resubscribe with a new </span><span class="f_Quote" style="font-style: italic;">MarketBookAdd</span><span class="f_Quote"> call after a predefined timeout (for example, several tens of seconds or a minute).</span></p>
<p class="p_Text"><span class="f_Text">An example of bufferless indicator </span><span class="f_Text" style="font-style: italic;">MarketBookEvent.mq5</span><span class="f_Text"> allows you to track the arrival of </span><span class="f_Text" style="font-style: italic;">OnBookEvent</span><span class="f_Text"> events and prints the symbol name and the current time (millisecond system counter) in a comment. For clarity, we use the multi-line comment function from the </span><span class="f_Text" style="font-style: italic;">Comments.mqh</span><span class="f_Text"> file, section <a href="4_8_3_output_comment.htm" class="topiclink">Displaying messages in the chart window</a>.</span></p>
<p class="p_Text"><span class="f_Text">Interestingly, if you leave the input parameter </span><span class="f_Text" style="font-style: italic;">WorkSymbol</span><span class="f_Text"> empty (default value), the indicator itself will not initiate a subscription to the order book but will be able to intercept messages requested by other MQL programs on the same chart. Let's check it.</span></p>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; page-break-after: avoid; border-color: #d8dfea; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExample" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExample" style="color: #0000ff;">#include</span><span class="f_CodeExample">&nbsp;&lt;</span><span class="f_CodeExample" style="color: #333333;">MQL5Book</span><span class="f_CodeExample">/</span><span class="f_CodeExample" style="color: #333333;">Comments</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">mqh</span><span class="f_CodeExample">&gt;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span>
<br><span class="f_CodeExample" style="color: #0000ff;">input</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">string</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">WorkSymbol</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #008080;">&quot;&quot;</span><span class="f_CodeExample">;&nbsp;</span><span class="f_CodeExample" style="color: #808080;">//&nbsp;WorkSymbol&nbsp;(if&nbsp;empty,&nbsp;intercept&nbsp;events&nbsp;initiated&nbsp;by&nbsp;others)</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span>
<br><span class="f_CodeExample" style="color: #0000ff;">void</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">OnInit</span><span class="f_CodeExample">()</span>
<br><span class="f_CodeExample">{</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">if</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #0000ff;">StringLen</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">WorkSymbol</span><span class="f_CodeExample">))</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;{</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #ff0000;">PRTF</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #0000ff;">MarketBookAdd</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">WorkSymbol</span><span class="f_CodeExample">));</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;}</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">else</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;{</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">Print</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #008080;">&quot;Start&nbsp;listening&nbsp;to&nbsp;OnBookEvent&nbsp;initiated&nbsp;by&nbsp;other&nbsp;programs&quot;</span><span class="f_CodeExample">);</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;}</span>
<br><span class="f_CodeExample">}</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span>
<br><span class="f_CodeExample" style="color: #0000ff;">void</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">OnBookEvent</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #0000ff;">const</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">string</span><span class="f_CodeExample">&nbsp;&amp;</span><span class="f_CodeExample" style="color: #0000ff;">symbol</span><span class="f_CodeExample">)</span>
<br><span class="f_CodeExample">{</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">ChronoComment</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #0000ff;">symbol</span><span class="f_CodeExample">&nbsp;+&nbsp;</span><span class="f_CodeExample" style="color: #008080;">&quot;&nbsp;&quot;</span><span class="f_CodeExample">&nbsp;+&nbsp;(</span><span class="f_CodeExample" style="color: #0000ff;">string</span><span class="f_CodeExample">)</span><span class="f_CodeExample" style="color: #0000ff;">GetTickCount</span><span class="f_CodeExample">());</span>
<br><span class="f_CodeExample">}</span>
<br><span class="f_CodeExample">&nbsp;</span>
<br><span class="f_CodeExample" style="color: #0000ff;">void</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">OnDeinit</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #0000ff;">const</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">int</span><span class="f_CodeExample">)</span>
<br><span class="f_CodeExample">{</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">Comment</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #008080;">&quot;&quot;</span><span class="f_CodeExample">);</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">if</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #0000ff;">StringLen</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">WorkSymbol</span><span class="f_CodeExample">))</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;{</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #ff0000;">PRTF</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #0000ff;">MarketBookRelease</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">WorkSymbol</span><span class="f_CodeExample">));</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;}</span>
<br><span class="f_CodeExample">}</span></p>
</td>
</tr>
</table>
</div>
<p class="p_Text"><span class="f_Text">Let's run </span><span class="f_Text" style="font-style: italic;">MarketBookEvent</span><span class="f_Text"> with default settings (no own subscription) and then add the </span><span class="f_Text" style="font-style: italic;">MarketBookAddRelease</span><span class="f_Text"> indicator from the previous section, and specify for it a list of several symbols with available order books (in the example below, this is &quot;XAUUSD,BTCUSD,USDCNH&quot;). It doesn't matter which chart to run the indicators on: it can be a completely different symbol, like EURUSD.</span></p>
<p class="p_Text"><span class="f_Text">Immediately after launching </span><span class="f_Text" style="font-style: italic;">MarketBookEvent</span><span class="f_Text">, the chart will be empty (no comments) because there are no subscriptions yet. Once </span><span class="f_Text" style="font-style: italic;">MarketBookAddRelease</span><span class="f_Text"> starts (three lines should appear in the log with the status of a successful subscription equal to </span><span class="f_Text" style="font-style: italic;">true</span><span class="f_Text">), the names of symbols will begin to appear in the comments alternately as their order books are updated (we have not yet learned how to read the order book; this will be discussed in the next section).</span></p>
<p class="p_Text"><span class="f_Text">Here's how it looks on the screen.</span></p>
<p class="p_ImageCaption"><img class="help" alt="Notifications about changing the order books of &quot;foreign&quot; symbols" title="Notifications about changing the order books of &quot;foreign&quot; symbols" width="600" height="400" style="margin:0 auto 0 auto;width:600px;height:400px;border:none" src="eurusdh1_marketbook.png"/><br>
<span class="f_ImageCaption">Notifications about changes in the order books of &quot;third-party&quot; symbols</span></p>
<p class="p_Text"><span class="f_Text">If we now remove the </span><span class="f_Text" style="font-style: italic;">MarketBookAddRelease</span><span class="f_Text"> indicator, it will cancel its subscriptions, and the comment will stop updating. Subsequent removal of </span><span class="f_Text" style="font-style: italic;">MarketBookEvent</span><span class="f_Text"> will clear the comment.</span></p>
<p class="p_Text"><span class="f_Text">Please note that some time (a second or two) passes between the request to unsubscribe and the moment when Depth of Market events actually stop updating the comment.</span></p>
<p class="p_Text"><span class="f_Text">You can run the </span><span class="f_Text" style="font-style: italic;">MarketBookEvent</span><span class="f_Text"> indicator alone on the chart, specifying some symbol in its </span><span class="f_Text" style="font-style: italic;">WorkSymbol</span><span class="f_Text"> parameter to make sure notifications work within the same app. </span><span class="f_Text" style="font-style: italic;">MarketBookAddRelease</span><span class="f_Text"> was previously used only to demonstrate the broadcast nature of notifications. In other words, enabling a subscription to order book changes in one program does affect the receipt of notifications in another.</span></p>

</div>

</body>
</html>
