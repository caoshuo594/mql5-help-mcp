<!DOCTYPE html>
<html>
  <head>
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1" />
  <title>7.8.5 Server component of web services based on the WebSocket protocol</title>
  <meta name="keywords" content="" />
  <link type="text/css" href="default.css" rel="stylesheet" />

   <script type="text/javascript" src="jquery.js"></script>
   <script type="text/javascript" src="helpman_settings.js"></script>
   <script type="text/javascript" src="helpman_topicinit.js"></script>


</head>

<body style="background-color:#FFFFFF; font-family:'Trebuchet MS',Tahoma,Arial,Helvetica,sans-serif; margin:0px;">



<table width="100%" height="49"  border="0" cellpadding="0" cellspacing="0" style="margin-top:0px; background-color:#1660af;">
  <tr>
    <td></td>
    <td valign="middle">
      <table style="margin-top:4px; margin-bottom:5px;" width="100%"  border="0" cellspacing="0" cellpadding="5">
        <tr valign="middle">
          <td class="nav">
<a class="h_m" href="index.htm">          MQL5 Programming for Traders </a> / <a class="h_m" href="part7.htm"> Part 7. Advanced language tools </a> / <a class="h_m" href="7_8_project.htm"> 7.8 Projects </a>/ 7.8.5 Server component of web services based on the WebSocket protocol
          </td>
          <td width="70" align="right">
          <a href="7_8_4_project_websockets.htm"><img style="vertical-align:middle;" src="previous.png" alt="?????" width="27" height="27" border=0></a>&nbsp;
          <a href="7_8_6_project_websocket_mql5.htm"><img style="vertical-align:middle;" src="next.png" alt="??????" width="27" height="27" border="0"></a>
          </td>
        </tr>
      </table>
    </td>
    <td width="5"></td>
  </tr>
</table>



<div id="help">
<p class="p_H3"><span class="f_H3">7.8.5 Server component of web services based on the WebSocket protocol</span></p>
<p class="p_Text"><span class="f_Text">To organize a common server component of all projects, we will create a separate folder </span><span class="f_Text" style="font-style: italic;">Web</span><span class="f_Text"> inside </span><span class="f_Text" style="font-style: italic;">MQL5/Experts/MQL5Book/p7/</span><span class="f_Text">. Ideally, it would be convenient to place </span><span class="f_Text" style="font-style: italic;">Web</span><span class="f_Text"> as a subfolder into </span><span class="f_Text" style="font-style: italic;">Shared Projects</span><span class="f_Text">. The fact is that </span><span class="f_Text" style="font-style: italic;">MQL5/Shared Projects</span><span class="f_Text"> is available in the standard distribution of MetaTrader 5 and reserved for cloud storage projects. Therefore, later, by using the functionality of shared projects, it would be possible to upload all the files of our projects to the server (not only web files but also MQL programs).</span></p>
<p class="p_Text"><span class="f_Text">Later, when we create an mqproj file with MQL5 client programs, we will add all the files in this folder to the project section </span><span class="f_Text" style="font-style: italic;">Settings and Files</span><span class="f_Text">, since all these files form an integral part of the project – the server part.</span></p>
<p class="p_Text"><span class="f_Text">Since a separate directory has been allocated for the project server, it is necessary to ensure the possibility of importing modules from nodejs in this directory. By default, nodejs looks for modules in the </span><span class="f_Text" style="font-style: italic;">/node_modules</span><span class="f_Text"> subfolder of the current directory, and we will run the server from the project. Therefore, being in the folder where we will place the web files of the project, run the command:</span></p>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; page-break-after: avoid; border-color: #d8dfea; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExample" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExample">mklink&nbsp;/j&nbsp;node_modules&nbsp;{drive:/path/to/folder/nodejs}/node_modules</span></p>
</td>
</tr>
</table>
</div>
<p class="p_Text"><span class="f_Text">As a result, a &quot;symbolic&quot; directory link called </span><span class="f_Text" style="font-style: italic;">node_modules</span><span class="f_Text"> will appear, pointing to the original folder of the same name in the installed nodejs.</span></p>
<p class="p_Text"><span class="f_Text">The easiest way to check the functionality of WebSockets is the echo service. Its model of operation is to return any received message back to the sender. Let's consider how it would be possible to organize such a service in a minimal configuration. An example is included in the file </span><span class="f_Text" style="font-style: italic;">wsintro.js</span><span class="f_Text">.</span></p>
<p class="p_Text"><span class="f_Text">First of all, we connect the package (module) </span><span class="f_Text" style="font-style: italic;">ws</span><span class="f_Text">, which provides WebSocket functionality for nodejs and which we installed along with the web server.</span></p>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; page-break-after: avoid; border-color: #d8dfea; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExample" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExample" style="color: #808080;">//&nbsp;JavaScript</span>
<br><span class="f_CodeExample" style="color: #0000ff;">const</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">WebSocket</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #333333;">require</span><span class="f_CodeExample">('</span><span class="f_CodeExample" style="color: #333333;">ws</span><span class="f_CodeExample">');</span></p>
</td>
</tr>
</table>
</div>
<p class="p_Text"><span class="f_Text">The </span><span class="f_Text" style="font-style: italic;">require</span><span class="f_Text"> function works similarly to the </span><span class="f_Text" style="font-style: italic;">#include</span><span class="f_Text"> directive in MQL5, but additionally returns a module object with the API of all files in the </span><span class="f_Text" style="font-style: italic;">ws</span><span class="f_Text"> package. Thanks to this, we can call the methods and properties of the </span><span class="f_Text" style="font-style: italic;">WebSocket</span><span class="f_Text"> object. In this case, we need to create a WebSocket server on port 9000.</span></p>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; page-break-after: avoid; border-color: #d8dfea; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExample" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExample" style="color: #808080;">//&nbsp;JavaScript</span>
<br><span class="f_CodeExample" style="color: #0000ff;">const</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">port</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #333333;">9000</span><span class="f_CodeExample">;</span>
<br><span class="f_CodeExample" style="color: #0000ff;">const</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">wss</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">new</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">WebSocket</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">Server</span><span class="f_CodeExample">({&nbsp;</span><span class="f_CodeExample" style="color: #333333;">port</span><span class="f_CodeExample">:&nbsp;</span><span class="f_CodeExample" style="color: #333333;">port</span><span class="f_CodeExample">&nbsp;});</span></p>
</td>
</tr>
</table>
</div>
<p class="p_Text"><span class="f_Text">Here we see the usual MQL5 constructor call by the </span><span class="f_Text" style="font-style: italic;">new</span><span class="f_Text"> operator, but an unnamed object (structure) is passed as a parameter, in which, as in a map, a set of named properties and their values can be stored. In this case, only one property </span><span class="f_Text" style="font-style: italic;">port</span><span class="f_Text"> is used, and its value is set equal to the (more precisely, a constant) </span><span class="f_Text" style="font-style: italic;">port</span><span class="f_Text"> variable described above. Basically, we can pass the port number (and other settings) on the command line when running the script.</span></p>
<p class="p_Text"><span class="f_Text">The server object gets into the </span><span class="f_Text" style="font-style: italic;">wss</span><span class="f_Text"> variable. On success, we signal to the command line window that the server is running (waiting for connections).</span></p>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; page-break-after: avoid; border-color: #d8dfea; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExample" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExample" style="color: #808080;">//&nbsp;JavaScript</span>
<br><span class="f_CodeExample" style="color: #333333;">console</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #0000ff;">log</span><span class="f_CodeExample">('</span><span class="f_CodeExample" style="color: #333333;">listening</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">on</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">port</span><span class="f_CodeExample">:&nbsp;'&nbsp;+&nbsp;</span><span class="f_CodeExample" style="color: #333333;">port</span><span class="f_CodeExample">);</span></p>
</td>
</tr>
</table>
</div>
<p class="p_Text"><span class="f_Text">The </span><span class="f_Text" style="font-style: italic;">console.log</span><span class="f_Text"> call is similar to the usual </span><span class="f_Text" style="font-style: italic;">Print</span><span class="f_Text"> in MQL5. Also note that strings in JavaScript can be enclosed not only in double quotes but also in single quotes, and even in backticks </span><span class="f_Text" style="font-style: italic;">`this is a ${template}text`</span><span class="f_Text">, which adds some useful features.</span></p>
<p class="p_Text"><span class="f_Text">Next, for the </span><span class="f_Text" style="font-style: italic;">wss</span><span class="f_Text"> object, we assign a &quot;connection&quot; event handler, which refers to the connection of a new client. Obviously, the list of supported object events is defined by the developers of the package, in this case, the package </span><span class="f_Text" style="font-style: italic;">ws</span><span class="f_Text"> that we use. All this is reflected in the documentation.</span></p>
<p class="p_Text"><span class="f_Text">The handler is bound by the </span><span class="f_Text" style="font-style: italic;">on</span><span class="f_Text"> method, which specifies the name of the event and the handler itself.</span></p>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; page-break-after: avoid; border-color: #d8dfea; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExample" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExample" style="color: #808080;">//&nbsp;JavaScript</span>
<br><span class="f_CodeExample" style="color: #333333;">wss</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">on</span><span class="f_CodeExample">('</span><span class="f_CodeExample" style="color: #333333;">connection</span><span class="f_CodeExample">',&nbsp;</span><span class="f_CodeExample" style="color: #333333;">function</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">channel</span><span class="f_CodeExample">)</span>
<br><span class="f_CodeExample">{</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;...</span>
<br><span class="f_CodeExample">});</span></p>
</td>
</tr>
</table>
</div>
<p class="p_Text"><span class="f_Text">The handler is an unnamed (anonymous) function defined directly in the place where a reference parameter is expected for the callback code to be executed on a new connection. The function is made anonymous because it is used only here, and JavaScript allows such simplifications in the syntax. The function has only one parameter which is the object of the new connection. We are free to choose the name for the parameter ourselves, and in this case, it is </span><span class="f_Text" style="font-style: italic;">channel</span><span class="f_Text">.</span></p>
<p class="p_Text"><span class="f_Text">Inside the handler, another handler should be set for the &quot;message&quot; event related to the arrival of a new message in a specific channel.</span></p>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; page-break-after: avoid; border-color: #d8dfea; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExample" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExample" style="color: #808080;">//&nbsp;JavaScript</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">channel</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">on</span><span class="f_CodeExample">('</span><span class="f_CodeExample" style="color: #333333;">message</span><span class="f_CodeExample">',&nbsp;</span><span class="f_CodeExample" style="color: #333333;">function</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">message</span><span class="f_CodeExample">)</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;{</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">console</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #0000ff;">log</span><span class="f_CodeExample">('</span><span class="f_CodeExample" style="color: #333333;">message</span><span class="f_CodeExample">:&nbsp;'&nbsp;+&nbsp;</span><span class="f_CodeExample" style="color: #333333;">message</span><span class="f_CodeExample">);</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">channel</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">send</span><span class="f_CodeExample">('</span><span class="f_CodeExample" style="color: #333333;">echo</span><span class="f_CodeExample">:&nbsp;'&nbsp;+&nbsp;</span><span class="f_CodeExample" style="color: #333333;">message</span><span class="f_CodeExample">);</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;});</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;...</span></p>
</td>
</tr>
</table>
</div>
<p class="p_Text"><span class="f_Text">It also uses an anonymous function with a single parameter, the received message object. We print it to the console log for debugging. But the most important thing happens in the second line: by calling </span><span class="f_Text" style="font-style: italic;">channel.send</span><span class="f_Text">, we send a response message to the client.</span></p>
<p class="p_Text"><span class="f_Text">To complete the picture, let's add our own welcome message to the &quot;connection&quot; handler. When complete, it looks like this:</span></p>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; page-break-after: avoid; border-color: #d8dfea; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExample" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExample" style="color: #808080;">//&nbsp;JavaScript</span>
<br><span class="f_CodeExample" style="color: #333333;">wss</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">on</span><span class="f_CodeExample">('</span><span class="f_CodeExample" style="color: #333333;">connection</span><span class="f_CodeExample">',&nbsp;</span><span class="f_CodeExample" style="color: #333333;">function</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">channel</span><span class="f_CodeExample">)</span>
<br><span class="f_CodeExample">{</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">channel</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">on</span><span class="f_CodeExample">('</span><span class="f_CodeExample" style="color: #333333;">message</span><span class="f_CodeExample">',&nbsp;</span><span class="f_CodeExample" style="color: #333333;">function</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">message</span><span class="f_CodeExample">)</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;{</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">console</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #0000ff;">log</span><span class="f_CodeExample">('</span><span class="f_CodeExample" style="color: #333333;">message</span><span class="f_CodeExample">:&nbsp;'&nbsp;+&nbsp;</span><span class="f_CodeExample" style="color: #333333;">message</span><span class="f_CodeExample">);</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">channel</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">send</span><span class="f_CodeExample">('</span><span class="f_CodeExample" style="color: #333333;">echo</span><span class="f_CodeExample">:&nbsp;'&nbsp;+&nbsp;</span><span class="f_CodeExample" style="color: #333333;">message</span><span class="f_CodeExample">);</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;});</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">console</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #0000ff;">log</span><span class="f_CodeExample">('</span><span class="f_CodeExample" style="color: #0000ff;">new</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">client</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">connected</span><span class="f_CodeExample">!');</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">channel</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">send</span><span class="f_CodeExample">('</span><span class="f_CodeExample" style="color: #333333;">connected</span><span class="f_CodeExample">!');</span>
<br><span class="f_CodeExample">});</span></p>
</td>
</tr>
</table>
</div>
<p class="p_Text"><span class="f_Text">It's important to understand that while binding the &quot;message&quot; handler is higher in the code than sending the &quot;hello&quot;, the message handler will be called later, and only if the client sends a message.</span></p>
<p class="p_Text"><span class="f_Text">We have reviewed a script outline for organizing an echo service. However, it would be good to test it. This can be done in the most efficient way by using a regular browser, but this will require complicating the script slightly: turning it into the smallest possible web server that returns a web page with the smallest possible WebSocket client.</span></p>
<p class="p_H4"><span class="f_H4">Echo service and test web page</span></p>
<p class="p_Text"><span class="f_Text">The echo server script that we will now look at is in the file </span><span class="f_Text" style="font-style: italic;">wsecho.js</span><span class="f_Text">. One of the main points is that it is desirable to support not only open protocols on the server </span><span class="f_Text" style="font-style: italic;">http/ws </span><span class="f_Text">but also protected protocols </span><span class="f_Text" style="font-style: italic;">https/wss</span><span class="f_Text">. This possibility will be provided in all our examples (including clients based on MQL5), but for this, you need to perform some actions on the server.</span></p>
<p class="p_Text"><span class="f_Text">You should start with a couple of files containing encryption keys and certificates. The files are usually obtained from authorized sources, i.e. certifying centers, but for informational purposes, you can generate the files yourself. Of course, they cannot be used on public servers, and pages with such certificates will cause warnings in any browser (the page icon to the left of the address bar is highlighted in red).</span></p>
<p class="p_Text"><span class="f_Text">The description of the device of certificates and the process of generating them on their own is beyond the scope of the book, but two ready-made files are included in the book: </span><span class="f_Text" style="font-style: italic;">MQL5Book.crt</span><span class="f_Text"> and </span><span class="f_Text" style="font-style: italic;">MQL5Book.key</span><span class="f_Text"> (there are other extensions) with a limited duration. These files must be passed to the constructor of the web server object in order for the server to work over the HTTPS protocol.</span></p>
<p class="p_Text"><span class="f_Text">We will pass the name of the certificate files in the script launch command line. For example, like this:</span></p>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; page-break-after: avoid; border-color: #d8dfea; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExample" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExample">node&nbsp;wsecho.js&nbsp;MQL5Book</span></p>
</td>
</tr>
</table>
</div>
<p class="p_Text"><span class="f_Text">If you run the script without an additional parameter, the server will work using the HTTP protocol.</span></p>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; page-break-after: avoid; border-color: #d8dfea; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExample" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExample">node&nbsp;wsecho.js</span></p>
</td>
</tr>
</table>
</div>
<p class="p_Text"><span class="f_Text">Inside the script, command line arguments are available through the built-in object </span><span class="f_Text" style="font-style: italic;">process.argv</span><span class="f_Text">, and the first two arguments always contain, respectively, the name of the server </span><span class="f_Text" style="font-style: italic;">node.exe</span><span class="f_Text"> and the name of the script to run (in this case, </span><span class="f_Text" style="font-style: italic;">wsecho.js</span><span class="f_Text">), so we discard them by the </span><span class="f_Text" style="font-style: italic;">splice</span><span class="f_Text"> method.</span></p>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; page-break-after: avoid; border-color: #d8dfea; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExample" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExample" style="color: #808080;">//&nbsp;JavaScript</span>
<br><span class="f_CodeExample" style="color: #0000ff;">const</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">args</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #333333;">process</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">argv</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">slice</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">2</span><span class="f_CodeExample">);</span>
<br><span class="f_CodeExample" style="color: #0000ff;">const</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">secure</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #333333;">args</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">length</span><span class="f_CodeExample">&nbsp;&gt;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">0</span><span class="f_CodeExample">&nbsp;?&nbsp;'</span><span class="f_CodeExample" style="color: #333333;">https</span><span class="f_CodeExample">'&nbsp;:&nbsp;'</span><span class="f_CodeExample" style="color: #333333;">http</span><span class="f_CodeExample">';</span></p>
</td>
</tr>
</table>
</div>
<p class="p_Text"><span class="f_Text">Depending on the presence of the certificate name, the </span><span class="f_Text" style="font-style: italic;">secure</span><span class="f_Text"> variable gets the name of the package that should be loaded next to create the server: </span><span class="f_Text" style="font-style: italic;">https</span><span class="f_Text"> or </span><span class="f_Text" style="font-style: italic;">http</span><span class="f_Text">. In total, we have 3 dependencies in the code:</span></p>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; page-break-after: avoid; border-color: #d8dfea; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExample" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExample" style="color: #808080;">//&nbsp;JavaScript</span>
<br><span class="f_CodeExample" style="color: #0000ff;">const</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">fs</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #333333;">require</span><span class="f_CodeExample">('</span><span class="f_CodeExample" style="color: #333333;">fs</span><span class="f_CodeExample">');</span>
<br><span class="f_CodeExample" style="color: #0000ff;">const</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">http1</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #333333;">require</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">secure</span><span class="f_CodeExample">);</span>
<br><span class="f_CodeExample" style="color: #0000ff;">const</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">WebSocket</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #333333;">require</span><span class="f_CodeExample">('</span><span class="f_CodeExample" style="color: #333333;">ws</span><span class="f_CodeExample">');</span></p>
</td>
</tr>
</table>
</div>
<p class="p_Text"><span class="f_Text">We already know all about the </span><span class="f_Text" style="font-style: italic;">ws</span><span class="f_Text"> package; the </span><span class="f_Text" style="font-style: italic;">https</span><span class="f_Text"> and </span><span class="f_Text" style="font-style: italic;">http</span><span class="f_Text"> packages provide a web server implementation, and the built-in </span><span class="f_Text" style="font-style: italic;">fs</span><span class="f_Text"> package provides work with the file system.</span></p>
<p class="p_Text"><span class="f_Text">Web server settings are formatted as the </span><span class="f_Text" style="font-style: italic;">options</span><span class="f_Text"> object. Here we see how the name of the certificate from the command line is substituted in strings with slash quotes using the expression </span><span class="f_Text" style="font-style: italic;">${args[0]}</span><span class="f_Text">. Then the corresponding pair of files is read by the method </span><span class="f_Text" style="font-style: italic;">fs.readFileSync</span><span class="f_Text">.</span></p>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; page-break-after: avoid; border-color: #d8dfea; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExample" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExample" style="color: #808080;">//&nbsp;JavaScript</span>
<br><span class="f_CodeExample" style="color: #0000ff;">const</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">options</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #333333;">args</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">length</span><span class="f_CodeExample">&nbsp;&gt;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">0</span><span class="f_CodeExample">&nbsp;?</span>
<br><span class="f_CodeExample">{</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">key</span><span class="f_CodeExample">&nbsp;:&nbsp;</span><span class="f_CodeExample" style="color: #333333;">fs</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">readFileSync</span><span class="f_CodeExample">(`</span><span class="f_CodeExample" style="color: #008100;">$</span><span class="f_CodeExample">{</span><span class="f_CodeExample" style="color: #333333;">args</span><span class="f_CodeExample">[</span><span class="f_CodeExample" style="color: #333333;">0</span><span class="f_CodeExample">]}.</span><span class="f_CodeExample" style="color: #333333;">key</span><span class="f_CodeExample">`),</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">cert</span><span class="f_CodeExample">&nbsp;:&nbsp;</span><span class="f_CodeExample" style="color: #333333;">fs</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">readFileSync</span><span class="f_CodeExample">(`</span><span class="f_CodeExample" style="color: #008100;">$</span><span class="f_CodeExample">{</span><span class="f_CodeExample" style="color: #333333;">args</span><span class="f_CodeExample">[</span><span class="f_CodeExample" style="color: #333333;">0</span><span class="f_CodeExample">]}.</span><span class="f_CodeExample" style="color: #333333;">crt</span><span class="f_CodeExample">`)</span>
<br><span class="f_CodeExample">}&nbsp;:&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">null</span><span class="f_CodeExample">;</span></p>
</td>
</tr>
</table>
</div>
<p class="p_Text"><span class="f_Text">The web server is created by calling the </span><span class="f_Text" style="font-style: italic;">createServer</span><span class="f_Text"> method, to which we pass the options object and an anonymous function – an HTTP request handler. The handler has two parameters: the </span><span class="f_Text" style="font-style: italic;">req</span><span class="f_Text"> object with an HTTP request and the </span><span class="f_Text" style="font-style: italic;">res</span><span class="f_Text"> object with which we should send the response (HTTP headers and web page).</span></p>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; page-break-after: avoid; border-color: #d8dfea; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExample" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExample" style="color: #808080;">//&nbsp;JavaScript</span>
<br><span class="f_CodeExample" style="color: #333333;">http1</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">createServer</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">options</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">function</span><span class="f_CodeExample">&nbsp;(</span><span class="f_CodeExample" style="color: #333333;">req</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">res</span><span class="f_CodeExample">)</span>
<br><span class="f_CodeExample">{</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">console</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #0000ff;">log</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">req</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">method</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">req</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">url</span><span class="f_CodeExample">);</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">console</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #0000ff;">log</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">req</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">headers</span><span class="f_CodeExample">);</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">if</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">req</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">url</span><span class="f_CodeExample">&nbsp;==&nbsp;'/')&nbsp;</span><span class="f_CodeExample" style="color: #333333;">req</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">url</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #008080;">&quot;index.htm&quot;</span><span class="f_CodeExample">;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">fs</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">readFile</span><span class="f_CodeExample">('./'&nbsp;+&nbsp;</span><span class="f_CodeExample" style="color: #333333;">req</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">url</span><span class="f_CodeExample">,&nbsp;(</span><span class="f_CodeExample" style="color: #333333;">err</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">data</span><span class="f_CodeExample">)&nbsp;=&gt;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;{</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">if</span><span class="f_CodeExample">(!</span><span class="f_CodeExample" style="color: #333333;">err</span><span class="f_CodeExample">)</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">var</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">dotoffset</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #333333;">req</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">url</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">lastIndexOf</span><span class="f_CodeExample">('.');</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">var</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">mimetype</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #333333;">dotoffset</span><span class="f_CodeExample">&nbsp;==&nbsp;-</span><span class="f_CodeExample" style="color: #333333;">1</span><span class="f_CodeExample">&nbsp;?&nbsp;'</span><span class="f_CodeExample" style="color: #333333;">text</span><span class="f_CodeExample">/</span><span class="f_CodeExample" style="color: #333333;">plain</span><span class="f_CodeExample">'&nbsp;:</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'.</span><span class="f_CodeExample" style="color: #333333;">htm</span><span class="f_CodeExample">'&nbsp;:&nbsp;'</span><span class="f_CodeExample" style="color: #333333;">text</span><span class="f_CodeExample">/</span><span class="f_CodeExample" style="color: #333333;">html</span><span class="f_CodeExample">',</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'.</span><span class="f_CodeExample" style="color: #333333;">html</span><span class="f_CodeExample">'&nbsp;:&nbsp;'</span><span class="f_CodeExample" style="color: #333333;">text</span><span class="f_CodeExample">/</span><span class="f_CodeExample" style="color: #333333;">html</span><span class="f_CodeExample">',</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'.</span><span class="f_CodeExample" style="color: #333333;">css</span><span class="f_CodeExample">'&nbsp;:&nbsp;'</span><span class="f_CodeExample" style="color: #333333;">text</span><span class="f_CodeExample">/</span><span class="f_CodeExample" style="color: #333333;">css</span><span class="f_CodeExample">',</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'.</span><span class="f_CodeExample" style="color: #333333;">js</span><span class="f_CodeExample">'&nbsp;:&nbsp;'</span><span class="f_CodeExample" style="color: #333333;">text</span><span class="f_CodeExample">/</span><span class="f_CodeExample" style="color: #333333;">javascript</span><span class="f_CodeExample">'</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}[&nbsp;</span><span class="f_CodeExample" style="color: #333333;">req</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">url</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">substr</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">dotoffset</span><span class="f_CodeExample">)&nbsp;];</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">res</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">setHeader</span><span class="f_CodeExample">('</span><span class="f_CodeExample" style="color: #333333;">Content</span><span class="f_CodeExample">-</span><span class="f_CodeExample" style="color: #333333;">Type</span><span class="f_CodeExample">',</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">mimetype</span><span class="f_CodeExample">&nbsp;==&nbsp;</span><span class="f_CodeExample" style="color: #333333;">undefined</span><span class="f_CodeExample">&nbsp;?&nbsp;'</span><span class="f_CodeExample" style="color: #333333;">text</span><span class="f_CodeExample">/</span><span class="f_CodeExample" style="color: #333333;">plain</span><span class="f_CodeExample">'&nbsp;:&nbsp;</span><span class="f_CodeExample" style="color: #333333;">mimetype</span><span class="f_CodeExample">);</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">res</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">end</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">data</span><span class="f_CodeExample">);</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">else</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">console</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #0000ff;">log</span><span class="f_CodeExample">('</span><span class="f_CodeExample" style="color: #333333;">File</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">not</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">fount</span><span class="f_CodeExample">:&nbsp;'&nbsp;+&nbsp;</span><span class="f_CodeExample" style="color: #333333;">req</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">url</span><span class="f_CodeExample">);</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">res</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">writeHead</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">404</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #008080;">&quot;Not&nbsp;Found&quot;</span><span class="f_CodeExample">);</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">res</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">end</span><span class="f_CodeExample">();</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;});</span>
<br><span class="f_CodeExample">}).</span><span class="f_CodeExample" style="color: #333333;">listen</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">secure</span><span class="f_CodeExample">&nbsp;==&nbsp;'</span><span class="f_CodeExample" style="color: #333333;">https</span><span class="f_CodeExample">'&nbsp;?&nbsp;</span><span class="f_CodeExample" style="color: #333333;">443</span><span class="f_CodeExample">&nbsp;:&nbsp;</span><span class="f_CodeExample" style="color: #333333;">80</span><span class="f_CodeExample">);</span></p>
</td>
</tr>
</table>
</div>
<p class="p_Text"><span class="f_Text">The main index page (and the only one) is </span><span class="f_Text" style="font-style: italic;">index.htm</span><span class="f_Text"> (to be written now). In addition, the handler can send js and css files, which will be useful to us in the future. Depending on whether protected mode is enabled, the server is started by calling the method </span><span class="f_Text" style="font-style: italic;">listen</span><span class="f_Text"> on standard ports 443 or 80 (change to others if these are already taken on your computer).</span></p>
<p class="p_Text"><span class="f_Text">To accept connections on port 9000 for web sockets, we need to deploy another web server instance with the same options. But in this case, the server is there for the sole purpose of handling an HTTP request to &quot;upgrade&quot; the connection up to the Web Sockets protocol.</span></p>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; page-break-after: avoid; border-color: #d8dfea; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExample" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExample" style="color: #808080;">//&nbsp;JavaScript</span>
<br><span class="f_CodeExample" style="color: #0000ff;">const</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">server</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">new</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">http1</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">createServer</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">options</span><span class="f_CodeExample">).</span><span class="f_CodeExample" style="color: #333333;">listen</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">9000</span><span class="f_CodeExample">);</span>
<br><span class="f_CodeExample" style="color: #333333;">server</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">on</span><span class="f_CodeExample">('</span><span class="f_CodeExample" style="color: #333333;">upgrade</span><span class="f_CodeExample">',&nbsp;</span><span class="f_CodeExample" style="color: #333333;">function</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">req</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">socket</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">head</span><span class="f_CodeExample">)</span>
<br><span class="f_CodeExample">{</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">console</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #0000ff;">log</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">req</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">headers</span><span class="f_CodeExample">);&nbsp;</span><span class="f_CodeExample" style="color: #808080;">//&nbsp;TODO:&nbsp;we&nbsp;can&nbsp;add&nbsp;authorization!</span>
<br><span class="f_CodeExample">});</span></p>
</td>
</tr>
</table>
</div>
<p class="p_Text"><span class="f_Text">Here, in the &quot;upgrade&quot; event handler, we accept any connections that have already passed the handshake and print the headers to the log, but potentially we could request user authorization if we were doing a closed (paid) service.</span></p>
<p class="p_Text"><span class="f_Text">Finally, we create a WebSocket server object, as in the previous introductory example, with the only difference being that a ready-made web server is passed to the constructor. All connecting clients are counted and welcomed by sequence number.</span></p>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; page-break-after: avoid; border-color: #d8dfea; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExample" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExample" style="color: #808080;">//&nbsp;JavaScript</span>
<br><span class="f_CodeExample" style="color: #333333;">var</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">count</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #333333;">0</span><span class="f_CodeExample">;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span>
<br><span class="f_CodeExample" style="color: #0000ff;">const</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">wsServer</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">new</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">WebSocket</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">Server</span><span class="f_CodeExample">({&nbsp;</span><span class="f_CodeExample" style="color: #333333;">server</span><span class="f_CodeExample">&nbsp;});</span>
<br><span class="f_CodeExample" style="color: #333333;">wsServer</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">on</span><span class="f_CodeExample">('</span><span class="f_CodeExample" style="color: #333333;">connection</span><span class="f_CodeExample">',&nbsp;</span><span class="f_CodeExample" style="color: #333333;">function</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">onConnect</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">client</span><span class="f_CodeExample">)</span>
<br><span class="f_CodeExample">{</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">console</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #0000ff;">log</span><span class="f_CodeExample">('</span><span class="f_CodeExample" style="color: #0000ff;">New</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">user</span><span class="f_CodeExample">:',&nbsp;++</span><span class="f_CodeExample" style="color: #333333;">count</span><span class="f_CodeExample">);</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">client</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">id</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #333333;">count</span><span class="f_CodeExample">;&nbsp;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">client</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">send</span><span class="f_CodeExample">('</span><span class="f_CodeExample" style="color: #333333;">server#Hello</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">user</span><span class="f_CodeExample">'&nbsp;+&nbsp;</span><span class="f_CodeExample" style="color: #333333;">count</span><span class="f_CodeExample">);</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">client</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">on</span><span class="f_CodeExample">('</span><span class="f_CodeExample" style="color: #333333;">message</span><span class="f_CodeExample">',&nbsp;</span><span class="f_CodeExample" style="color: #333333;">function</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">message</span><span class="f_CodeExample">)</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;{</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">console</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #0000ff;">log</span><span class="f_CodeExample">('%</span><span class="f_CodeExample" style="color: #333333;">d</span><span class="f_CodeExample">&nbsp;:&nbsp;%</span><span class="f_CodeExample" style="color: #333333;">s</span><span class="f_CodeExample">',&nbsp;</span><span class="f_CodeExample" style="color: #333333;">client</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">id</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">message</span><span class="f_CodeExample">);</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">client</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">send</span><span class="f_CodeExample">('</span><span class="f_CodeExample" style="color: #333333;">user</span><span class="f_CodeExample">'&nbsp;+&nbsp;</span><span class="f_CodeExample" style="color: #333333;">client</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">id</span><span class="f_CodeExample">&nbsp;+&nbsp;'</span><span class="f_CodeExample" style="color: #333333;">#</span><span class="f_CodeExample">'&nbsp;+&nbsp;</span><span class="f_CodeExample" style="color: #333333;">message</span><span class="f_CodeExample">);</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;});</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">client</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">on</span><span class="f_CodeExample">('</span><span class="f_CodeExample" style="color: #333333;">close</span><span class="f_CodeExample">',&nbsp;</span><span class="f_CodeExample" style="color: #333333;">function</span><span class="f_CodeExample">()</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;{</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">console</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #0000ff;">log</span><span class="f_CodeExample">('</span><span class="f_CodeExample" style="color: #333333;">User</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">disconnected</span><span class="f_CodeExample">:',&nbsp;</span><span class="f_CodeExample" style="color: #333333;">client</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">id</span><span class="f_CodeExample">);</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;});</span>
<br><span class="f_CodeExample">});</span></p>
</td>
</tr>
</table>
</div>
<p class="p_Text"><span class="f_Text">For all events, including connection, disconnection, and message, debug information is displayed in the console.</span></p>
<p class="p_Text"><span class="f_Text">Well, the web server with web socket server support is ready. Now we need to create a client web page </span><span class="f_Text" style="font-style: italic;">index.htm</span><span class="f_Text"> for it.</span></p>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; page-break-after: avoid; border-color: #d8dfea; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExample" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExample" style="font-weight: bold;">&lt;</span><span class="f_CodeExample" style="font-weight: bold; color: #8000ff;">!DOCTYPE</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="font-weight: bold;">html&gt;</span>
<br><span class="f_CodeExample" style="font-weight: bold;">&lt;</span><span class="f_CodeExample" style="font-weight: bold; color: #8000ff;">html</span><span class="f_CodeExample" style="font-weight: bold;">&gt;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;</span><span class="f_CodeExample" style="font-weight: bold;">&lt;</span><span class="f_CodeExample" style="font-weight: bold; color: #8000ff;">head</span><span class="f_CodeExample" style="font-weight: bold;">&gt;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;</span><span class="f_CodeExample" style="font-weight: bold;">&lt;</span><span class="f_CodeExample" style="font-weight: bold; color: #8000ff;">title</span><span class="f_CodeExample" style="font-weight: bold;">&gt;</span><span class="f_CodeExample">Test&nbsp;Server&nbsp;(HTTP[S]/WS[S])</span><span class="f_CodeExample" style="font-weight: bold;">&lt;</span><span class="f_CodeExample" style="font-weight: bold; color: #8000ff;">/title</span><span class="f_CodeExample" style="font-weight: bold;">&gt;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;</span><span class="f_CodeExample" style="font-weight: bold;">&lt;</span><span class="f_CodeExample" style="font-weight: bold; color: #8000ff;">/head</span><span class="f_CodeExample" style="font-weight: bold;">&gt;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;</span><span class="f_CodeExample" style="font-weight: bold;">&lt;</span><span class="f_CodeExample" style="font-weight: bold; color: #8000ff;">body</span><span class="f_CodeExample" style="font-weight: bold;">&gt;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="font-weight: bold;">&lt;</span><span class="f_CodeExample" style="font-weight: bold; color: #8000ff;">div</span><span class="f_CodeExample" style="font-weight: bold;">&gt;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="font-weight: bold;">&lt;</span><span class="f_CodeExample" style="font-weight: bold; color: #8000ff;">h1</span><span class="f_CodeExample" style="font-weight: bold;">&gt;</span><span class="f_CodeExample">Test&nbsp;Server&nbsp;(HTTP[S]/WS[S])</span><span class="f_CodeExample" style="font-weight: bold;">&lt;</span><span class="f_CodeExample" style="font-weight: bold; color: #8000ff;">/h1</span><span class="f_CodeExample" style="font-weight: bold;">&gt;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="font-weight: bold;">&lt;</span><span class="f_CodeExample" style="font-weight: bold; color: #8000ff;">p</span><span class="f_CodeExample" style="font-weight: bold;">&gt;&lt;</span><span class="f_CodeExample" style="font-weight: bold; color: #8000ff;">label</span><span class="f_CodeExample" style="font-weight: bold;">&gt;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Message:&nbsp;</span><span class="f_CodeExample" style="font-weight: bold;">&lt;</span><span class="f_CodeExample" style="font-weight: bold; color: #8000ff;">input</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="font-weight: bold;">id=</span><span class="f_CodeExample" style="color: #0080ff;">&quot;message&quot;</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="font-weight: bold;">name=</span><span class="f_CodeExample" style="color: #0080ff;">&quot;message&quot;</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="font-weight: bold;">placeholder=</span><span class="f_CodeExample" style="color: #0080ff;">&quot;Enter&nbsp;a&nbsp;text&quot;</span><span class="f_CodeExample" style="font-weight: bold;">&gt;</span>
<br><span class="f_CodeExample" style="font-weight: bold;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;</span><span class="f_CodeExample" style="font-weight: bold; color: #8000ff;">/label</span><span class="f_CodeExample" style="font-weight: bold;">&gt;&lt;</span><span class="f_CodeExample" style="font-weight: bold; color: #8000ff;">/p</span><span class="f_CodeExample" style="font-weight: bold;">&gt;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="font-weight: bold;">&lt;</span><span class="f_CodeExample" style="font-weight: bold; color: #8000ff;">p</span><span class="f_CodeExample" style="font-weight: bold;">&gt;&lt;</span><span class="f_CodeExample" style="font-weight: bold; color: #8000ff;">button</span><span class="f_CodeExample" style="font-weight: bold;">&gt;</span><span class="f_CodeExample">Submit</span><span class="f_CodeExample" style="font-weight: bold;">&lt;</span><span class="f_CodeExample" style="font-weight: bold; color: #8000ff;">/button</span><span class="f_CodeExample" style="font-weight: bold;">&gt;</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="font-weight: bold;">&lt;</span><span class="f_CodeExample" style="font-weight: bold; color: #8000ff;">button</span><span class="f_CodeExample" style="font-weight: bold;">&gt;</span><span class="f_CodeExample">Close</span><span class="f_CodeExample" style="font-weight: bold;">&lt;</span><span class="f_CodeExample" style="font-weight: bold; color: #8000ff;">/button</span><span class="f_CodeExample" style="font-weight: bold;">&gt;&lt;</span><span class="f_CodeExample" style="font-weight: bold; color: #8000ff;">/p</span><span class="f_CodeExample" style="font-weight: bold;">&gt;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="font-weight: bold;">&lt;</span><span class="f_CodeExample" style="font-weight: bold; color: #8000ff;">p</span><span class="f_CodeExample" style="font-weight: bold;">&gt;&lt;</span><span class="f_CodeExample" style="font-weight: bold; color: #8000ff;">label</span><span class="f_CodeExample" style="font-weight: bold;">&gt;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Echo:&nbsp;</span><span class="f_CodeExample" style="font-weight: bold;">&lt;</span><span class="f_CodeExample" style="font-weight: bold; color: #8000ff;">input</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="font-weight: bold;">id=</span><span class="f_CodeExample" style="color: #0080ff;">&quot;echo&quot;</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="font-weight: bold;">name=</span><span class="f_CodeExample" style="color: #0080ff;">&quot;echo&quot;</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="font-weight: bold;">placeholder=</span><span class="f_CodeExample" style="color: #0080ff;">&quot;Text&nbsp;from&nbsp;server&quot;</span><span class="f_CodeExample" style="font-weight: bold;">&gt;</span>
<br><span class="f_CodeExample" style="font-weight: bold;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;</span><span class="f_CodeExample" style="font-weight: bold; color: #8000ff;">/label</span><span class="f_CodeExample" style="font-weight: bold;">&gt;&lt;</span><span class="f_CodeExample" style="font-weight: bold; color: #8000ff;">/p</span><span class="f_CodeExample" style="font-weight: bold;">&gt;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="font-weight: bold;">&lt;</span><span class="f_CodeExample" style="font-weight: bold; color: #8000ff;">/div</span><span class="f_CodeExample" style="font-weight: bold;">&gt;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;</span><span class="f_CodeExample" style="font-weight: bold;">&lt;</span><span class="f_CodeExample" style="font-weight: bold; color: #8000ff;">/body</span><span class="f_CodeExample" style="font-weight: bold;">&gt;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;</span><span class="f_CodeExample" style="font-weight: bold;">&lt;</span><span class="f_CodeExample" style="font-weight: bold; color: #8000ff;">script</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="font-weight: bold;">src=</span><span class="f_CodeExample" style="color: #0080ff;">&quot;wsecho_client.js&quot;</span><span class="f_CodeExample" style="font-weight: bold;">&gt;&lt;</span><span class="f_CodeExample" style="font-weight: bold; color: #8000ff;">/script</span><span class="f_CodeExample" style="font-weight: bold;">&gt;</span>
<br><span class="f_CodeExample" style="font-weight: bold;">&lt;</span><span class="f_CodeExample" style="font-weight: bold; color: #8000ff;">/html</span><span class="f_CodeExample" style="font-weight: bold;">&gt;</span></p>
</td>
</tr>
</table>
</div>
<p class="p_Text"><span class="f_Text">The page is a form with a single input field and a button for sending a message.</span></p>
<p class="p_ImageCaption"><img class="help" alt="Echo service web page on WebSocket" title="Echo service web page on WebSocket" width="379" height="215" style="margin:0 auto 0 auto;width:379px;height:215px;border:none" src="wsecho.png"/></p>
<p class="p_ImageCaption"><span class="f_ImageCaption">Echo service web page on WebSocket</span></p>
<p class="p_Text"><span class="f_Text">The page uses the </span><span class="f_Text" style="font-style: italic;">wsecho_client.js</span><span class="f_Text"> script, which provides websocket client response. In browsers, web sockets are built in as &quot;native&quot; JavaScript objects, so you don't need to connect anything external: just call the constructor </span><span class="f_Text" style="font-style: italic;">web socket</span><span class="f_Text"> with the desired protocol and port number.</span></p>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; page-break-after: avoid; border-color: #d8dfea; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExample" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExample" style="color: #808080;">//&nbsp;JavaScript</span>
<br><span class="f_CodeExample" style="color: #0000ff;">const</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">proto</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #333333;">window</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">location</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">protocol</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">startsWith</span><span class="f_CodeExample">('</span><span class="f_CodeExample" style="color: #333333;">http</span><span class="f_CodeExample">')&nbsp;?</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">window</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">location</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">protocol</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">replace</span><span class="f_CodeExample">('</span><span class="f_CodeExample" style="color: #333333;">http</span><span class="f_CodeExample">',&nbsp;'</span><span class="f_CodeExample" style="color: #333333;">ws</span><span class="f_CodeExample">')&nbsp;:&nbsp;'</span><span class="f_CodeExample" style="color: #333333;">ws</span><span class="f_CodeExample">:';</span>
<br><span class="f_CodeExample" style="color: #0000ff;">const</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">ws</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">new</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">WebSocket</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">proto</span><span class="f_CodeExample">&nbsp;+&nbsp;'//'&nbsp;+&nbsp;window.location.hostname&nbsp;+&nbsp;':9000');</span></p>
</td>
</tr>
</table>
</div>
<p class="p_Text"><span class="f_Text">The URL is formed from the address of the current web page (</span><span class="f_Text" style="font-style: italic;">window.location.hostname</span><span class="f_Text">), so the web socket connection is made to the same server.</span></p>
<p class="p_Text"><span class="f_Text">Next, the </span><span class="f_Text" style="font-style: italic;">ws</span><span class="f_Text"> object allows you to react to events and send messages. In the browser, the open connection event is called &quot;open&quot;; it is connected via the </span><span class="f_Text" style="font-style: italic;">onopen</span><span class="f_Text"> property. The same syntx, slightly different from the server implementation, is also used for the new message arrival event – the handler for it is assigned to the </span><span class="f_Text" style="font-style: italic;">onmessage</span><span class="f_Text"> property.</span></p>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; page-break-after: avoid; border-color: #d8dfea; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExample" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExample" style="color: #808080;">//&nbsp;JavaScript</span>
<br><span class="f_CodeExample" style="color: #333333;">ws</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">onopen</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #333333;">function</span><span class="f_CodeExample">()</span>
<br><span class="f_CodeExample">{</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">console</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #0000ff;">log</span><span class="f_CodeExample">('</span><span class="f_CodeExample" style="color: #333333;">Connected</span><span class="f_CodeExample">');</span>
<br><span class="f_CodeExample">};</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span>
<br><span class="f_CodeExample" style="color: #333333;">ws</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">onmessage</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #333333;">function</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">message</span><span class="f_CodeExample">)</span>
<br><span class="f_CodeExample">{</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">console</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #0000ff;">log</span><span class="f_CodeExample">('</span><span class="f_CodeExample" style="color: #333333;">Message</span><span class="f_CodeExample">:&nbsp;%</span><span class="f_CodeExample" style="color: #333333;">s</span><span class="f_CodeExample">',&nbsp;</span><span class="f_CodeExample" style="color: #333333;">message</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">data</span><span class="f_CodeExample">);</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">document</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">getElementById</span><span class="f_CodeExample">('</span><span class="f_CodeExample" style="color: #333333;">echo</span><span class="f_CodeExample">').</span><span class="f_CodeExample" style="color: #333333;">value</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #333333;">message</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">data</span><span class="f_CodeExample">;&nbsp;</span>
<br><span class="f_CodeExample">};</span></p>
</td>
</tr>
</table>
</div>
<p class="p_Text"><span class="f_Text">The text of the incoming message is displayed in the form element with the id &quot;echo&quot;. Note that the message event object (handler parameter) is not the message which is available in the </span><span class="f_Text" style="font-style: italic;">data</span><span class="f_Text"> property. This is an implementation feature in JavaScript.</span></p>
<p class="p_Text"><span class="f_Text">The reaction to the form buttons is assigned using the </span><span class="f_Text" style="font-style: italic;">addEventListener</span><span class="f_Text"> method for each of the two </span><span class="f_Text" style="font-style: italic;">button</span><span class="f_Text"> tag objects. Here we see another way of describing an anonymous function in JavaScript: parentheses with an argument list that can be empty, and the body of the function after the arrow can be </span><span class="f_Text" style="font-style: italic;">(arguments) =&gt; { ... }</span><span class="f_Text">.</span></p>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; page-break-after: avoid; border-color: #d8dfea; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExample" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExample" style="color: #808080;">//&nbsp;JavaScript</span>
<br><span class="f_CodeExample" style="color: #0000ff;">const</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">button</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #333333;">document</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">querySelectorAll</span><span class="f_CodeExample">('</span><span class="f_CodeExample" style="color: #333333;">button</span><span class="f_CodeExample">');&nbsp;</span><span class="f_CodeExample" style="color: #808080;">//&nbsp;request&nbsp;all&nbsp;buttons</span>
<br><span class="f_CodeExample" style="color: #808080;">//&nbsp;button&nbsp;&quot;Submit&quot;&nbsp;&nbsp;</span>
<br><span class="f_CodeExample" style="color: #333333;">button</span><span class="f_CodeExample">[</span><span class="f_CodeExample" style="color: #333333;">0</span><span class="f_CodeExample">].</span><span class="f_CodeExample" style="color: #333333;">addEventListener</span><span class="f_CodeExample">('</span><span class="f_CodeExample" style="color: #333333;">click</span><span class="f_CodeExample">',&nbsp;(</span><span class="f_CodeExample" style="color: #333333;">event</span><span class="f_CodeExample">)&nbsp;=&gt;</span>
<br><span class="f_CodeExample">{</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">const</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">x</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #333333;">document</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">getElementById</span><span class="f_CodeExample">('</span><span class="f_CodeExample" style="color: #333333;">message</span><span class="f_CodeExample">').</span><span class="f_CodeExample" style="color: #333333;">value</span><span class="f_CodeExample">;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">if</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">x</span><span class="f_CodeExample">)&nbsp;</span><span class="f_CodeExample" style="color: #333333;">ws</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">send</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">x</span><span class="f_CodeExample">);</span>
<br><span class="f_CodeExample">});</span>
<br><span class="f_CodeExample" style="color: #808080;">//&nbsp;button&nbsp;&quot;close&quot;</span>
<br><span class="f_CodeExample" style="color: #333333;">button</span><span class="f_CodeExample">[</span><span class="f_CodeExample" style="color: #333333;">1</span><span class="f_CodeExample">].</span><span class="f_CodeExample" style="color: #333333;">addEventListener</span><span class="f_CodeExample">('</span><span class="f_CodeExample" style="color: #333333;">click</span><span class="f_CodeExample">',&nbsp;(</span><span class="f_CodeExample" style="color: #333333;">event</span><span class="f_CodeExample">)&nbsp;=&gt;</span>
<br><span class="f_CodeExample">{</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">ws</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">close</span><span class="f_CodeExample">();</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">document</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">getElementById</span><span class="f_CodeExample">('</span><span class="f_CodeExample" style="color: #333333;">echo</span><span class="f_CodeExample">').</span><span class="f_CodeExample" style="color: #333333;">value</span><span class="f_CodeExample">&nbsp;=&nbsp;'</span><span class="f_CodeExample" style="color: #333333;">disconnected</span><span class="f_CodeExample">';</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">Array</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">from</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">document</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">getElementsByTagName</span><span class="f_CodeExample">('</span><span class="f_CodeExample" style="color: #333333;">button</span><span class="f_CodeExample">')).</span><span class="f_CodeExample" style="color: #333333;">forEach</span><span class="f_CodeExample">((</span><span class="f_CodeExample" style="color: #333333;">e</span><span class="f_CodeExample">)&nbsp;=&gt;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;{</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">e</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">disabled</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">true</span><span class="f_CodeExample">;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;});</span>
<br><span class="f_CodeExample">});</span></p>
</td>
</tr>
</table>
</div>
<p class="p_Text"><span class="f_Text">To send messages, we call the </span><span class="f_Text" style="font-style: italic;">ws.send</span><span class="f_Text"> method, and to close the connection we call the </span><span class="f_Text" style="font-style: italic;">ws.close</span><span class="f_Text"> method.</span></p>
<p class="p_Text"><span class="f_Text">This completes the development of the first example of client-server scripts for demonstrating the echo service. You can run </span><span class="f_Text" style="font-style: italic;">wsecho.js</span><span class="f_Text"> using one of the commands shown earlier, and then open in your browser the page at </span><span class="f_Text" style="font-style: italic;">http://localhost</span><span class="f_Text"> or </span><span class="f_Text" style="font-style: italic;">https://localhost</span><span class="f_Text"> (depending on server settings). After the form appears on the screen, try chatting with the server and make sure the service is running.</span></p>
<p class="p_Text"><span class="f_Text">Gradually complicating this example, we will pave the way for the web service for copying trading signals. But the next step will be a chat service, the principle of which is similar to the service of trading signals: messages from one user are transmitted to other users.</span></p>
<p class="p_H4"><span class="f_H4">Chat service and test web page</span></p>
<p class="p_Text"><span class="f_Text">The new server script is called </span><span class="f_Text" style="font-style: italic;">wschat.js</span><span class="f_Text">, and it repeats a lot from </span><span class="f_Text" style="font-style: italic;">wsecho.js</span><span class="f_Text">. Let's list the main differences. In the web server HTTP request handler, change the initial page from </span><span class="f_Text" style="font-style: italic;">index.htm</span><span class="f_Text"> to </span><span class="f_Text" style="font-style: italic;">wschat.htm</span><span class="f_Text">.</span></p>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; page-break-after: avoid; border-color: #d8dfea; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExample" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExample" style="color: #808080;">//&nbsp;JavaScript</span>
<br><span class="f_CodeExample" style="color: #333333;">http1</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">createServer</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">options</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">function</span><span class="f_CodeExample">&nbsp;(</span><span class="f_CodeExample" style="color: #333333;">req</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">res</span><span class="f_CodeExample">)</span>
<br><span class="f_CodeExample">{</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">if</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">req</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">url</span><span class="f_CodeExample">&nbsp;==&nbsp;'/')&nbsp;</span><span class="f_CodeExample" style="color: #333333;">req</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">url</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #008080;">&quot;wschat.htm&quot;</span><span class="f_CodeExample">;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;...</span>
<br><span class="f_CodeExample">});</span></p>
</td>
</tr>
</table>
</div>
<p class="p_Text"><span class="f_Text">To store information about users connected to the chat, we will describe the </span><span class="f_Text" style="font-style: italic;">clients</span><span class="f_Text"> map array. </span><span class="f_Text" style="font-style: italic;">Map</span><span class="f_Text"> is a standard JavaScript associative container, into which arbitrary values can be written using keys of an arbitrary type, including objects.</span></p>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; page-break-after: avoid; border-color: #d8dfea; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExample" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExample" style="color: #808080;">//&nbsp;JavaScript</span>
<br><span class="f_CodeExample" style="color: #0000ff;">const</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">clients</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">new</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">Map</span><span class="f_CodeExample">();&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #808080;">//&nbsp;added&nbsp;this&nbsp;line</span>
<br><span class="f_CodeExample" style="color: #333333;">var</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">count</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #333333;">0</span><span class="f_CodeExample">;</span></p>
</td>
</tr>
</table>
</div>
<p class="p_Text"><span class="f_Text">In the new user connection event handler, we will add the </span><span class="f_Text" style="font-style: italic;">client</span><span class="f_Text"> object, received as a function parameter, into the map under the current client sequence number.</span></p>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; page-break-after: avoid; border-color: #d8dfea; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExample" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExample" style="color: #808080;">//&nbsp;JavaScript</span>
<br><span class="f_CodeExample" style="color: #333333;">wsServer</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">on</span><span class="f_CodeExample">('</span><span class="f_CodeExample" style="color: #333333;">connection</span><span class="f_CodeExample">',&nbsp;</span><span class="f_CodeExample" style="color: #333333;">function</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">onConnect</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">client</span><span class="f_CodeExample">)</span>
<br><span class="f_CodeExample">{</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">console</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #0000ff;">log</span><span class="f_CodeExample">('</span><span class="f_CodeExample" style="color: #0000ff;">New</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">user</span><span class="f_CodeExample">:',&nbsp;++</span><span class="f_CodeExample" style="color: #333333;">count</span><span class="f_CodeExample">);</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">client</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">id</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #333333;">count</span><span class="f_CodeExample">;&nbsp;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">client</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">send</span><span class="f_CodeExample">('</span><span class="f_CodeExample" style="color: #333333;">server#Hello</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">user</span><span class="f_CodeExample">'&nbsp;+&nbsp;</span><span class="f_CodeExample" style="color: #333333;">count</span><span class="f_CodeExample">);</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">clients</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">set</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">count</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">client</span><span class="f_CodeExample">);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #808080;">//&nbsp;added&nbsp;this&nbsp;line</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;...</span></p>
</td>
</tr>
</table>
</div>
<p class="p_Text"><span class="f_Text">Inside the </span><span class="f_Text" style="font-style: italic;">onConnect</span><span class="f_Text"> function, we set a handler for the event about the arrival of a new message for a specific client, and it is inside the nested handler that we send messages. However, this time we loop through all the elements of the map (that is, through all the clients) and send the text to each of them. The loop is organized with the </span><span class="f_Text" style="font-style: italic;">forEach</span><span class="f_Text"> method calls for an array from the map, and the next anonymous function that will be performed for each element (</span><span class="f_Text" style="font-style: italic;">elem</span><span class="f_Text">) is passed to the method in place. The example of this loop clearly demonstrates the </span><span class="f_Text" style="font-style: italic;">functional-declarative</span><span class="f_Text"> programming paradigm that prevails in JavaScript (in contrast to the </span><span class="f_Text" style="font-style: italic;">imperative</span><span class="f_Text"> approach in MQL5).</span></p>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; page-break-after: avoid; border-color: #d8dfea; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExample" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExample" style="color: #808080;">//&nbsp;JavaScript</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">client</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">on</span><span class="f_CodeExample">('</span><span class="f_CodeExample" style="color: #333333;">message</span><span class="f_CodeExample">',&nbsp;</span><span class="f_CodeExample" style="color: #333333;">function</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">message</span><span class="f_CodeExample">)</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;{</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">console</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #0000ff;">log</span><span class="f_CodeExample">('%</span><span class="f_CodeExample" style="color: #333333;">d</span><span class="f_CodeExample">&nbsp;:&nbsp;%</span><span class="f_CodeExample" style="color: #333333;">s</span><span class="f_CodeExample">',&nbsp;</span><span class="f_CodeExample" style="color: #333333;">client</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">id</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">message</span><span class="f_CodeExample">);</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">Array</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">from</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">clients</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">values</span><span class="f_CodeExample">()).</span><span class="f_CodeExample" style="color: #333333;">forEach</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">function</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">elem</span><span class="f_CodeExample">)&nbsp;</span><span class="f_CodeExample" style="color: #808080;">//&nbsp;added&nbsp;a&nbsp;loop</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">elem</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">send</span><span class="f_CodeExample">('</span><span class="f_CodeExample" style="color: #333333;">user</span><span class="f_CodeExample">'&nbsp;+&nbsp;</span><span class="f_CodeExample" style="color: #333333;">client</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">id</span><span class="f_CodeExample">&nbsp;+&nbsp;'</span><span class="f_CodeExample" style="color: #333333;">#</span><span class="f_CodeExample">'&nbsp;+&nbsp;</span><span class="f_CodeExample" style="color: #333333;">message</span><span class="f_CodeExample">);</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;});</span></p>
</td>
</tr>
</table>
</div>
<p class="p_Text"><span class="f_Text">It is important to note that we send a copy of the message to all clients, including the original author. It could be filtered out, but for debugging purposes, it's better to have confirmation that the message was sent.</span></p>
<p class="p_Text"><span class="f_Text">The last difference from the previous echo service is that when a client disconnects, it needs to be removed from the map.</span></p>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; page-break-after: avoid; border-color: #d8dfea; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExample" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExample" style="color: #808080;">//&nbsp;JavaScript</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">client</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">on</span><span class="f_CodeExample">('</span><span class="f_CodeExample" style="color: #333333;">close</span><span class="f_CodeExample">',&nbsp;</span><span class="f_CodeExample" style="color: #333333;">function</span><span class="f_CodeExample">()</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;{</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">console</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #0000ff;">log</span><span class="f_CodeExample">('</span><span class="f_CodeExample" style="color: #333333;">User</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">disconnected</span><span class="f_CodeExample">:',&nbsp;</span><span class="f_CodeExample" style="color: #333333;">client</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">id</span><span class="f_CodeExample">);</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">clients</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #0000ff;">delete</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">client</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">id</span><span class="f_CodeExample">);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #808080;">//&nbsp;added&nbsp;this&nbsp;line</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;});</span></p>
</td>
</tr>
</table>
</div>
<p class="p_Text"><span class="f_Text">Regarding the replacement of the page </span><span class="f_Text" style="font-style: italic;">index.htm</span><span class="f_Text"> by </span><span class="f_Text" style="font-style: italic;">wschat.htm</span><span class="f_Text">, here we added a &quot;field&quot; to display the author of the message (</span><span class="f_Text" style="font-style: italic;">origin</span><span class="f_Text">) and connected a new browser script </span><span class="f_Text" style="font-style: italic;">wschat_client.js</span><span class="f_Text">. It parses the messages (we use the '#' symbol to separate the author from the text) and fills in the form fields with the information received. Since nothing has changed from the point of view of the WebSocket protocol, we will not provide the source code.</span></p>
<p class="p_ImageCaption"><img class="help" alt="Chat service webpage on WebSocket" title="Chat service webpage on WebSocket" width="345" height="224" style="margin:0 auto 0 auto;width:345px;height:224px;border:none" src="wschat.png"/></p>
<p class="p_ImageCaption"><span class="f_ImageCaption">Chat service webpage on WebSocket</span></p>
<p class="p_Text"><span class="f_Text">You can start nodejs with the </span><span class="f_Text" style="font-style: italic;">wschat.js</span><span class="f_Text"> chat server and then connect to it from several browser tabs. Each connection gets a unique number displayed in the header. Text from the </span><span class="f_Text" style="font-style: italic;">Message</span><span class="f_Text"> field is sent to all clients upon the click on </span><span class="f_Text" style="font-style: italic;">Submit</span><span class="f_Text">. Then, the client forms show both the author of the message (label at the bottom left) and the text itself (field at the bottom center).</span></p>
<p class="p_Text"><span class="f_Text">So, we have made sure that the web server with web socket support is ready. Let's turn to writing the client part of the protocol in MQL5.</span></p>

</div>

</body>
</html>
