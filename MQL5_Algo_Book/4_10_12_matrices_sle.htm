<!DOCTYPE html>
<html>
  <head>
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1" />
  <title>4.10.12 Solving equations</title>
  <meta name="keywords" content="" />
  <link type="text/css" href="default.css" rel="stylesheet" />

   <script type="text/javascript" src="jquery.js"></script>
   <script type="text/javascript" src="helpman_settings.js"></script>
   <script type="text/javascript" src="helpman_topicinit.js"></script>


</head>

<body style="background-color:#FFFFFF; font-family:'Trebuchet MS',Tahoma,Arial,Helvetica,sans-serif; margin:0px;">



<table width="100%" height="49"  border="0" cellpadding="0" cellspacing="0" style="margin-top:0px; background-color:#1660af;">
  <tr>
    <td></td>
    <td valign="middle">
      <table style="margin-top:4px; margin-bottom:5px;" width="100%"  border="0" cellspacing="0" cellpadding="5">
        <tr valign="middle">
          <td class="nav">
<a class="h_m" href="index.htm">          MQL5 Programming for Traders </a> / <a class="h_m" href="part4.htm"> Part 4. Common APIs </a> / <a class="h_m" href="4_10_matrices.htm"> 4.10 Matrices and vectors </a>/ 4.10.12 Solving equations
          </td>
          <td width="70" align="right">
          <a href="4_10_11_matrices_characteristics.htm"><img style="vertical-align:middle;" src="previous.png" alt="?????" width="27" height="27" border=0></a>&nbsp;
          <a href="4_10_13_matrices_ml.htm"><img style="vertical-align:middle;" src="next.png" alt="??????" width="27" height="27" border="0"></a>
          </td>
        </tr>
      </table>
    </td>
    <td width="5"></td>
  </tr>
</table>



<div id="help">
<p class="p_H3"><span class="f_H3">4.10.12 Solving equations</span></p>
<p class="p_Text"><span class="f_Text">In machine learning methods and optimization problems, it is often required to find a solution to a system of linear equations. MQL5 contains four methods that allow solving such equations depending on the matrix type.</span></p>
<ul>
<li class="p_li"><span class="f_li" style="font-style: italic;">Solve</span><span class="f_li"> solves a linear matrix equation or a system of linear algebraic equations</span></li>
<li class="p_li"><span class="f_li" style="font-style: italic;">LstSq</span><span class="f_li"> &nbsp;solves a system of linear algebraic equations approximately (for non-square or degenerate matrices)</span></li>
<li class="p_li"><span class="f_li" style="font-style: italic;">Inv</span><span class="f_li"> calculates a multiplicative inverse matrix relative to a square non-singular matrix using the Jordan-Gauss method</span></li>
<li class="p_li"><span class="f_li" style="font-style: italic;">PInv</span><span class="f_li"> calculates the pseudo-inverse matrix by the Moore-Penrose method</span></li>
</ul>
<p class="p_Text"><span class="f_Text">Following are the method prototypes.</span></p>
<p class="p_H4"><span class="f_H4">vector&lt;T&gt; matrix&lt;T&gt;::Solve(const vector&lt;T&gt; b)</span></p>
<p class="p_H4" style="margin: 0 23px 1px 17px;"><span class="f_H4">vector&lt;T&gt; matrix&lt;T&gt;::LstSq(const vector&lt;T&gt; b)</span></p>
<p class="p_H4" style="margin: 0 23px 1px 17px;"><span class="f_H4">matrix&lt;T&gt; matrix&lt;T&gt;::Inv()</span></p>
<p class="p_H4" style="margin: 0 23px 1px 17px;"><span class="f_H4">matrix&lt;T&gt; matrix&lt;T&gt;::PInv()</span></p>
<p class="p_Text"><span class="f_Text">The </span><span class="f_Text" style="font-style: italic;">Solve</span><span class="f_Text"> and </span><span class="f_Text" style="font-style: italic;">LstSq</span><span class="f_Text"> methods imply the solution of a system of equations of the form </span><span class="f_Text" style="font-style: italic;">A*X=B</span><span class="f_Text">, where A is a matrix, B is a vector passed through a parameter with the values of the function (or &quot;dependent variable&quot;).</span></p>
<p class="p_Text"><span class="f_Text">Let's try to apply the </span><span class="f_Text" style="font-style: italic;">LstSq</span><span class="f_Text"> method to solve a system of equations, which is a model of ideal portfolio trading (in our case, we will analyze a portfolio of the main Forex currencies). To do this, on a given number of &quot;historical&quot; bars, we need to find such lot sizes for each currency, with which the balance line tends to be a constantly growing straight line.</span></p>
<p class="p_Text"><span class="f_Text">Let's denote the </span><span class="f_Text" style="font-style: italic;">i</span><span class="f_Text">-th currency pair as </span><span class="f_Text" style="font-style: italic;">S</span><span class="f_Text" style="font-size: 7pt; font-style: italic; vertical-align: sub;">i</span><span class="f_Text">. Its quote at the bar with the </span><span class="f_Text" style="font-style: italic;">k</span><span class="f_Text"> index is equal to </span><span class="f_Text" style="font-style: italic;">S</span><span class="f_Text" style="font-size: 7pt; font-style: italic; vertical-align: sub;">i</span><span class="f_Text" style="font-style: italic;">[k]</span><span class="f_Text">. The numbering of bars will go from the past to the future, as in matrices and vectors populated by the </span><span class="f_Text" style="font-style: italic;"><a href="4_10_4_matrices_copyrates.htm" class="topiclink">CopyRates</a></span><span class="f_Text"> method. Thus, the beginning of the collected quotes for training the model corresponds to the bar marked with the number 0, but on the timeline, it will be the oldest historical bar (of those that we process, according to the algorithm settings). The bars on the right (to the future) from it are numbered 1, 2, and so on, up to the total number of bars on which the user will order the calculation.</span></p>
<p class="p_Text"><span class="f_Text">A change in the price of a symbol between the 0th bar and the Nth bar determines the profit (or loss) by the time of the Nth bar.</span></p>
<p class="p_Text"><span class="f_Text">Taking into account the set of currencies, we get, for example, the following profit equation for the 1st bar:</span></p>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; page-break-after: avoid; border-color: #d8dfea; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExample" style="text-align: center; page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">S1</span><span class="f_CodeExample">[</span><span class="f_CodeExample" style="color: #333333;">1</span><span class="f_CodeExample">]&nbsp;-&nbsp;</span><span class="f_CodeExample" style="color: #333333;">S1</span><span class="f_CodeExample">[</span><span class="f_CodeExample" style="color: #333333;">0</span><span class="f_CodeExample">])&nbsp;*&nbsp;</span><span class="f_CodeExample" style="color: #333333;">X1</span><span class="f_CodeExample">&nbsp;+&nbsp;(</span><span class="f_CodeExample" style="color: #333333;">S2</span><span class="f_CodeExample">[</span><span class="f_CodeExample" style="color: #333333;">1</span><span class="f_CodeExample">]&nbsp;-&nbsp;</span><span class="f_CodeExample" style="color: #333333;">S2</span><span class="f_CodeExample">[</span><span class="f_CodeExample" style="color: #333333;">0</span><span class="f_CodeExample">])&nbsp;*&nbsp;</span><span class="f_CodeExample" style="color: #333333;">X2</span><span class="f_CodeExample">&nbsp;+&nbsp;...&nbsp;+&nbsp;(</span><span class="f_CodeExample" style="color: #333333;">Sm</span><span class="f_CodeExample">[</span><span class="f_CodeExample" style="color: #333333;">1</span><span class="f_CodeExample">]&nbsp;-&nbsp;</span><span class="f_CodeExample" style="color: #333333;">Sm</span><span class="f_CodeExample">[</span><span class="f_CodeExample" style="color: #333333;">0</span><span class="f_CodeExample">])&nbsp;*&nbsp;</span><span class="f_CodeExample" style="color: #333333;">Xm</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #333333;">B</span></p>
</td>
</tr>
</table>
</div>
<p class="p_Text"><span class="f_Text">Here </span><span class="f_Text" style="font-style: italic;">m</span><span class="f_Text"> is the total number of characters, </span><span class="f_Text" style="font-style: italic;">X</span><span class="f_Text" style="font-size: 7pt; font-style: italic; vertical-align: sub;">i</span><span class="f_Text"> is the lot size of each symbol, and </span><span class="f_Text" style="font-style: italic;">B</span><span class="f_Text"> is the floating profit (conditional balance, if you lock in the profit).</span></p>
<p class="p_Text"><span class="f_Text">For simplicity, let's shorten the notation. Let's move from absolute values to price increments (</span><span class="f_Text" style="font-style: italic;">A</span><span class="f_Text" style="font-size: 7pt; font-style: italic; vertical-align: sub;">i </span><span class="f_Text" style="font-style: italic;">[k] = S</span><span class="f_Text" style="font-size: 7pt; font-style: italic; vertical-align: sub;">i </span><span class="f_Text" style="font-style: italic;">[k]-S</span><span class="f_Text" style="font-size: 7pt; font-style: italic; vertical-align: sub;">i </span><span class="f_Text" style="font-style: italic;">[0]</span><span class="f_Text">). Taking into account the movement through bars, we will obtain several expressions for the virtual balance curve:</span></p>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; page-break-after: avoid; border-color: #d8dfea; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExample" style="text-align: center; page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExample" style="color: #333333;">A1</span><span class="f_CodeExample">[</span><span class="f_CodeExample" style="color: #333333;">1</span><span class="f_CodeExample">]&nbsp;*&nbsp;</span><span class="f_CodeExample" style="color: #333333;">X1</span><span class="f_CodeExample">&nbsp;+&nbsp;</span><span class="f_CodeExample" style="color: #333333;">A2</span><span class="f_CodeExample">[</span><span class="f_CodeExample" style="color: #333333;">1</span><span class="f_CodeExample">]&nbsp;*&nbsp;</span><span class="f_CodeExample" style="color: #333333;">X2</span><span class="f_CodeExample">&nbsp;+&nbsp;...&nbsp;+&nbsp;</span><span class="f_CodeExample" style="color: #333333;">Am</span><span class="f_CodeExample">[</span><span class="f_CodeExample" style="color: #333333;">1</span><span class="f_CodeExample">]&nbsp;*&nbsp;</span><span class="f_CodeExample" style="color: #333333;">Xm</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #333333;">B</span><span class="f_CodeExample">[</span><span class="f_CodeExample" style="color: #333333;">1</span><span class="f_CodeExample">]</span>
<br><span class="f_CodeExample" style="color: #333333;">A1</span><span class="f_CodeExample">[</span><span class="f_CodeExample" style="color: #333333;">2</span><span class="f_CodeExample">]&nbsp;*&nbsp;</span><span class="f_CodeExample" style="color: #333333;">X1</span><span class="f_CodeExample">&nbsp;+&nbsp;</span><span class="f_CodeExample" style="color: #333333;">A2</span><span class="f_CodeExample">[</span><span class="f_CodeExample" style="color: #333333;">2</span><span class="f_CodeExample">]&nbsp;*&nbsp;</span><span class="f_CodeExample" style="color: #333333;">X2</span><span class="f_CodeExample">&nbsp;+&nbsp;...&nbsp;+&nbsp;</span><span class="f_CodeExample" style="color: #333333;">Am</span><span class="f_CodeExample">[</span><span class="f_CodeExample" style="color: #333333;">2</span><span class="f_CodeExample">]&nbsp;*&nbsp;</span><span class="f_CodeExample" style="color: #333333;">Xm</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #333333;">B</span><span class="f_CodeExample">[</span><span class="f_CodeExample" style="color: #333333;">2</span><span class="f_CodeExample">]</span>
<br><span class="f_CodeExample">...</span>
<br><span class="f_CodeExample" style="color: #333333;">A1</span><span class="f_CodeExample">[</span><span class="f_CodeExample" style="color: #333333;">K</span><span class="f_CodeExample">]&nbsp;*&nbsp;</span><span class="f_CodeExample" style="color: #333333;">X1</span><span class="f_CodeExample">&nbsp;+&nbsp;</span><span class="f_CodeExample" style="color: #333333;">A2</span><span class="f_CodeExample">[</span><span class="f_CodeExample" style="color: #333333;">K</span><span class="f_CodeExample">]&nbsp;*&nbsp;</span><span class="f_CodeExample" style="color: #333333;">X2</span><span class="f_CodeExample">&nbsp;+&nbsp;...&nbsp;+&nbsp;</span><span class="f_CodeExample" style="color: #333333;">Am</span><span class="f_CodeExample">[</span><span class="f_CodeExample" style="color: #333333;">K</span><span class="f_CodeExample">]&nbsp;*&nbsp;</span><span class="f_CodeExample" style="color: #333333;">Xm</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #333333;">B</span><span class="f_CodeExample">[</span><span class="f_CodeExample" style="color: #333333;">K</span><span class="f_CodeExample">]</span></p>
</td>
</tr>
</table>
</div>
<p class="p_Text"><span class="f_Text">Successful trading is characterized by a constant profit on each bar, i.e., the model for the right-handed vector </span><span class="f_Text" style="font-style: italic;">B</span><span class="f_Text"> is a monotonically increasing function, ideally a straight line.</span></p>
<p class="p_Text"><span class="f_Text">Let's implement this model and select the </span><span class="f_Text" style="font-style: italic;">X</span><span class="f_Text"> coefficients for it based on quotes. Since we do not yet know the application APIs, we will not code a full-fledged trading strategy. Let's just build a virtual balance chart using the </span><span class="f_Text" style="font-style: italic;">GraphPlot</span><span class="f_Text"> function from the standard header file </span><span class="f_Text" style="font-style: italic;">Graphic.mqh</span><span class="f_Text"> (we have already used it to demonstrate <a href="4_4_maths.htm" class="topiclink">mathematical functions</a>).</span></p>
<p class="p_Text"><span class="f_Text">The full source code for the new example is in the script </span><span class="f_Text" style="font-style: italic;">MatrixForexBasket.mq5</span><span class="f_Text">.</span></p>
<p class="p_Text"><span class="f_Text">In the input parameters, let the user choose the total number of bars for data sampling (</span><span class="f_Text" style="font-style: italic;">BarCount</span><span class="f_Text">), as well as the bar number within this selection (</span><span class="f_Text" style="font-style: italic;">BarOffset</span><span class="f_Text">) on which the conditional past ends and the conditional future begins.</span></p>
<p class="p_Text"><span class="f_Text">A model will be built on the conditional past (the above system of linear equations will be solved), and a forward test will be performed on the conditional future.</span></p>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; page-break-after: avoid; border-color: #d8dfea; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExample" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExample" style="color: #0000ff;">input</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">int</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">BarCount</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #333333;">20</span><span class="f_CodeExample">;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #808080;">//&nbsp;BarCount&nbsp;(known&nbsp;&quot;history&quot;&nbsp;and&nbsp;&quot;future&quot;)</span>
<br><span class="f_CodeExample" style="color: #0000ff;">input</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">int</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">BarOffset</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #333333;">10</span><span class="f_CodeExample">;&nbsp;</span><span class="f_CodeExample" style="color: #808080;">//&nbsp;BarOffset&nbsp;(where&nbsp;&quot;future&quot;&nbsp;starts)</span>
<br><span class="f_CodeExample" style="color: #0000ff;">input</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">ENUM_CURVE_TYPE</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">CurveType</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #333333;">CURVE_LINES</span><span class="f_CodeExample">;</span></p>
</td>
</tr>
</table>
</div>
<p class="p_Text"><span class="f_Text">To fill the vector with an ideal balance, we write the </span><span class="f_Text" style="font-style: italic;">ConstantGrow</span><span class="f_Text"> function: it will be used later during initialization.</span></p>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; page-break-after: avoid; border-color: #d8dfea; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExample" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExample" style="color: #0000ff;">void</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">ConstantGrow</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">vector</span><span class="f_CodeExample">&nbsp;&amp;</span><span class="f_CodeExample" style="color: #333333;">v</span><span class="f_CodeExample">)</span>
<br><span class="f_CodeExample">{</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">for</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #0000ff;">ulong</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">i</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #333333;">0</span><span class="f_CodeExample">;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">i</span><span class="f_CodeExample">&nbsp;&lt;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">v</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">Size</span><span class="f_CodeExample">();&nbsp;++</span><span class="f_CodeExample" style="color: #333333;">i</span><span class="f_CodeExample">)</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;{</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">v</span><span class="f_CodeExample">[</span><span class="f_CodeExample" style="color: #333333;">i</span><span class="f_CodeExample">]&nbsp;=&nbsp;(</span><span class="f_CodeExample" style="color: #0000ff;">double</span><span class="f_CodeExample">)(</span><span class="f_CodeExample" style="color: #333333;">i</span><span class="f_CodeExample">&nbsp;+&nbsp;</span><span class="f_CodeExample" style="color: #333333;">1</span><span class="f_CodeExample">);</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;}</span>
<br><span class="f_CodeExample">}</span></p>
</td>
</tr>
</table>
</div>
<p class="p_Text"><span class="f_Text">The list of traded instruments (major Forex pairs) is hard-set at the beginning of the </span><span class="f_Text" style="font-style: italic;">OnStart</span><span class="f_Text"> function — edit it to suit your requirements and trading environment.</span></p>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; page-break-after: avoid; border-color: #d8dfea; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExample" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExample" style="color: #0000ff;">void</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">OnStart</span><span class="f_CodeExample">()</span>
<br><span class="f_CodeExample">{</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">const</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">string</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">symbols</span><span class="f_CodeExample">[]&nbsp;=</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;{</span>
<br><span class="f_CodeExample" style="color: #008080;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;EURUSD&quot;</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #008080;">&quot;GBPUSD&quot;</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #008080;">&quot;USDJPY&quot;</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #008080;">&quot;USDCAD&quot;</span><span class="f_CodeExample">,&nbsp;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #008080;">&quot;USDCHF&quot;</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #008080;">&quot;AUDUSD&quot;</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #008080;">&quot;NZDUSD&quot;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;};</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">const</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">int</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">size</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">ArraySize</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">symbols</span><span class="f_CodeExample">);</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;...</span></p>
</td>
</tr>
</table>
</div>
<p class="p_Text"><span class="f_Text">Let's create the </span><span class="f_Text" style="font-style: italic;">rates</span><span class="f_Text"> matrix in which symbol quotes will be added, the </span><span class="f_Text" style="font-style: italic;">model</span><span class="f_Text"> vector with desired balance curve, and the auxiliary </span><span class="f_Text" style="font-style: italic;">close</span><span class="f_Text"> vector for a symbol-by-symbol request for bar closing prices (the data from it will be copied into the columns of the </span><span class="f_Text" style="font-style: italic;">rates</span><span class="f_Text"> matrix).</span></p>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; page-break-after: avoid; border-color: #d8dfea; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExample" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">matrix</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">rates</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">BarCount</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">size</span><span class="f_CodeExample">);</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">vector</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">model</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">BarCount</span><span class="f_CodeExample">&nbsp;-&nbsp;</span><span class="f_CodeExample" style="color: #333333;">BarOffset</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">ConstantGrow</span><span class="f_CodeExample">);</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">vector</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">close</span><span class="f_CodeExample">;</span></p>
</td>
</tr>
</table>
</div>
<p class="p_Text"><span class="f_Text">In a symbol loop, we copy the closing prices into the </span><span class="f_Text" style="font-style: italic;">close</span><span class="f_Text"> vector, calculate price increments, and write them in the corresponding column of the </span><span class="f_Text" style="font-style: italic;">rates</span><span class="f_Text"> matrix.</span></p>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; page-break-after: avoid; border-color: #d8dfea; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExample" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">for</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #0000ff;">int</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">i</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #333333;">0</span><span class="f_CodeExample">;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">i</span><span class="f_CodeExample">&nbsp;&lt;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">size</span><span class="f_CodeExample">;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">i</span><span class="f_CodeExample">++)</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;{</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">if</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">close</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #0000ff;">CopyRates</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">symbols</span><span class="f_CodeExample">[</span><span class="f_CodeExample" style="color: #333333;">i</span><span class="f_CodeExample">],&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">_Period</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #ff0000;">COPY_RATES_CLOSE</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">0</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">BarCount</span><span class="f_CodeExample">))</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #808080;">//&nbsp;calculate&nbsp;increments&nbsp;(profit&nbsp;on&nbsp;all&nbsp;and&nbsp;on&nbsp;each&nbsp;bar&nbsp;in&nbsp;one&nbsp;line)</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">close</span><span class="f_CodeExample">&nbsp;-=&nbsp;</span><span class="f_CodeExample" style="color: #333333;">close</span><span class="f_CodeExample">[</span><span class="f_CodeExample" style="color: #333333;">0</span><span class="f_CodeExample">];</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #808080;">//&nbsp;adjust&nbsp;the&nbsp;profit&nbsp;to&nbsp;the&nbsp;pip&nbsp;value</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">close</span><span class="f_CodeExample">&nbsp;*=&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">SymbolInfoDouble</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">symbols</span><span class="f_CodeExample">[</span><span class="f_CodeExample" style="color: #333333;">i</span><span class="f_CodeExample">],&nbsp;</span><span class="f_CodeExample" style="color: #ff0000;">SYMBOL_TRADE_TICK_VALUE</span><span class="f_CodeExample">)&nbsp;/</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">SymbolInfoDouble</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">symbols</span><span class="f_CodeExample">[</span><span class="f_CodeExample" style="color: #333333;">i</span><span class="f_CodeExample">],&nbsp;</span><span class="f_CodeExample" style="color: #ff0000;">SYMBOL_TRADE_TICK_SIZE</span><span class="f_CodeExample">);</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #808080;">//&nbsp;place&nbsp;the&nbsp;vector&nbsp;in&nbsp;the&nbsp;matrix&nbsp;column</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">rates</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">Col</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">close</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">i</span><span class="f_CodeExample">);</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">else</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">Print</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #008080;">&quot;vector.CopyRates(%d,&nbsp;COPY_RATES_CLOSE)&nbsp;failed.&nbsp;Error&nbsp;&quot;</span><span class="f_CodeExample">,&nbsp;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">symbols</span><span class="f_CodeExample">[</span><span class="f_CodeExample" style="color: #333333;">i</span><span class="f_CodeExample">],&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">_LastError</span><span class="f_CodeExample">);</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">return</span><span class="f_CodeExample">;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;}</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;...</span></p>
</td>
</tr>
</table>
</div>
<p class="p_Text"><span class="f_Text">We will consider the calculation of one price point value (in the deposit currency) in Part 5.</span></p>
<p class="p_Text"><span class="f_Text">It is also important to note, that bars with the same indexes may have different timestamps on different financial instruments, for example, if there was a holiday in one of the countries and the market was closed (outside of Forex, symbols may, in theory, have different trading session schedules). To solve this problem, we would need a deeper analysis of quotes, taking into account bar times and their synchronization before inserting them into the </span><span class="f_Text" style="font-style: italic;">rates</span><span class="f_Text"> matrix. We do not do this here to maintain simplicity, and also because the Forex market operates according to the same rules most of the time.</span></p>
<p class="p_Text"><span class="f_Text">We split the matrix into two parts: the initial part will be used to find a solution (this emulates optimization on history), and the subsequent part will be used for a forward test (calculation of subsequent balance changes).</span></p>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; page-break-after: avoid; border-color: #d8dfea; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExample" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">matrix</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">split</span><span class="f_CodeExample">[];</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">if</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">BarOffset</span><span class="f_CodeExample">&nbsp;&gt;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">0</span><span class="f_CodeExample">)</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;{</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #808080;">//&nbsp;training&nbsp;on&nbsp;BarCount&nbsp;-&nbsp;BarOffset&nbsp;bars</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #808080;">//&nbsp;check&nbsp;on&nbsp;BarOffset&nbsp;bars</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">ulong</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">parts</span><span class="f_CodeExample">[]&nbsp;=&nbsp;{</span><span class="f_CodeExample" style="color: #333333;">BarCount</span><span class="f_CodeExample">&nbsp;-&nbsp;</span><span class="f_CodeExample" style="color: #333333;">BarOffset</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">BarOffset</span><span class="f_CodeExample">};</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">rates</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">Split</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">parts</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">0</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">split</span><span class="f_CodeExample">);</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;}</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #808080;">//&nbsp;solve&nbsp;the&nbsp;system&nbsp;of&nbsp;linear&nbsp;equations&nbsp;for&nbsp;the&nbsp;model</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">vector</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">x</span><span class="f_CodeExample">&nbsp;=&nbsp;(</span><span class="f_CodeExample" style="color: #333333;">BarOffset</span><span class="f_CodeExample">&nbsp;&gt;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">0</span><span class="f_CodeExample">)&nbsp;?&nbsp;</span><span class="f_CodeExample" style="color: #333333;">split</span><span class="f_CodeExample">[</span><span class="f_CodeExample" style="color: #333333;">0</span><span class="f_CodeExample">].</span><span class="f_CodeExample" style="color: #333333;">LstSq</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">model</span><span class="f_CodeExample">)&nbsp;:&nbsp;</span><span class="f_CodeExample" style="color: #333333;">rates</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">LstSq</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">model</span><span class="f_CodeExample">);</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">Print</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #008080;">&quot;Solution&nbsp;(lots&nbsp;per&nbsp;symbol):&nbsp;&quot;</span><span class="f_CodeExample">);</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">Print</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">x</span><span class="f_CodeExample">);</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;...</span></p>
</td>
</tr>
</table>
</div>
<p class="p_Text"><span class="f_Text">Now, when we have a solution, let's build the balance curve for all bars of the sample (the ideal &quot;historical&quot; part will be at the beginning, and then the &quot;future&quot; part will begin, which was not used to adjust the model).</span></p>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; page-break-after: avoid; border-color: #d8dfea; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExample" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">vector</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">balance</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #333333;">vector</span><span class="f_CodeExample">::</span><span class="f_CodeExample" style="color: #333333;">Zeros</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">BarCount</span><span class="f_CodeExample">);</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">for</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #0000ff;">int</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">i</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #333333;">1</span><span class="f_CodeExample">;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">i</span><span class="f_CodeExample">&nbsp;&lt;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">BarCount</span><span class="f_CodeExample">;&nbsp;++</span><span class="f_CodeExample" style="color: #333333;">i</span><span class="f_CodeExample">)</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;{</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">balance</span><span class="f_CodeExample">[</span><span class="f_CodeExample" style="color: #333333;">i</span><span class="f_CodeExample">]&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #333333;">0</span><span class="f_CodeExample">;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">for</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #0000ff;">int</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">j</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #333333;">0</span><span class="f_CodeExample">;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">j</span><span class="f_CodeExample">&nbsp;&lt;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">size</span><span class="f_CodeExample">;&nbsp;++</span><span class="f_CodeExample" style="color: #333333;">j</span><span class="f_CodeExample">)</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">balance</span><span class="f_CodeExample">[</span><span class="f_CodeExample" style="color: #333333;">i</span><span class="f_CodeExample">]&nbsp;+=&nbsp;(</span><span class="f_CodeExample" style="color: #0000ff;">float</span><span class="f_CodeExample">)(</span><span class="f_CodeExample" style="color: #333333;">rates</span><span class="f_CodeExample">[</span><span class="f_CodeExample" style="color: #333333;">i</span><span class="f_CodeExample">][</span><span class="f_CodeExample" style="color: #333333;">j</span><span class="f_CodeExample">]&nbsp;*&nbsp;</span><span class="f_CodeExample" style="color: #333333;">x</span><span class="f_CodeExample">[</span><span class="f_CodeExample" style="color: #333333;">j</span><span class="f_CodeExample">]);</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;}</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;...</span></p>
</td>
</tr>
</table>
</div>
<p class="p_Text"><span class="f_Text">Let's estimate the quality of the solution by the R2 criterion.</span></p>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; page-break-after: avoid; border-color: #d8dfea; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExample" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">if</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">BarOffset</span><span class="f_CodeExample">&nbsp;&gt;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">0</span><span class="f_CodeExample">)</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;{</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #808080;">//&nbsp;make&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;balance</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">vector</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">backtest</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #333333;">balance</span><span class="f_CodeExample">;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #808080;">//&nbsp;select&nbsp;only&nbsp;&quot;historical&quot;&nbsp;bars&nbsp;for&nbsp;backtesting</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">backtest</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">Resize</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">BarCount</span><span class="f_CodeExample">&nbsp;-&nbsp;</span><span class="f_CodeExample" style="color: #333333;">BarOffset</span><span class="f_CodeExample">);</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #808080;">//&nbsp;bars&nbsp;for&nbsp;the&nbsp;forward&nbsp;test&nbsp;have&nbsp;to&nbsp;be&nbsp;copied&nbsp;manually</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">vector</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">forward</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">BarOffset</span><span class="f_CodeExample">);</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">for</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #0000ff;">int</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">i</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #333333;">0</span><span class="f_CodeExample">;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">i</span><span class="f_CodeExample">&nbsp;&lt;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">BarOffset</span><span class="f_CodeExample">;&nbsp;++</span><span class="f_CodeExample" style="color: #333333;">i</span><span class="f_CodeExample">)</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">forward</span><span class="f_CodeExample">[</span><span class="f_CodeExample" style="color: #333333;">i</span><span class="f_CodeExample">]&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #333333;">balance</span><span class="f_CodeExample">[</span><span class="f_CodeExample" style="color: #333333;">BarCount</span><span class="f_CodeExample">&nbsp;-&nbsp;</span><span class="f_CodeExample" style="color: #333333;">BarOffset</span><span class="f_CodeExample">&nbsp;+&nbsp;</span><span class="f_CodeExample" style="color: #333333;">i</span><span class="f_CodeExample">];</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #808080;">//&nbsp;compute&nbsp;regression&nbsp;metrics&nbsp;independently&nbsp;for&nbsp;both&nbsp;parts</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">Print</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #008080;">&quot;Backtest&nbsp;R2&nbsp;=&nbsp;&quot;</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">backtest</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">RegressionMetric</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #ff0000;">REGRESSION_R2</span><span class="f_CodeExample">));</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">Print</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #008080;">&quot;Forward&nbsp;R2&nbsp;=&nbsp;&quot;</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">forward</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">RegressionMetric</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #ff0000;">REGRESSION_R2</span><span class="f_CodeExample">));</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;}</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">else</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;{</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">Print</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #008080;">&quot;R2&nbsp;=&nbsp;&quot;</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">balance</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">RegressionMetric</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #ff0000;">REGRESSION_R2</span><span class="f_CodeExample">));</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;}</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;...</span></p>
</td>
</tr>
</table>
</div>
<p class="p_Text"><span class="f_Text">To display the balance curve on a chart, you need to transfer data from a vector to an array.</span></p>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; page-break-after: avoid; border-color: #d8dfea; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExample" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">double</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">array</span><span class="f_CodeExample">[];</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">balance</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">Swap</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">array</span><span class="f_CodeExample">);</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #808080;">//&nbsp;print&nbsp;the&nbsp;values&nbsp;of&nbsp;the&nbsp;changing&nbsp;balance&nbsp;with&nbsp;an&nbsp;accuracy&nbsp;of&nbsp;2&nbsp;digits</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">Print</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #008080;">&quot;Balance:&nbsp;&quot;</span><span class="f_CodeExample">);</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">ArrayPrint</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">array</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">2</span><span class="f_CodeExample">);</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #808080;">//&nbsp;draw&nbsp;the&nbsp;balance&nbsp;curve&nbsp;in&nbsp;the&nbsp;chart&nbsp;object&nbsp;(&quot;backtest&quot;&nbsp;and&nbsp;&quot;forward&quot;)</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">GraphPlot</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">array</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">CurveType</span><span class="f_CodeExample">);</span>
<br><span class="f_CodeExample">}</span></p>
</td>
</tr>
</table>
</div>
<p class="p_Text"><span class="f_Text">Here is an example of a log obtained by running the script on EURUSD,H1.</span></p>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; page-break-after: avoid; border-color: #d8dfea; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExample" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExample">Solution&nbsp;(lots&nbsp;per&nbsp;symbol):&nbsp;</span>
<br><span class="f_CodeExample">[-0.0057809334,-0.0079846876,0.0088985749,-0.0041461736,-0.010710154,-0.0025694175,0.01493552]</span>
<br><span class="f_CodeExample">Backtest&nbsp;R2&nbsp;=&nbsp;0.9896645616246145</span>
<br><span class="f_CodeExample">Forward&nbsp;R2&nbsp;=&nbsp;0.8667852183780984</span>
<br><span class="f_CodeExample">Balance:&nbsp;</span>
<br><span class="f_CodeExample">&nbsp;0.00&nbsp;&nbsp;1.68&nbsp;&nbsp;3.38&nbsp;&nbsp;3.90&nbsp;&nbsp;5.04&nbsp;&nbsp;5.92&nbsp;&nbsp;7.09&nbsp;&nbsp;7.86&nbsp;&nbsp;9.17&nbsp;&nbsp;9.88&nbsp;</span>
<br><span class="f_CodeExample">&nbsp;9.55&nbsp;10.77&nbsp;12.06&nbsp;13.67&nbsp;15.35&nbsp;15.89&nbsp;16.28&nbsp;15.91&nbsp;16.85&nbsp;16.58</span></p>
</td>
</tr>
</table>
</div>
<p class="p_Text"><span class="f_Text">And here is what the virtual balance curve looks like.</span></p>
<p class="p_ImageCaption"><img class="help" alt="Virtual balance of trading in a basket of currencies by lots according to the decision of the SLAU(where &quot;future&quot; starts)" title="Virtual balance of trading in a basket of currencies by lots according to the decision of the SLAU(where &quot;future&quot; starts)" width="600" height="400" style="margin:0 auto 0 auto;width:600px;height:400px;border:none" src="eurusdh1-sle20.png"/></p>
<p class="p_ImageCaption"><span class="f_ImageCaption">Virtual balance of trading a portfolio of currencies by lots according to the &nbsp;decision</span></p>
<p class="p_Text"><span class="f_Text">The left half has a more even shape and a higher R2, which is not surprising because the model (</span><span class="f_Text" style="font-style: italic;">X</span><span class="f_Text"> variables) was adjusted specifically for it.</span></p>
<p class="p_Text"><span class="f_Text">Just out of interest, we will increase the depth of training and verification by 10 times, that is, we will set in the parameters </span><span class="f_Text" style="font-style: italic;">BarCount = 200</span><span class="f_Text"> and </span><span class="f_Text" style="font-style: italic;">BarOffset = 100</span><span class="f_Text">. We will get a new picture.</span></p>
<p class="p_ImageCaption"><img class="help" alt="Virtual balance of trading in a basket of currencies by lots according to the decision of the SLAU(where &quot;future&quot; starts)" title="Virtual balance of trading in a basket of currencies by lots according to the decision of the SLAU(where &quot;future&quot; starts)" width="600" height="400" style="margin:0 auto 0 auto;width:600px;height:400px;border:none" src="eurusdh1-sle200.png"/></p>
<p class="p_ImageCaption"><span class="f_ImageCaption">Virtual balance of trading a portfolio of currencies by lots according to the decision</span></p>
<p class="p_Text"><span class="f_Text">The &quot;future&quot; part looks less smooth, and we can even say that we are lucky that it continues to grow, despite such a simple model. As a rule, during the forward test, the virtual balance curve significantly degrades and starts to go down.</span></p>
<p class="p_Text"><span class="f_Text">It is important to note that to test the model, we took the obtained </span><span class="f_Text" style="font-style: italic;">X</span><span class="f_Text"> values from the &quot;as is&quot; solution of the system, while in practice we will need to normalize them to the minimum lots and lot step, which will negatively affect the results and bring them closer to reality.</span></p>

</div>

</body>
</html>
