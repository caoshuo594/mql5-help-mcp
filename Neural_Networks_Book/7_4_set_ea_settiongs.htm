<!DOCTYPE html>
<html>
  <head>
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1" />
  <title>7.4 Determining Expert Advisor parameters</title>
  <meta name="keywords" content="" />
  <link type="text/css" href="default.css" rel="stylesheet" />

   <script type="text/javascript" src="jquery.js"></script>
   <script type="text/javascript" src="helpman_settings.js"></script>
   <script type="text/javascript" src="helpman_topicinit.js"></script>


</head>

<body style="background-color:#FFFFFF; font-family:'Trebuchet MS',Tahoma,Arial,Helvetica,sans-serif; margin:0px;">



<table width="100%" height="49"  border="0" cellpadding="0" cellspacing="0" style="margin-top:0px; background-color:#1660af;">
  <tr>
    <td></td>
    <td valign="middle">
      <table style="margin-top:4px; margin-bottom:5px;" width="100%"  border="0" cellspacing="0" cellpadding="5">
        <tr valign="middle">
          <td class="nav">
<a class="h_m" href="index.htm">          Neural Networks for Algorithmic Trading with MQL5 </a> / <a class="h_m" href="7_trade_check.htm"> 7. Testing trading capabilities of the model </a>/ 7.4 Determining Expert Advisor parameters
          </td>
          <td width="70" align="right">
          <a href="7_3_tester_model.htm"><img style="vertical-align:middle;" src="previous.png" alt="?????" width="27" height="27" border=0></a>&nbsp;
          <a href="7_5_forward_testing.htm"><img style="vertical-align:middle;" src="next.png" alt="??????" width="27" height="27" border="0"></a>
          </td>
        </tr>
      </table>
    </td>
    <td width="5"></td>
  </tr>
</table>



<div id="help">
<p class="p_H2"><span class="f_H2">7.4 Determining Expert Advisor parameters</span></p>
<p class="p_Text"><span class="f_Text">After we have trained the model, before running it in the trading strategy, we need to learn how to use it. First and foremost, we need to understand its signals. As you know, after the feed-forward pass, our model returns two values:</span></p>
<ul style="list-style-type:disc">
<li class="p_li"><span class="f_li">The probable direction of movement (the absolute value shows the probability of movement, and the sign shows the direction).</span></li>
<li class="p_li"><span class="f_li">The expected strength of movement (the absolute value shows the force of motion, and the sign shows the direction).</span></li>
</ul>
<p class="p_Text"><span class="f_Text">For each parameter, you need to find the decision threshold. A too-high value can filter out a large number of profitable trades or not provide any signals for trading operations at all. A too-small value can lead to a large number of false signals and even make trading unprofitable. Therefore, it is now very important to find the optimal parameters of the Expert Advisor to work with our trained model.</span></p>
<p class="p_Text"><span class="f_Text">The best tool to do this is the </span><span class="f_Text" style="font-style: italic;">MetaTrader 5</span><span class="f_Text"> strategy tester. In the terminal, press </span><span class="f_Text" style="font-style: italic;">Ctrl + R</span><span class="f_Text"> and navigate to the tester. In the </span><span class="f_Text" style="font-style: italic;">Settings</span><span class="f_Text"> tab, in the </span><span class="f_Text" style="font-style: italic;">Expert</span><span class="f_Text"> field, select our Expert Advisor and set the testing parameters.</span></p>
<p class="p_Text"><span class="f_Text">We trained the model on </span><span class="f_Text" style="font-style: italic;">EURUSD</span><span class="f_Text"> historical data from 2015 to 2020 on the M5 timeframe. We will use the same historical data to determine the optimal parameters of the Expert Advisor. According to the general neural network training rule, the performance of the model should be verified on a validation dataset. However, in this case, we simply determine the optimal parameters for the Expert Advisor when the model is running on the training dataset.</span></p>
<p class="p_Text"><span class="f_Text">We know that our Expert Advisor analyzes entry points only at the opening of the candlestick, so to check the presence of signals from the model, it would be possible to test only at the opening prices. However, we also need to understand the quality of these signals. At the same time, we want to conduct the initial rough selection of parameters with minimal time and resources. Therefore, let's choose the testing mode based on the control points of the M1 timeframe.</span></p>
<p class="p_Text"><span class="f_Text">We need to optimize the parameters, so we choose the optimization mode. To select the optimization mode, it's desirable to know the number of upcoming iterations. Counting them requires no effort, as they are automatically calculated when selecting Expert Advisor parameters for optimization. Let's go to the parameters tab and set the initial values of the parameters in the </span><span class="f_Text" style="font-style: italic;">Value</span><span class="f_Text"> column. I would like to point out that parameters such as the model file name and the number of candles in the current pattern are not optimized because they should match the model being used.</span></p>
<div class="p_Text" style="text-align: center;"><div style="margin:0 auto 0 auto;width:568px"><img class="help" alt="Optimization of Expert Advisor parameters" title="Optimization of Expert Advisor parameters" width="568" height="263" style="width:568px;height:263px;border:none" src="tester1.png"/><p style="text-align:center"><span class="f_ImageCaption">Optimization of Expert Advisor parameters</span></p></div></div>
<p class="p_Text"><span class="f_Text">In the first stage, we will roughly optimize only one parameter: the </span><span class="f_Text" style="font-style: italic;">TradeLevel</span><span class="f_Text"> decision-making threshold. Select the checkbox of this parameter. At the output of our model, we used the hyperbolic tangent (</span><span class="f_Text" style="font-style: italic;">tanh</span><span class="f_Text">) as the activation function. Therefore, the output values of neurons are normalized in the range from &#8722;1 to 1. The sign shows the direction of movement. This means that the decision-making level can be in the range from 0 to 1. Obviously, making trades with a probability of making a profit of less than 50% looks risky, to say the least. Therefore, let's try to choose the level of decision-making in the range from 0.5 to 1.0. Recall that this is the first and rough selection of the parameter, so we will use step 0.05. The strategy tester immediately counted 11 iterations for us. As you can see, there are quite a few of them. Let's go back to the </span><span class="f_Text" style="font-style: italic;">Settings</span><span class="f_Text"> tab and select the </span><span class="f_Text" style="font-style: italic;">Slow complete algorithm</span><span class="f_Text"> optimization type. We also select optimization for the maximum balance and start the optimization process by clicking on the </span><span class="f_Text" style="font-style: italic;">Start</span><span class="f_Text"> button.</span></p>
<div class="p_Text" style="text-align: center;"><div style="margin:0 auto 0 auto;width:568px"><img class="help" alt="Optimization of Expert Advisor parameters" title="Optimization of Expert Advisor parameters" width="568" height="245" style="width:568px;height:245px;border:none" src="tester2.png"/><p style="text-align:center"><span class="f_ImageCaption">Optimization of Expert Advisor parameters</span></p></div></div>
<p class="p_Text"><span class="f_Text">The screenshot below shows the optimization results. As you can see, with a decision threshold of 0.65 or higher, the Expert Advisor does not execute any trades. From this, we can conclude that during the training process, our neural network did not identify patterns with a probability of one-directional movement equal to or greater than 65%. You should not be alarmed by the loss incurred by the Expert Advisor at this stage, as we have only conducted preliminary rough optimization with a crude determination of the decision-making level. Next, we have to optimize a few more parameters of our Expert Advisor.</span></p>
<div class="p_Text" style="text-align: center;"><div style="margin:0 auto 0 auto;width:568px"><img class="help" alt="Results of the first optimization" title="Results of the first optimization" width="568" height="245" style="width:568px;height:245px;border:none" src="tester3.png"/><p style="text-align:center"><span class="f_ImageCaption">Results of the first optimization</span></p></div></div>
<div class="p_Text" style="text-align: center;"><div style="margin:0 auto 0 auto;width:519px"><img class="help" alt="Results of the first optimization" title="Results of the first optimization" width="519" height="304" style="width:519px;height:304px;border:none" src="tester4.png"/><p style="text-align:center"><span class="f_ImageCaption">Results of the first optimization</span></p></div></div>
<p class="p_Text"><span class="f_Text">First, let's try to optimize the parameter of the minimum strength of the upcoming movement </span><span class="f_Text" style="font-style: italic;">MinTarget</span><span class="f_Text"> in order to filter out minor fluctuations. The goal of this iteration is to select the strongest movements. This is because the probability of such patterns triggering in practice is higher, and minor fluctuations may not have enough momentum to reach the target or may not trigger at all. Moreover, using orders with a low level of profitability reduces the risk-reward ratio.</span></p>
<p class="p_Text"><span class="f_Text">We will optimize the parameter in the range from 50 to 600 points in increments of 50 points. In this iteration, we need to check 12 runs of the Expert Advisor.</span></p>
<div class="p_Text" style="text-align: center;"><div style="margin:0 auto 0 auto;width:568px"><img class="help" alt="Selection of the threshold value of decision-making" title="Selection of the threshold value of decision-making" width="568" height="244" style="width:568px;height:244px;border:none" src="tester5.png"/><p style="text-align:center"><span class="f_ImageCaption">Selection of the threshold value of decision-making</span></p></div></div>
<p class="p_Text"><span class="f_Text">Based on the results of this parameter optimization, we can observe the emergence of the first profitable runs with a decision level of 500 and 600 points. However, with such parameter choices, the number of completed trading operations significantly decreases. Indeed, we want to extract the maximum potential from our model. It seems that values of the decision-making threshold around 350-400 pips are the most promising, with a trade count exceeding 1000 and being closest to the breakeven point. Let's take a small gamble and continue optimizing the parameters with the specified parameter range.</span></p>
<div class="p_Text" style="text-align: center;"><div style="margin:0 auto 0 auto;width:568px"><img class="help" alt="Results of Decision Threshold Optimization" title="Results of Decision Threshold Optimization" width="568" height="265" style="width:568px;height:265px;border:none" src="tester6.png"/><p style="text-align:center"><span class="f_ImageCaption">Results of Decision Threshold Optimization</span></p></div></div>
<p class="p_Text"><span class="f_Text">Next, let's move on to optimizing the stop-loss parameter, which limits the risks for each trade. We will optimize this parameter in the range from 50 to 500 pips with a step size of 50 pips.</span></p>
<p class="p_Text"><span class="f_Text">As mentioned above, we have not defined a clear value for the </span><span class="f_Text" style="font-style: italic;">MinTarget</span><span class="f_Text"> parameter. Therefore, for the current optimization process, we will use two optimized parameters. At the same time, the parameter for the forecast strength threshold of the upcoming impulse will only take two permissible values.</span></p>
<div class="p_Text" style="text-align: center;"><div style="margin:0 auto 0 auto;width:568px"><img class="help" alt="Results of Decision Threshold Optimization" title="Results of Decision Threshold Optimization" width="568" height="228" style="width:568px;height:228px;border:none" src="tester7.png"/><p style="text-align:center"><span class="f_ImageCaption">Results of Decision Threshold Optimization</span></p></div></div>
<p class="p_Text"><span class="f_Text">Thus, the strategy tester counted 20 passes of the current optimization process.</span></p>
<p class="p_Text"><span class="f_Text">It is worth noting one more circumstance. In the upcoming optimization process, we are going to find the optimal stop-loss level. Here, it should be noted that in real trading, stop-loss and take-profit levels are handled by the broker on each tick. To get loss values as close as possible to real levels when the stop-loss is triggered, it will be necessary to optimize with each tick processed. Therefore, we go to the </span><span class="f_Text" style="font-style: italic;">Settings</span><span class="f_Text"> tab and change the simulation mode to </span><span class="f_Text" style="font-style: italic;">Every tick based on real ticks</span><span class="f_Text">, which will switch the strategy tester to the mode of processing real historical ticks. We will also change the optimization mode to </span><span class="f_Text" style="font-style: italic;">Fast genetic based algorithm.</span><span class="f_Text"> This will allow the tester to filter out passes whose results will be significantly worse than those already conducted.</span></p>
<div class="p_Text" style="text-align: center;"><div style="margin:0 auto 0 auto;width:568px"><img class="help" alt="Optimization of stop-loss parameters" title="Optimization of stop-loss parameters" width="568" height="243" style="width:568px;height:243px;border:none" src="tester8.png"/><p style="text-align:center"><span class="f_ImageCaption">Optimization of stop-loss parameters</span></p></div></div>
<div class="p_Text" style="text-align: center;"><div style="margin:0 auto 0 auto;width:568px"><img class="help" alt="Optimization of stop-loss parameters" title="Optimization of stop-loss parameters" width="568" height="256" style="width:568px;height:256px;border:none" src="tester9.png"/><p style="text-align:center"><span class="f_ImageCaption">Optimization of stop-loss parameters</span></p></div></div>
<p class="p_Text"><span class="f_Text">As a result of optimizing the parameters, unfortunately, we still do not see any profitable passes. However, there is a clear superiority of a larger decision-making parameter based on the strength of the upcoming </span><span class="f_Text" style="font-style: italic;">MinTarget</span><span class="f_Text"> momentum. At the same time, fairly close results were obtained for three stop-loss levels in the range of 300-400 points.</span></p>
<p class="p_Text"><span class="f_Text">Thus, for further optimization of parameters, we take </span><span class="f_Text" style="font-style: italic;">MinTarget </span><span class="f_Text">at the level of 400 points, and we will continue optimizing the stop loss in the range of 300-400 points.</span></p>
<div class="p_Text" style="text-align: center;"><div style="margin:0 auto 0 auto;width:568px"><img class="help" alt="Stop-loss selection results" title="Stop-loss selection results" width="568" height="285" style="width:568px;height:285px;border:none" src="tester10.png"/><p style="text-align:center"><span class="f_ImageCaption">Stop-loss selection results</span></p></div></div>
<div class="p_Text" style="text-align: center;"><div style="margin:0 auto 0 auto;width:568px"><img class="help" alt="Stop-loss selection results" title="Stop-loss selection results" width="568" height="232" style="width:568px;height:232px;border:none" src="tester11.png"/><p style="text-align:center"><span class="f_ImageCaption">Stop-loss selection results</span></p></div></div>
<p class="p_Text"><span class="f_Text">The next parameter to be optimized is the coefficient of confidence in the predicted strength of the expected momentum. This is the coefficient by which we will multiply the value of the second parameter returned by our model when calculating the take profit for the opened position. We will not overestimate the expected momentum value. Therefore, the upper limit of parameter optimization will be equal to one. We will set the lower limit of optimization at the level of 0.5, which is equivalent to 50% of the predicted momentum. With a step of 0.05, we get 11 optimization passes. Multiplying this number by 3 stop-loss options, we will get 33 passes of the upcoming parameter optimization.</span></p>
<div class="p_Text" style="text-align: center;"><div style="margin:0 auto 0 auto;width:568px"><img class="help" alt="Optimization of the confidence factor" title="Optimization of the confidence factor" width="568" height="245" style="width:568px;height:245px;border:none" src="tester12.png"/><p style="text-align:center"><span class="f_ImageCaption">Optimization of the confidence factor</span></p></div></div>
<p class="p_Text"><span class="f_Text">As a result of optimization, we make a clear choice of a stop loss parameter at the level of 400 points and a confidence coefficient at the level of 0.8.</span></p>
<div class="p_Text" style="text-align: center;"><div style="margin:0 auto 0 auto;width:568px"><img class="help" alt="Results of Confidence Factor Optimization" title="Results of Confidence Factor Optimization" width="568" height="204" style="width:568px;height:204px;border:none" src="tester13.png"/><p style="text-align:center"><span class="f_ImageCaption">Results of Confidence Factor Optimization</span></p></div></div>
<div class="p_Text" style="text-align: center;"><div style="margin:0 auto 0 auto;width:568px"><img class="help" alt="Results of Confidence Factor Optimization" title="Results of Confidence Factor Optimization" width="568" height="228" style="width:568px;height:228px;border:none" src="tester14.png"/><p style="text-align:center"><span class="f_ImageCaption">Results of Confidence Factor Optimization</span></p></div></div>
<p class="p_Text"><span class="f_Text">Unfortunately, we must admit the failure of our endeavor. We never got a profitable combination of parameters. Let's go back to the </span><span class="f_Text" style="font-style: italic;">MinTarget</span><span class="f_Text"> parameter expressing the threshold decision-making value based on the strength of the predicted momentum. During the previous optimization of this parameter, we got the maximum profit at the level of 500 points. Let's conduct a small re-optimization of this parameter in the range from 400 to 500 points with a step of 50 points.</span></p>
<div class="p_Text" style="text-align: center;"><div style="margin:0 auto 0 auto;width:568px"><img class="help" alt="Re-optimization of the decision-making parameter" title="Re-optimization of the decision-making parameter" width="568" height="243" style="width:568px;height:243px;border:none" src="tester15.png"/><p style="text-align:center"><span class="f_ImageCaption">Re-optimization of the decision-making parameter</span></p></div></div>
<p class="p_Text"><span class="f_Text">As a result of optimization, we get a profitable combination of parameters at the level of 500 points. I must say that the level of profit received is almost twice as much as previously received. At the same time, the number of trading operations decreased, while the profit factor remained at the level of 1.22.</span></p>
<div class="p_Text" style="text-align: center;"><div style="margin:0 auto 0 auto;width:568px"><img class="help" alt="Results of optimization of the decision-making parameter" title="Results of optimization of the decision-making parameter" width="568" height="85" style="width:568px;height:85px;border:none" src="tester16.png"/><p style="text-align:center"><span class="f_ImageCaption">Results of optimization of the decision-making parameter</span></p></div></div>
<div class="p_Text" style="text-align: center;"><div style="margin:0 auto 0 auto;width:568px"><img class="help" alt="Optimization of the profitability constraint parameter" title="Optimization of the profitability constraint parameter" width="568" height="243" style="width:568px;height:243px;border:none" src="tester17.png"/><p style="text-align:center"><span class="f_ImageCaption">Optimization of the profitability constraint parameter</span></p></div></div>
<p class="p_Text"><span class="f_Text">Next, we optimize the </span><span class="f_Text" style="font-style: italic;">MaxTP</span><span class="f_Text"> parameter indicating the maximum take profit limit. This parameter will act as a safeguard against inflated expectations. If the model predicts an exaggerated movement with new values, the Expert Advisor will limit the take profit level to this value, which we will determine from the statistics of the training dataset. We optimize the value of the </span><span class="f_Text" style="font-style: italic;">MaxTP</span><span class="f_Text"> parameter in the range from 300 to 900 points in increments of 100 points.</span></p>
<p class="p_Text"><span class="f_Text">Based on the optimization results, it can be noticed that when the parameter is increased beyond 600, the performance of the Expert Advisor does not change. Consequently, the level of expected movement does not exceed 600 points for the entire training sample. Therefore, we can safely limit the maximum profit level to 600 points.</span></p>
<div class="p_Text" style="text-align: center;"><div style="margin:0 auto 0 auto;width:568px"><img class="help" alt="Results of optimization of the profitability constraint parameter" title="Results of optimization of the profitability constraint parameter" width="568" height="165" style="width:568px;height:165px;border:none" src="tester18.png"/><p style="text-align:center"><span class="f_ImageCaption">Results of optimization of the profitability constraint parameter</span></p></div></div>
<div class="p_Text" style="text-align: center;"><div style="margin:0 auto 0 auto;width:568px"><img class="help" alt="Results of optimization of the profitability constraint parameter" title="Results of optimization of the profitability constraint parameter" width="568" height="227" style="width:568px;height:227px;border:none" src="tester19.png"/><p style="text-align:center"><span class="f_ImageCaption">Results of optimization of the profitability constraint parameter</span></p></div></div>
<div class="p_Text" style="text-align: center;"><div style="margin:0 auto 0 auto;width:568px"><img class="help" alt="Fine-tuning the decision-making parameter" title="Fine-tuning the decision-making parameter" width="568" height="245" style="width:568px;height:245px;border:none" src="tester20.png"/><p style="text-align:center"><span class="f_ImageCaption">Fine-tuning the decision-making parameter</span></p></div></div>
<p class="p_Text"><span class="f_Text">Finally, we will fine-tune the decision-making parameter based on the movement probability level </span><span class="f_Text" style="font-style: italic;">TradeLevel</span><span class="f_Text">. Earlier, we conducted a rough optimization of this parameter with a step of 0.05 and settled on a level of 0.6. Now we will try to optimize the parameter with a step of 0.01 in the vicinity of the previously chosen level. Thus, we will optimize the parameter in the range of 0.56–0.64.</span></p>
<p class="p_Text"><span class="f_Text">Strangely enough, the optimization we conducted only confirmed the correctness of the previously chosen decision-making parameter value at the level of 0.6. Any deviation of the parameter from this value has a negative impact on the profitability of our Expert Advisor.</span></p>
<div class="p_Text" style="text-align: center;"><div style="margin:0 auto 0 auto;width:568px"><img class="help" alt="Results of fine-tuning the decision-making parameter" title="Results of fine-tuning the decision-making parameter" width="568" height="205" style="width:568px;height:205px;border:none" src="tester21.png"/><p style="text-align:center"><span class="f_ImageCaption">Results of fine-tuning the decision-making parameter</span></p></div></div>
<div class="p_Text" style="text-align: center;"><div style="margin:0 auto 0 auto;width:568px"><img class="help" alt="Results of fine-tuning the decision-making parameter" title="Results of fine-tuning the decision-making parameter" width="568" height="229" style="width:568px;height:229px;border:none" src="tester22.png"/><p style="text-align:center"><span class="f_ImageCaption">Results of fine-tuning the decision-making parameter</span></p></div></div>
<p class="p_Text"><span class="f_Text">So, as a result of the optimization work, we have the following set of parameters that allow for profitability on the training dataset.</span></p>
<p class="p_Text"><span class="f_Text">It should be noted that to determine the optimal set of parameters, we went through quite a few iterations of their optimization. At the same time, the </span><span class="f_Text" style="font-style: italic;">MetaTrader 5</span><span class="f_Text"> strategy tester allows you to optimize any number of parameters in one run of the optimization process. However, you will have to pay for it with time and computing resources. If we calculate the total number of passes made for all iterations of optimization, we get about 95 passes. If we were to run simultaneous optimization of all the parameters mentioned above, the total number of possible parameter combinations for conducting passes would exceed 100,000. One can hope for a reduction in the number of passes through the use of genetic algorithms, but still, their number will significantly exceed what we've conducted. Consequently, it will take much more time to optimize the parameters.</span></p>
<div class="p_Text" style="text-align: center;"><div style="margin:0 auto 0 auto;width:570px"><img class="help" alt="A set of optimized parameters" title="A set of optimized parameters" width="570" height="230" style="width:570px;height:230px;border:none" src="forward_testing2.png"/><p style="text-align:center"><span class="f_ImageCaption">A set of optimized parameters</span></p></div></div>
<p class="p_Text"><span class="f_Text">Now, after determining the optimal set of parameters, let's test the model's performance on new data. </span></p>

</div>

</body>
</html>
