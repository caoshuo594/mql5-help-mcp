<!DOCTYPE html>
<html>
  <head>
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1" />
  <title>4.2.3 Organizing parallel computing in the LSTM block</title>
  <meta name="keywords" content="" />
  <link type="text/css" href="default.css" rel="stylesheet" />

   <script type="text/javascript" src="jquery.js"></script>
   <script type="text/javascript" src="helpman_settings.js"></script>
   <script type="text/javascript" src="helpman_topicinit.js"></script>


</head>

<body style="background-color:#FFFFFF; font-family:'Trebuchet MS',Tahoma,Arial,Helvetica,sans-serif; margin:0px;">



<table width="100%" height="49"  border="0" cellpadding="0" cellspacing="0" style="margin-top:0px; background-color:#1660af;">
  <tr>
    <td></td>
    <td valign="middle">
      <table style="margin-top:4px; margin-bottom:5px;" width="100%"  border="0" cellspacing="0" cellpadding="5">
        <tr valign="middle">
          <td class="nav">
<a class="h_m" href="index.htm">          Neural Networks for Algorithmic Trading with MQL5 </a> / <a class="h_m" href="4_main_layer_types.htm"> 4. Basic types of neural layers </a> / <a class="h_m" href="4_2_rnn.htm"> 4.2 Recurrent neural networks </a>/ 4.2.3 Organizing parallel computing in the LSTM block
          </td>
          <td width="70" align="right">
          <a href="4_2_2_3_rnn_mql5_save_load.htm"><img style="vertical-align:middle;" src="previous.png" alt="?????" width="27" height="27" border=0></a>&nbsp;
          <a href="4_2_4_rnn_py.htm"><img style="vertical-align:middle;" src="next.png" alt="??????" width="27" height="27" border="0"></a>
          </td>
        </tr>
      </table>
    </td>
    <td width="5"></td>
  </tr>
</table>



<div id="help">
<p class="p_H2"><span class="f_H2">4.2.3 Organizing parallel computing in the LSTM block</span></p>
<p class="p_Text"><span class="f_Text">In previous chapters, we looked at the implementation of </span><span class="f_Text" style="font-style: italic;">an LSTM </span><span class="f_Text">block using MQL5. However, a new stage in the development of neural networks came precisely with the development of parallel computing technologies. This is especially important for resource-intensive tasks such as recurrent neural networks. Therefore, it is especially important for us to add the ability to use multi-threaded parallel computing tools in the </span><span class="f_Text" style="font-style: italic;">LSTM </span><span class="f_Text">block class.</span></p>
<p class="p_Text"><span class="f_Text">As mentioned when creating a block algorithm using MQL5, our class already has an implementation of multi-threaded calculations of individual blocks thanks to the use of objects of the previously discussed class of the base neural layer as gates in the </span><span class="f_Text" style="font-style: italic;">LSTM </span><span class="f_Text">block algorithm. Therefore, within the framework of this chapter, we only have to implement the missing part:</span></p>
<ul style="list-style-type:disc">
<li class="p_li"><span class="f_li">Thread consolidating and processing data from internal neural layers within the forward pass.</span></li>
<li class="p_li"><span class="f_li">Propagating the error gradient from the output of the </span><span class="f_li" style="font-style: italic;">LSTM</span><span class="f_li"> block to the internal neural layers within the backpropagation pass.</span></li>
</ul>
<p class="p_Text"><span class="f_Text">This gives us an understanding of the task. We already have an MQL5 implementation of the process. This gives an understanding of the process and the algorithm for executing operations.</span></p>
<p class="p_Text"><span class="f_Text">Therefore, we can proceed with the work. Let me remind you of the architecture for constructing a multi-threaded computing process. The actual execution of the computation process in parallel threads is carried out in an environment different from the main program – in the </span><span class="f_Text" style="font-style: italic;">OpenCL </span><span class="f_Text">context. To perform operations, three main components are required:</span></p>
<ol style="list-style-type:decimal">
<li value="1" class="p_li"><span class="f_li">Program of performed operations.</span></li>
<li value="2" class="p_li"><span class="f_li">Initial data for performing operations.</span></li>
<li value="3" class="p_li"><span class="f_li">Process control commands (moment of program launch, number of threads created, etc.)</span></li>
</ol>
<p class="p_Text"><span class="f_Text">Let's look at the implementation of these points.</span></p>
<p class="p_Text"><span class="f_Text">&nbsp;</span></p>
<p class="p_H3"><span class="f_H3">4.2.3.1 Making additions to the OpenCL program</span><span class="f_li"> </span></p>
<p class="p_Text"><span class="f_Text">The first item we indicate is the program of the operations being performed. This means that we need to augment our OpenCL program with new kernels to perform the additional operations we require. We collected all the code of the OpenCL program in the file </span><span class="f_Text" style="font-style: italic;"><a href="3_7_1_opencl_programm.htm" class="topiclink">opencl_program.cl</a></span><span class="f_Text">. Open this file and add two new kernels to it: </span><span class="f_Text" style="font-style: italic;">LSTMFeedForward</span><span class="f_Text"> and </span><span class="f_Text" style="font-style: italic;">LSTMCalcHiddenGradient</span><span class="f_Text">. The names of the kernels correspond to the names of the methods of our classes. Therefore, it is easy to guess that the first will complement the feed-forward pass method, and the second will complement the error gradient backpropagation method.</span></p>
<div class="p_Text" style="text-align: center;"><div style="margin:0 auto 0 auto;width:600px"><img class="help" alt="Schematic of a recurrent LSTM block" title="Schematic of a recurrent LSTM block" width="600" height="400" style="width:600px;height:400px;border:none" src="lstm.png"/><p style="text-align:center"><span class="f_ImageCaption">Recurrent LSTM block diagram</span></p></div></div>
<p class="p_Text"><span class="f_Text">We start with the feed-forward pass kernel </span><span class="f_Text" style="font-style: italic;">LSTMFeedForward</span><span class="f_Text">. In the parameters, this buffer will receive pointers to six data buffers (four source data buffers and two result buffers) and one constant:</span></p>
<ul style="list-style-type:disc">
<li class="p_li"><span class="f_li" style="font-style: italic;">forgetgate</span><span class="f_li">: pointer to the forget gate buffer (source data)</span></li>
<li class="p_li"><span class="f_li" style="font-style: italic;">inputgate</span><span class="f_li">: pointer to the input gate buffer (source data)</span></li>
<li class="p_li"><span class="f_li" style="font-style: italic;">outputgate</span><span class="f_li">: pointer to the result gate buffer (source data)</span></li>
<li class="p_li"><span class="f_li" style="font-style: italic;">newcontent</span><span class="f_li">: pointer to the new content buffer (source data)</span></li>
<li class="p_li"><span class="f_li" style="font-style: italic;">memory</span><span class="f_li">: pointer to a memory stream (result buffer)</span></li>
<li class="p_li"><span class="f_li" style="font-style: italic;">hiddenstate</span><span class="f_li">: pointer to the hidden state stream (result buffer)</span></li>
<li class="p_li"><span class="f_li" style="font-style: italic;">outputs_total</span><span class="f_li">: number of elements in the data stream (constant)</span></li>
</ul>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; page-break-after: avoid; border-color: #d8dfea; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExample" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExample" style="color: #0000ff;">__kernel</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">void</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">LSTMFeedForward</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #0000ff;">__global</span><span class="f_CodeExample">&nbsp;</span><span class="f_Definition">TYPE</span><span class="f_CodeExample">&nbsp;*</span><span class="f_CodeExample" style="color: #333333;">forgetgate</span><span class="f_CodeExample">,</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">__global</span><span class="f_CodeExample">&nbsp;</span><span class="f_Definition">TYPE</span><span class="f_CodeExample">&nbsp;*</span><span class="f_CodeExample" style="color: #333333;">inputgate</span><span class="f_CodeExample">,</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">__global</span><span class="f_CodeExample">&nbsp;</span><span class="f_Definition">TYPE</span><span class="f_CodeExample">&nbsp;*</span><span class="f_CodeExample" style="color: #333333;">outputgate</span><span class="f_CodeExample">,</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">__global</span><span class="f_CodeExample">&nbsp;</span><span class="f_Definition">TYPE</span><span class="f_CodeExample">&nbsp;*</span><span class="f_CodeExample" style="color: #333333;">newcontent</span><span class="f_CodeExample">,</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">__global</span><span class="f_CodeExample">&nbsp;</span><span class="f_Definition">TYPE</span><span class="f_CodeExample">&nbsp;*</span><span class="f_CodeExample" style="color: #333333;">memory</span><span class="f_CodeExample">,</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">__global</span><span class="f_CodeExample">&nbsp;</span><span class="f_Definition">TYPE</span><span class="f_CodeExample">&nbsp;*</span><span class="f_CodeExample" style="color: #333333;">hiddenstate</span><span class="f_CodeExample">,</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">int</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">outputs_total</span><span class="f_CodeExample">)</span></p>
</td>
</tr>
</table>
</div>
<p class="p_Text"><span class="f_Text">At the beginning of the method, as before, we receive the thread index, which serves as a pointer to the data being processed. Also, we immediately determine the shift in the data buffers to access the data we need.</span></p>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; page-break-after: avoid; border-color: #d8dfea; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExample" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExample">&nbsp;&nbsp;{</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">const</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">int</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">n</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_Functions">get_global_id</span><span class="f_CodeExample">(</span><span class="f_Normal" style="font-family: Arial,Helvetica,sans-serif; color: #000000; background-color: transparent;">0</span><span class="f_CodeExample">);</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">const</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">int</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">shift</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #333333;">n</span><span class="f_CodeExample">&nbsp;*&nbsp;</span><span class="f_Normal" style="font-family: Arial,Helvetica,sans-serif; color: #000000; background-color: transparent;">4</span><span class="f_CodeExample">;</span></p>
</td>
</tr>
</table>
</div>
<p class="p_Text"><span class="f_Text">To improve the performance of our program, we will use vector arithmetic. Let's use vector variables of type </span><span class="f_Text" style="font-style: italic;">TYPE4</span><span class="f_Text">. Let me remind you that we use the </span><span class="f_Text" style="font-style: italic;">TYPE</span><span class="f_Text"> macro substitution to quickly switch </span><span class="f_Text" style="font-style: italic;">the double</span><span class="f_Text"> or </span><span class="f_Text" style="font-style: italic;">float</span><span class="f_Text"> data type used, depending on the requirements for calculation accuracy and the OpenCL device used. But before we begin performing operations, we will transfer the data from our global data buffers to local vector variables.</span></p>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; page-break-after: avoid; border-color: #d8dfea; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExample" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_Definition">TYPE4</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">fg</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #333333;">ToVect4</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">forgetgate</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">shift</span><span class="f_CodeExample">,&nbsp;</span><span class="f_Normal" style="font-family: Arial,Helvetica,sans-serif; color: #000000; background-color: transparent;">1</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">outputs_total</span><span class="f_CodeExample">,&nbsp;</span><span class="f_Normal" style="font-family: Arial,Helvetica,sans-serif; color: #000000; background-color: transparent;">0</span><span class="f_CodeExample">);</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_Definition">TYPE4</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">ig</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #333333;">ToVect4</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">inputgate</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">shift</span><span class="f_CodeExample">,&nbsp;</span><span class="f_Normal" style="font-family: Arial,Helvetica,sans-serif; color: #000000; background-color: transparent;">1</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">outputs_total</span><span class="f_CodeExample">,&nbsp;</span><span class="f_Normal" style="font-family: Arial,Helvetica,sans-serif; color: #000000; background-color: transparent;">0</span><span class="f_CodeExample">);</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_Definition">TYPE4</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">og</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #333333;">ToVect4</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">outputgate</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">shift</span><span class="f_CodeExample">,&nbsp;</span><span class="f_Normal" style="font-family: Arial,Helvetica,sans-serif; color: #000000; background-color: transparent;">1</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">outputs_total</span><span class="f_CodeExample">,&nbsp;</span><span class="f_Normal" style="font-family: Arial,Helvetica,sans-serif; color: #000000; background-color: transparent;">0</span><span class="f_CodeExample">);</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_Definition">TYPE4</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">nc</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #333333;">ToVect4</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">newcontent</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">shift</span><span class="f_CodeExample">,&nbsp;</span><span class="f_Normal" style="font-family: Arial,Helvetica,sans-serif; color: #000000; background-color: transparent;">1</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">outputs_total</span><span class="f_CodeExample">,&nbsp;</span><span class="f_Normal" style="font-family: Arial,Helvetica,sans-serif; color: #000000; background-color: transparent;">0</span><span class="f_CodeExample">);</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_Definition">TYPE4</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">mem</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #333333;">ToVect4</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">memory</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">shift</span><span class="f_CodeExample">,&nbsp;</span><span class="f_Normal" style="font-family: Arial,Helvetica,sans-serif; color: #000000; background-color: transparent;">1</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">outputs_total</span><span class="f_CodeExample">,&nbsp;</span><span class="f_Normal" style="font-family: Arial,Helvetica,sans-serif; color: #000000; background-color: transparent;">0</span><span class="f_CodeExample">);</span></p>
</td>
</tr>
</table>
</div>
<p class="p_Text"><span class="f_Text">Now, by analogy with the MQL5 program code, we will perform arithmetic operations to update the state of the memory stream. According to the algorithm of </span><span class="f_Text" style="font-style: italic;">the LSTM </span><span class="f_Text">block, we must first adjust the incoming memory stream to the value of the oblivion gate, and then add a new context, adjusted by the value of the input gate, to the resulting value. After completing the operations, we return the value of the updated memory stream back to the buffer.</span></p>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; page-break-after: avoid; border-color: #d8dfea; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExample" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_Definition">TYPE4</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">temp</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #333333;">mem</span><span class="f_CodeExample">&nbsp;*&nbsp;</span><span class="f_CodeExample" style="color: #333333;">fg</span><span class="f_CodeExample">;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">temp</span><span class="f_CodeExample">&nbsp;+=&nbsp;</span><span class="f_CodeExample" style="color: #333333;">ig</span><span class="f_CodeExample">&nbsp;*&nbsp;</span><span class="f_CodeExample" style="color: #333333;">nc</span><span class="f_CodeExample">;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">D4ToArray</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">memory</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">temp</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">shift</span><span class="f_CodeExample">,&nbsp;</span><span class="f_Normal" style="font-family: Arial,Helvetica,sans-serif; color: #000000; background-color: transparent;">1</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">outputs_total</span><span class="f_CodeExample">,&nbsp;</span><span class="f_Normal" style="font-family: Arial,Helvetica,sans-serif; color: #000000; background-color: transparent;">0</span><span class="f_CodeExample">);</span></p>
</td>
</tr>
</table>
</div>
<p class="p_Text"><span class="f_Text">Next, we need to define a new hidden state flow value. It will also be supplied to the output of the </span><span class="f_Text" style="font-style: italic;">LSTM</span><span class="f_Text"> block for transmission to the next neural layer. Here we need to first normalize the current memory state using the hyperbolic tangent function and then adjust the resulting value by the result gate value. The result of the operations is written to the data buffer.</span></p>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; page-break-after: avoid; border-color: #d8dfea; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExample" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">temp</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_Functions">tanh</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">temp</span><span class="f_CodeExample">)&nbsp;*&nbsp;</span><span class="f_CodeExample" style="color: #333333;">og</span><span class="f_CodeExample">;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">D4ToArray</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">hiddenstate</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">temp</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">shift</span><span class="f_CodeExample">,&nbsp;</span><span class="f_Normal" style="font-family: Arial,Helvetica,sans-serif; color: #000000; background-color: transparent;">1</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">outputs_total</span><span class="f_CodeExample">,&nbsp;</span><span class="f_Normal" style="font-family: Arial,Helvetica,sans-serif; color: #000000; background-color: transparent;">0</span><span class="f_CodeExample">);</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;}</span></p>
</td>
</tr>
</table>
</div>
<p class="p_Text"><span class="f_Text">The operations of the feed-forward kernel are now completed. From the results of the work of the internal layers of our recurrent </span><span class="f_Text" style="font-style: italic;">LSTM </span><span class="f_Text">block, we updated the state of the memory stream and obtained values that will be provided at the output of the recurrent block.</span></p>
<p class="p_Text"><span class="f_Text">In the second kernel </span><span class="f_Text" style="font-style: italic;">LSTMCalcHiddenGradient,</span><span class="f_Text"> we need to perform the reverse operation, that is, carry out the error gradient in the opposite direction, from the output of the recurrent block to the output of each internal neural layer. The specific operation of the backpropagation kernel requires an increase in the number of used data buffers to 10:</span></p>
<ul style="list-style-type:disc">
<li class="p_li"><span class="f_li" style="font-style: italic;">outputs</span><span class="f_li">: pointer to the result vector buffer (source data)</span></li>
<li class="p_li"><span class="f_li" style="font-style: italic;">gradients</span><span class="f_li">: pointer to the gradient vector buffer of the current layer (source data)</span></li>
</ul>
<ul style="list-style-type:disc">
<li class="p_li"><span class="f_li" style="font-style: italic;">inputgate</span><span class="f_li">: pointer to the input gate buffer (source data)</span></li>
<li class="p_li"><span class="f_li" style="font-style: italic;">outputgate</span><span class="f_li">: pointer to the result gate buffer (source data)</span></li>
<li class="p_li"><span class="f_li" style="font-style: italic;">newcontent</span><span class="f_li">: pointer to the new content buffer (source data)</span></li>
<li class="p_li"><span class="f_li" style="font-style: italic;">memory</span><span class="f_li">: pointer to a memory stream (source data)</span></li>
</ul>
<ul style="list-style-type:disc">
<li class="p_li"><span class="f_li" style="font-style: italic;">fg_gradients</span><span class="f_li">: pointer to the oblivion gate gradient buffer (result buffer)</span></li>
<li class="p_li"><span class="f_li" style="font-style: italic;">ig_gradients</span><span class="f_li">: pointer to the input gate gradient buffer (result buffer)</span></li>
<li class="p_li"><span class="f_li" style="font-style: italic;">og_gradients</span><span class="f_li">: pointer to the result gate gradient buffer (result buffer)</span></li>
<li class="p_li"><span class="f_li" style="font-style: italic;">nc_gradients</span><span class="f_li">: pointer to the new content gradient buffer (result buffer)</span></li>
<li class="p_li"><span class="f_li" style="font-style: italic;">outputs_total</span><span class="f_li">: number of elements in the data stream (constant)</span></li>
</ul>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; page-break-after: avoid; border-color: #d8dfea; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExample" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExample" style="color: #0000ff;">__kernel</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">void</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">LSTMCalcHiddenGradient</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #0000ff;">__global</span><span class="f_CodeExample">&nbsp;</span><span class="f_Definition">TYPE</span><span class="f_CodeExample">&nbsp;*</span><span class="f_CodeExample" style="color: #333333;">outputs</span><span class="f_CodeExample">_</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">__global</span><span class="f_CodeExample">&nbsp;</span><span class="f_Definition">TYPE</span><span class="f_CodeExample">&nbsp;*</span><span class="f_CodeExample" style="color: #333333;">gradients</span><span class="f_CodeExample">,</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">__global</span><span class="f_CodeExample">&nbsp;</span><span class="f_Definition">TYPE</span><span class="f_CodeExample">&nbsp;*</span><span class="f_CodeExample" style="color: #333333;">inputgate</span><span class="f_CodeExample">,</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">__global</span><span class="f_CodeExample">&nbsp;</span><span class="f_Definition">TYPE</span><span class="f_CodeExample">&nbsp;*</span><span class="f_CodeExample" style="color: #333333;">outputgate</span><span class="f_CodeExample">,</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">__global</span><span class="f_CodeExample">&nbsp;</span><span class="f_Definition">TYPE</span><span class="f_CodeExample">&nbsp;*</span><span class="f_CodeExample" style="color: #333333;">newcontent</span><span class="f_CodeExample">,</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">__global</span><span class="f_CodeExample">&nbsp;</span><span class="f_Definition">TYPE</span><span class="f_CodeExample">&nbsp;*</span><span class="f_CodeExample" style="color: #333333;">memory</span><span class="f_CodeExample">,</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">__global</span><span class="f_CodeExample">&nbsp;</span><span class="f_Definition">TYPE</span><span class="f_CodeExample">&nbsp;*</span><span class="f_CodeExample" style="color: #333333;">fg_gradients</span><span class="f_CodeExample">,</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">__global</span><span class="f_CodeExample">&nbsp;</span><span class="f_Functions">TYPE</span><span class="f_CodeExample">&nbsp;*</span><span class="f_CodeExample" style="color: #333333;">ig_gradients</span><span class="f_CodeExample">,</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">__global</span><span class="f_CodeExample">&nbsp;</span><span class="f_Definition">TYPE</span><span class="f_CodeExample">&nbsp;*</span><span class="f_CodeExample" style="color: #333333;">og_gradients</span><span class="f_CodeExample">,</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">__global</span><span class="f_CodeExample">&nbsp;</span><span class="f_Definition">TYPE</span><span class="f_CodeExample">&nbsp;*</span><span class="f_CodeExample" style="color: #333333;">nc_gradients</span><span class="f_CodeExample">,</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">int</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">outputs_total</span><span class="f_CodeExample">)</span></p>
</td>
</tr>
</table>
</div>
<p class="p_Text"><span class="f_Text">At the beginning of the kernel, we determine the thread ID and the offset in the data buffers to the values being processed.</span></p>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; page-break-after: avoid; border-color: #d8dfea; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExample" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExample">&nbsp;&nbsp;{</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">const</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">int</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">n</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_Functions">get_global_id</span><span class="f_CodeExample">(</span><span class="f_Normal" style="font-family: Arial,Helvetica,sans-serif; color: #000000; background-color: transparent;">0</span><span class="f_CodeExample">);</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">int</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">shift</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #333333;">n</span><span class="f_CodeExample">&nbsp;*&nbsp;</span><span class="f_Normal" style="font-family: Arial,Helvetica,sans-serif; color: #000000; background-color: transparent;">4</span><span class="f_CodeExample">;</span></p>
</td>
</tr>
</table>
</div>
<p class="p_Text"><span class="f_Text">As in the forward pass kernel, we will use operations with vector variables of type </span><span class="f_Text" style="font-style: italic;">TYPE4</span><span class="f_Text">. Therefore, in the next step, we transfer the original data from global buffers to local vector variables.</span></p>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; page-break-after: avoid; border-color: #d8dfea; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExample" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_Definition">TYPE4</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">out</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #333333;">ToVect4</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">outputs</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">shift</span><span class="f_CodeExample">,&nbsp;</span><span class="f_Normal" style="font-family: Arial,Helvetica,sans-serif; color: #000000; background-color: transparent;">1</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">outputs_total</span><span class="f_CodeExample">,&nbsp;</span><span class="f_Normal" style="font-family: Arial,Helvetica,sans-serif; color: #000000; background-color: transparent;">0</span><span class="f_CodeExample">);</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_Definition">TYPE4</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">grad</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #333333;">ToVect4</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">gradients</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">shift</span><span class="f_CodeExample">,&nbsp;</span><span class="f_Normal" style="font-family: Arial,Helvetica,sans-serif; color: #000000; background-color: transparent;">1</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">outputs_total</span><span class="f_CodeExample">,&nbsp;</span><span class="f_Normal" style="font-family: Arial,Helvetica,sans-serif; color: #000000; background-color: transparent;">0</span><span class="f_CodeExample">);</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_Definition">TYPE4</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">ig</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #333333;">ToVect4</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">inputgate</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">shift</span><span class="f_CodeExample">,&nbsp;</span><span class="f_Normal" style="font-family: Arial,Helvetica,sans-serif; color: #000000; background-color: transparent;">1</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">outputs_total</span><span class="f_CodeExample">,&nbsp;</span><span class="f_Normal" style="font-family: Arial,Helvetica,sans-serif; color: #000000; background-color: transparent;">0</span><span class="f_CodeExample">);</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_Definition">TYPE4</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">og</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #333333;">ToVect4</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">outputgate</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">shift</span><span class="f_CodeExample">,&nbsp;</span><span class="f_Normal" style="font-family: Arial,Helvetica,sans-serif; color: #000000; background-color: transparent;">1</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">outputs_total</span><span class="f_CodeExample">,&nbsp;</span><span class="f_Normal" style="font-family: Arial,Helvetica,sans-serif; color: #000000; background-color: transparent;">0</span><span class="f_CodeExample">);</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_Definition">TYPE4</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">nc</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #333333;">ToVect4</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">newcontent</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">shift</span><span class="f_CodeExample">,&nbsp;</span><span class="f_Normal" style="font-family: Arial,Helvetica,sans-serif; color: #000000; background-color: transparent;">1</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">outputs_total</span><span class="f_CodeExample">,&nbsp;</span><span class="f_Normal" style="font-family: Arial,Helvetica,sans-serif; color: #000000; background-color: transparent;">0</span><span class="f_CodeExample">);</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_Definition">TYPE4</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">mem</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #333333;">ToVect4</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">memory</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">shift</span><span class="f_CodeExample">,&nbsp;</span><span class="f_Normal" style="font-family: Arial,Helvetica,sans-serif; color: #000000; background-color: transparent;">1</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">outputs_total</span><span class="f_CodeExample">,&nbsp;</span><span class="f_Normal" style="font-family: Arial,Helvetica,sans-serif; color: #000000; background-color: transparent;">0</span><span class="f_CodeExample">);</span></p>
</td>
</tr>
</table>
</div>
<p class="p_Text"><span class="f_Text">After completing the preparatory operations, we proceed to execute the mathematical part of the kernel. <a href="4_2_2_2_rnn_mql5_backprop.htm" class="topiclink">Formulas</a> for carrying out operations and their explanation are presented when describing the construction of a process using MQL5. Therefore, in this section, only the implementation of the process in OpenCL will be given.</span></p>
<p class="p_Text"><span class="f_Text">When implementing this part in MQL5, we decided that it was inappropriate to create an additional data buffer to store the normalized value of the memory stream. In the kernel parameters, we received a pointer to a stream not of the current memory state, but of a recurrent block arriving at the input from the previous iteration of the forward pass. Therefore, before proceeding with the error gradient distribution operations, we need to find the value of the normalized state of the memory stream. We define it as the ratio of the result buffer value to the result gate value. To eliminate division by zero, we add a small constant in the denominator.</span></p>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; page-break-after: avoid; border-color: #d8dfea; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExample" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_Definition">TYPE4</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">m</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #333333;">out</span><span class="f_CodeExample">&nbsp;/&nbsp;(</span><span class="f_CodeExample" style="color: #333333;">og</span><span class="f_CodeExample">&nbsp;+&nbsp;</span><span class="f_Normal" style="font-family: Arial,Helvetica,sans-serif; color: #000000; background-color: transparent;">1.0e-37f</span><span class="f_CodeExample">);</span></p>
</td>
</tr>
</table>
</div>
<p class="p_Text"><span class="f_Text">Following the logic of the error gradient backpropagation algorithm, we first determine the error gradient at the output of the oblivion gate neural layer. To do this, we need to multiply the error gradient at the output of our </span><span class="f_Text" style="font-style: italic;">LSTM </span><span class="f_Text">block by the derivative of the product. In this case, it is equal to the value of the normalized memory state. We will immediately write the resulting value into the corresponding data buffer.</span></p>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; page-break-after: avoid; border-color: #d8dfea; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExample" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExample" style="color: #808080;">//---&nbsp;OutputGate&nbsp;gradient</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_Definition">TYPE4</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">temp</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #333333;">grad</span><span class="f_CodeExample">&nbsp;*&nbsp;</span><span class="f_CodeExample" style="color: #333333;">m</span><span class="f_CodeExample">;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">D4ToArray</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">og_gradients</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">temp</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">shift</span><span class="f_CodeExample">,&nbsp;</span><span class="f_Normal" style="font-family: Arial,Helvetica,sans-serif; color: #000000; background-color: transparent;">1</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">outputs_total</span><span class="f_CodeExample">,&nbsp;</span><span class="f_Normal" style="font-family: Arial,Helvetica,sans-serif; color: #000000; background-color: transparent;">0</span><span class="f_CodeExample">);</span></p>
</td>
</tr>
</table>
</div>
<p class="p_Text"><span class="f_Text">Next, we must similarly determine the error gradient with another multiplier, which is the normalized memory state. That is, we multiply the error gradient at the output of our recurrent block by the state of the results gate.</span></p>
<p class="p_Text"><span class="f_Text">Before continuing to propagate the gradient to the remaining neural layers, we need to pass it through the <a href="1_2_activation.htm#tanh" class="topiclink">hyperbolic tangent</a> function. In other words, we multiply the previously obtained value by the derivative of the hyperbolic tangent.</span></p>
<p class="p_Text" style="text-align: center;"><span style="display:inline-block;width:365px;height:40px;padding:0 0;overflow:visible"><svg xmlns="http://www.w3.org/2000/svg" style="width:100%;height:100%;overflow:visible" viewBox="0 0 1460 160"><path d="M26 44 C23 48,21 50,19 52 C17 53,15 54,12 54 C10 54,8 53,6 51 C5 49,4 46,4 42 C4 38,5 34,6 30 C8 26,10 23,13 21 C16 18,19 17,23 17 C24 17,26 17,27 18 C28 18,29 18,31 19 L33 11 C33 10,33 9,33 8 C33 7,33 7,33 6 C33 5,33 5,33 4 C33 4,32 4,32 3 C31 3,30 3,29 3 L30 1 L39 1 L41 1 L32 42 C31 44,31 46,31 47 C31 48,31 49,31 49 C32 50,32 50,33 50 C34 50,35 50,35 49 C36 49,37 48,39 46 L41 48 C39 50,37 52,35 53 C34 54,32 54,30 54 C29 54,28 54,27 53 C26 52,25 50,25 49 C25 48,26 46,26 45 L26 44 Z M28 31 C28 29,29 27,29 26 C29 24,28 22,27 21 C27 21,25 20,23 20 C21 20,19 21,17 23 C15 25,13 28,12 32 C11 35,10 39,10 42 C10 45,11 47,11 48 C12 49,13 50,15 50 C16 50,16 50,17 50 C18 49,19 49,20 48 C21 47,21 46,22 45 C23 44,24 43,24 42 C25 41,26 40,26 38 C27 36,27 35,28 32 L28 31 Z" fill="#212121"/><path d="M59 54 C58 59,56 63,54 65 C51 68,48 69,45 69 C44 69,43 69,42 69 L43 66 C43 66,44 66,45 66 C46 66,47 66,48 65 C48 65,49 64,50 62 C50 61,51 59,52 57 L60 22 L53 22 L54 20 C56 20,57 20,57 20 C58 20,59 19,59 19 C60 19,60 18,60 18 C60 17,61 16,61 14 C63 10,65 7,67 4 C70 2,73 1,78 1 C80 1,82 1,84 2 L82 8 L79 8 C79 7,78 6,78 5 C77 4,76 4,75 4 C74 4,73 4,72 5 C71 6,70 7,69 8 C69 10,68 12,67 14 L66 18 L76 18 L75 22 L66 22 L59 54 Z" fill="#212121"/><path d="M99 35 C99 43,100 51,103 56 C106 62,110 65,116 67 L115 70 C108 68,102 64,99 58 C95 52,93 44,93 35 C93 26,95 19,99 12 C102 6,108 2,115 0 L116 3 C110 5,106 9,103 14 C100 20,99 26,99 35 L99 35 Z" fill="#212121"/><path d="M134 36 C134 34,134 33,133 31 C133 29,133 27,132 26 C132 24,131 23,131 22 C131 22,131 22,130 21 C130 21,130 21,129 21 C129 21,128 21,128 21 C127 22,127 22,126 23 C126 23,125 24,124 25 L122 23 C124 21,125 20,126 19 C128 18,130 17,131 17 C132 17,133 17,133 17 C134 18,135 18,135 18 C135 19,136 19,136 20 C137 20,137 21,137 22 C138 23,138 24,138 26 C138 27,139 29,139 30 L139 30 C142 27,143 24,144 23 C146 21,147 20,148 19 C148 18,149 18,150 18 C151 17,152 17,153 17 C154 17,155 17,156 18 L154 25 L152 25 C152 24,151 23,151 23 C150 23,150 23,150 23 C150 23,149 23,149 24 C149 24,148 24,147 25 C147 26,146 27,145 28 C144 29,143 30,142 31 L140 34 C140 37,141 39,141 40 C142 42,142 44,142 45 C143 46,143 47,143 48 C143 48,144 49,144 49 C144 50,144 50,145 50 C145 50,145 50,146 50 C146 50,147 50,147 49 C148 49,149 48,150 46 L153 48 C151 50,149 52,148 53 C147 54,145 54,143 54 C142 54,141 54,140 53 C140 53,139 52,138 52 C138 51,137 49,137 48 C136 44,136 42,136 40 L135 40 C133 44,131 47,129 48 C128 50,127 51,126 52 C126 53,125 53,124 54 C123 54,122 54,121 54 C120 54,119 54,118 54 L120 46 L122 46 C122 47,123 48,123 48 C124 48,124 48,125 48 C125 48,125 47,126 46 C127 46,128 45,129 43 C130 42,132 39,134 36 L134 36 Z" fill="#212121"/><path d="M177 35 C177 26,176 20,173 14 C170 9,166 5,160 3 L161 0 C168 2,174 6,177 12 C181 19,183 26,183 35 C183 44,181 52,177 58 C174 64,168 68,161 70 L160 67 C166 65,170 62,173 56 C176 51,177 43,177 35 L177 35 Z" fill="#212121"/><path d="M79 151 C76 155,74 157,72 159 C70 160,68 161,65 161 C63 161,61 160,59 158 C58 156,57 153,57 149 C57 145,58 141,59 137 C61 133,63 130,66 128 C69 125,72 124,76 124 C77 124,79 124,80 125 C81 125,82 125,84 126 L86 118 C86 117,86 116,86 115 C86 114,86 114,86 113 C86 112,86 112,86 111 C86 111,85 111,85 110 C84 110,83 110,82 110 L83 108 L92 108 L94 108 L85 149 C84 151,84 153,84 154 C84 155,84 156,84 156 C85 157,85 157,86 157 C87 157,88 157,88 156 C89 156,90 155,92 153 L94 155 C92 157,90 159,88 160 C87 161,85 161,83 161 C82 161,81 161,80 160 C79 159,78 157,78 156 C78 155,79 153,79 152 L79 151 Z M81 138 C81 136,82 134,82 133 C82 131,81 129,80 128 C80 128,78 127,76 127 C74 127,72 128,70 130 C68 132,66 135,65 139 C64 142,63 146,63 149 C63 152,64 154,64 155 C65 156,66 157,68 157 C69 157,69 157,70 157 C71 156,72 156,73 155 C74 154,74 153,75 152 C76 151,77 150,77 149 C78 148,79 147,79 145 C80 143,80 142,81 139 L81 138 Z" fill="#212121"/><path d="M113 143 C113 141,113 140,112 138 C112 136,112 134,111 133 C111 131,110 130,110 129 C110 129,110 129,109 128 C109 128,109 128,108 128 C108 128,107 128,107 128 C106 129,106 129,105 130 C105 130,104 131,103 132 L101 130 C103 128,104 127,105 126 C107 125,109 124,110 124 C111 124,112 124,112 124 C113 125,114 125,114 125 C114 126,115 126,115 127 C116 127,116 128,116 129 C117 130,117 131,117 133 C117 134,118 136,118 137 L118 137 C121 134,122 131,123 130 C125 128,126 127,127 126 C127 125,128 125,129 125 C130 124,131 124,132 124 C133 124,134 124,135 125 L133 132 L131 132 C131 131,130 130,130 130 C129 130,129 130,129 130 C129 130,128 130,128 131 C128 131,127 131,126 132 C126 133,125 134,124 135 C123 136,122 137,121 138 L119 141 C119 144,120 146,120 147 C121 149,121 151,121 152 C122 153,122 154,122 155 C122 155,123 156,123 156 C123 157,123 157,124 157 C124 157,124 157,125 157 C125 157,126 157,126 156 C127 156,128 155,129 153 L132 155 C130 157,128 159,127 160 C126 161,124 161,122 161 C121 161,120 161,119 160 C119 160,118 159,117 159 C117 158,116 156,116 155 C115 151,115 149,115 147 L114 147 C112 151,110 154,108 155 C107 157,106 158,105 159 C105 160,104 160,103 161 C102 161,101 161,100 161 C99 161,98 161,97 161 L99 153 L101 153 C101 154,102 155,102 155 C103 155,103 155,104 155 C104 155,104 154,105 153 C106 153,107 152,108 150 C109 149,111 146,113 143 L113 143 Z" fill="#212121"/><rect x="0" y="86" width="190" height="5" fill="#212121"/><path d="M216 84 L216 79 L262 79 L262 84 L216 84 Z M216 99 L216 94 L262 94 L262 99 L216 99 Z" fill="#212121"/><path d="M301 92 C301 100,302 108,305 113 C308 119,312 122,318 124 L317 127 C310 125,304 121,301 115 C297 109,295 101,295 92 C295 83,297 76,301 69 C304 63,310 59,317 57 L318 60 C312 62,308 66,305 71 C302 77,301 83,301 92 L301 92 Z" fill="#212121"/><path d="M345 100 C345 102,345 103,345 103 C345 104,346 105,346 105 C346 106,347 106,348 106 C349 107,349 107,351 107 C352 107,353 107,355 107 L355 110 L328 110 L328 107 C331 107,333 107,334 107 C335 106,336 106,336 106 C337 105,337 105,338 104 C338 103,338 102,338 100 L338 70 C338 69,338 69,338 68 C337 68,337 68,336 68 C335 68,334 68,333 69 C331 70,330 71,328 72 L326 69 L343 59 L345 59 C345 61,345 65,345 69 L345 100 Z" fill="#212121"/><path d="M409 91 L409 112 L403 112 L403 91 L383 91 L383 86 L403 86 L403 65 L409 65 L409 86 L429 86 L429 91 L409 91 Z" fill="#212121"/><path d="M467 111 C466 116,464 120,462 122 C459 125,456 126,453 126 C452 126,451 126,450 126 L451 123 C451 123,452 123,453 123 C454 123,455 123,456 122 C456 122,457 121,458 119 C458 118,459 116,460 114 L468 79 L461 79 L462 77 C464 77,465 77,465 77 C466 77,467 76,467 76 C468 76,468 75,468 75 C468 74,469 73,469 71 C471 67,473 64,475 61 C478 59,481 58,486 58 C488 58,490 58,492 59 L490 65 L487 65 C487 64,486 63,486 62 C485 61,484 61,483 61 C482 61,481 61,480 62 C479 63,478 64,477 65 C477 67,476 69,475 71 L474 75 L484 75 L483 79 L474 79 L467 111 Z" fill="#212121"/><path d="M507 92 C507 100,508 108,511 113 C514 119,518 122,524 124 L523 127 C516 125,510 121,507 115 C503 109,501 101,501 92 C501 83,503 76,507 69 C510 63,516 59,523 57 L524 60 C518 62,514 66,511 71 C508 77,507 83,507 92 L507 92 Z" fill="#212121"/><path d="M542 93 C542 91,542 90,541 88 C541 86,541 84,540 83 C540 81,539 80,539 79 C539 79,539 79,538 78 C538 78,538 78,537 78 C537 78,536 78,536 78 C535 79,535 79,534 80 C534 80,533 81,532 82 L530 80 C532 78,533 77,534 76 C536 75,538 74,539 74 C540 74,541 74,541 74 C542 75,543 75,543 75 C543 76,544 76,544 77 C545 77,545 78,545 79 C546 80,546 81,546 83 C546 84,547 86,547 87 L547 87 C550 84,551 81,552 80 C554 78,555 77,556 76 C556 75,557 75,558 75 C559 74,560 74,561 74 C562 74,563 74,564 75 L562 82 L560 82 C560 81,559 80,559 80 C558 80,558 80,558 80 C558 80,557 80,557 81 C557 81,556 81,555 82 C555 83,554 84,553 85 C552 86,551 87,550 88 L548 91 C548 94,549 96,549 97 C550 99,550 101,550 102 C551 103,551 104,551 105 C551 105,552 106,552 106 C552 107,552 107,553 107 C553 107,553 107,554 107 C554 107,555 107,555 106 C556 106,557 105,558 103 L561 105 C559 107,557 109,556 110 C555 111,553 111,551 111 C550 111,549 111,548 110 C548 110,547 109,546 109 C546 108,545 106,545 105 C544 101,544 99,544 97 L543 97 C541 101,539 104,537 105 C536 107,535 108,534 109 C534 110,533 110,532 111 C531 111,530 111,529 111 C528 111,527 111,526 111 L528 103 L530 103 C530 104,531 105,531 105 C532 105,532 105,533 105 C533 105,533 104,534 103 C535 103,536 102,537 100 C538 99,540 96,542 93 L542 93 Z" fill="#212121"/><path d="M585 92 C585 83,584 77,581 71 C578 66,574 62,568 60 L569 57 C576 59,582 63,585 69 C589 76,591 83,591 92 C591 101,589 109,585 115 C582 121,576 125,569 127 L568 124 C574 122,578 119,581 113 C584 108,585 100,585 92 L585 92 Z" fill="#212121"/><path d="M616 92 C616 83,615 77,612 71 C609 66,605 62,599 60 L600 57 C607 59,613 63,616 69 C620 76,622 83,622 92 C622 101,620 109,616 115 C613 121,607 125,600 127 L599 124 C605 122,609 119,612 113 C615 108,616 100,616 92 L616 92 Z" fill="#212121"/><path d="M642 92 C642 100,643 108,646 113 C649 119,653 122,659 124 L658 127 C651 125,645 121,642 115 C638 109,636 101,636 92 C636 83,638 76,642 69 C645 63,651 59,658 57 L659 60 C653 62,649 66,646 71 C643 77,642 83,642 92 L642 92 Z" fill="#212121"/><path d="M686 100 C686 102,686 103,686 103 C686 104,687 105,687 105 C687 106,688 106,689 106 C690 107,690 107,692 107 C693 107,694 107,696 107 L696 110 L669 110 L669 107 C672 107,674 107,675 107 C676 106,677 106,677 106 C678 105,678 105,679 104 C679 103,679 102,679 100 L679 70 C679 69,679 69,679 68 C678 68,678 68,677 68 C676 68,675 68,674 69 C672 70,671 71,669 72 L667 69 L684 59 L686 59 C686 61,686 65,686 69 L686 100 Z" fill="#212121"/><path d="M724 91 L724 86 L770 86 L770 91 L724 91 Z" fill="#212121"/><path d="M808 111 C807 116,805 120,803 122 C800 125,797 126,794 126 C793 126,792 126,791 126 L792 123 C792 123,793 123,794 123 C795 123,796 123,797 122 C797 122,798 121,799 119 C799 118,800 116,801 114 L809 79 L802 79 L803 77 C805 77,806 77,806 77 C807 77,808 76,808 76 C809 76,809 75,809 75 C809 74,810 73,810 71 C812 67,814 64,816 61 C819 59,822 58,827 58 C829 58,831 58,833 59 L831 65 L828 65 C828 64,827 63,827 62 C826 61,825 61,824 61 C823 61,822 61,821 62 C820 63,819 64,818 65 C818 67,817 69,816 71 L815 75 L825 75 L824 79 L815 79 L808 111 Z" fill="#212121"/><path d="M848 92 C848 100,849 108,852 113 C855 119,859 122,865 124 L864 127 C857 125,851 121,848 115 C844 109,842 101,842 92 C842 83,844 76,848 69 C851 63,857 59,864 57 L865 60 C859 62,855 66,852 71 C849 77,848 83,848 92 L848 92 Z" fill="#212121"/><path d="M883 93 C883 91,883 90,882 88 C882 86,882 84,881 83 C881 81,880 80,880 79 C880 79,880 79,879 78 C879 78,879 78,878 78 C878 78,877 78,877 78 C876 79,876 79,875 80 C875 80,874 81,873 82 L871 80 C873 78,874 77,875 76 C877 75,879 74,880 74 C881 74,882 74,882 74 C883 75,884 75,884 75 C884 76,885 76,885 77 C886 77,886 78,886 79 C887 80,887 81,887 83 C887 84,888 86,888 87 L888 87 C891 84,892 81,893 80 C895 78,896 77,897 76 C897 75,898 75,899 75 C900 74,901 74,902 74 C903 74,904 74,905 75 L903 82 L901 82 C901 81,900 80,900 80 C899 80,899 80,899 80 C899 80,898 80,898 81 C898 81,897 81,896 82 C896 83,895 84,894 85 C893 86,892 87,891 88 L889 91 C889 94,890 96,890 97 C891 99,891 101,891 102 C892 103,892 104,892 105 C892 105,893 106,893 106 C893 107,893 107,894 107 C894 107,894 107,895 107 C895 107,896 107,896 106 C897 106,898 105,899 103 L902 105 C900 107,898 109,897 110 C896 111,894 111,892 111 C891 111,890 111,889 110 C889 110,888 109,887 109 C887 108,886 106,886 105 C885 101,885 99,885 97 L884 97 C882 101,880 104,878 105 C877 107,876 108,875 109 C875 110,874 110,873 111 C872 111,871 111,870 111 C869 111,868 111,867 111 L869 103 L871 103 C871 104,872 105,872 105 C873 105,873 105,874 105 C874 105,874 104,875 103 C876 103,877 102,878 100 C879 99,881 96,883 93 L883 93 Z" fill="#212121"/><path d="M926 92 C926 83,925 77,922 71 C919 66,915 62,909 60 L910 57 C917 59,923 63,926 69 C930 76,932 83,932 92 C932 101,930 109,926 115 C923 121,917 125,910 127 L909 124 C915 122,919 119,922 113 C925 108,926 100,926 92 L926 92 Z" fill="#212121"/><path d="M957 92 C957 83,956 77,953 71 C950 66,946 62,940 60 L941 57 C948 59,954 63,957 69 C961 76,963 83,963 92 C963 101,961 109,957 115 C954 121,948 125,941 127 L940 124 C946 122,950 119,953 113 C956 108,957 100,957 92 L957 92 Z" fill="#212121"/><path d="M996 84 L996 79 L1042 79 L1042 84 L996 84 Z M996 99 L996 94 L1042 94 L1042 99 L996 99 Z" fill="#212121"/><path d="M1094 100 C1094 102,1094 103,1094 103 C1094 104,1095 105,1095 105 C1095 106,1096 106,1097 106 C1098 107,1098 107,1100 107 C1101 107,1102 107,1104 107 L1104 110 L1077 110 L1077 107 C1080 107,1082 107,1083 107 C1084 106,1085 106,1085 106 C1086 105,1086 105,1087 104 C1087 103,1087 102,1087 100 L1087 70 C1087 69,1087 69,1087 68 C1086 68,1086 68,1085 68 C1084 68,1083 68,1082 69 C1080 70,1079 71,1077 72 L1075 69 L1092 59 L1094 59 C1094 61,1094 65,1094 69 L1094 100 Z" fill="#212121"/><path d="M1132 91 L1132 86 L1178 86 L1178 91 L1132 91 Z" fill="#212121"/><path d="M1213 92 C1213 100,1214 108,1217 113 C1220 119,1224 122,1230 124 L1229 127 C1222 125,1216 121,1213 115 C1209 109,1207 101,1207 92 C1207 83,1209 76,1213 69 C1216 63,1222 59,1229 57 L1230 60 C1224 62,1220 66,1217 71 C1214 77,1213 83,1213 92 L1213 92 Z" fill="#212121"/><path d="M1247 111 C1246 116,1244 120,1242 122 C1239 125,1236 126,1233 126 C1232 126,1231 126,1230 126 L1231 123 C1231 123,1232 123,1233 123 C1234 123,1235 123,1236 122 C1236 122,1237 121,1238 119 C1238 118,1239 116,1240 114 L1248 79 L1241 79 L1242 77 C1244 77,1245 77,1245 77 C1246 77,1247 76,1247 76 C1248 76,1248 75,1248 75 C1248 74,1249 73,1249 71 C1251 67,1253 64,1255 61 C1258 59,1261 58,1266 58 C1268 58,1270 58,1272 59 L1270 65 L1267 65 C1267 64,1266 63,1266 62 C1265 61,1264 61,1263 61 C1262 61,1261 61,1260 62 C1259 63,1258 64,1257 65 C1257 67,1256 69,1255 71 L1254 75 L1264 75 L1263 79 L1254 79 L1247 111 Z" fill="#212121"/><path d="M1287 92 C1287 100,1288 108,1291 113 C1294 119,1298 122,1304 124 L1303 127 C1296 125,1290 121,1287 115 C1283 109,1281 101,1281 92 C1281 83,1283 76,1287 69 C1290 63,1296 59,1303 57 L1304 60 C1298 62,1294 66,1291 71 C1288 77,1287 83,1287 92 L1287 92 Z" fill="#212121"/><path d="M1322 93 C1322 91,1322 90,1321 88 C1321 86,1321 84,1320 83 C1320 81,1319 80,1319 79 C1319 79,1319 79,1318 78 C1318 78,1318 78,1317 78 C1317 78,1316 78,1316 78 C1315 79,1315 79,1314 80 C1314 80,1313 81,1312 82 L1310 80 C1312 78,1313 77,1314 76 C1316 75,1318 74,1319 74 C1320 74,1321 74,1321 74 C1322 75,1323 75,1323 75 C1323 76,1324 76,1324 77 C1325 77,1325 78,1325 79 C1326 80,1326 81,1326 83 C1326 84,1327 86,1327 87 L1327 87 C1330 84,1331 81,1332 80 C1334 78,1335 77,1336 76 C1336 75,1337 75,1338 75 C1339 74,1340 74,1341 74 C1342 74,1343 74,1344 75 L1342 82 L1340 82 C1340 81,1339 80,1339 80 C1338 80,1338 80,1338 80 C1338 80,1337 80,1337 81 C1337 81,1336 81,1335 82 C1335 83,1334 84,1333 85 C1332 86,1331 87,1330 88 L1328 91 C1328 94,1329 96,1329 97 C1330 99,1330 101,1330 102 C1331 103,1331 104,1331 105 C1331 105,1332 106,1332 106 C1332 107,1332 107,1333 107 C1333 107,1333 107,1334 107 C1334 107,1335 107,1335 106 C1336 106,1337 105,1338 103 L1341 105 C1339 107,1337 109,1336 110 C1335 111,1333 111,1331 111 C1330 111,1329 111,1328 110 C1328 110,1327 109,1326 109 C1326 108,1325 106,1325 105 C1324 101,1324 99,1324 97 L1323 97 C1321 101,1319 104,1317 105 C1316 107,1315 108,1314 109 C1314 110,1313 110,1312 111 C1311 111,1310 111,1309 111 C1308 111,1307 111,1306 111 L1308 103 L1310 103 C1310 104,1311 105,1311 105 C1312 105,1312 105,1313 105 C1313 105,1313 104,1314 103 C1315 103,1316 102,1317 100 C1318 99,1320 96,1322 93 L1322 93 Z" fill="#212121"/><path d="M1365 92 C1365 83,1364 77,1361 71 C1358 66,1354 62,1348 60 L1349 57 C1356 59,1362 63,1365 69 C1369 76,1371 83,1371 92 C1371 101,1369 109,1365 115 C1362 121,1356 125,1349 127 L1348 124 C1354 122,1358 119,1361 113 C1364 108,1365 100,1365 92 L1365 92 Z" fill="#212121"/><path d="M1396 92 C1396 83,1395 77,1392 71 C1389 66,1385 62,1379 60 L1380 57 C1387 59,1393 63,1396 69 C1400 76,1402 83,1402 92 C1402 101,1400 109,1396 115 C1393 121,1387 125,1380 127 L1379 124 C1385 122,1389 119,1392 113 C1395 108,1396 100,1396 92 L1396 92 Z" fill="#212121"/><path d="M1427 70 C1427 70,1428 70,1429 70 C1429 70,1429 70,1430 70 C1430 69,1430 69,1431 69 C1431 68,1431 68,1431 67 L1434 67 C1434 68,1434 69,1434 71 C1434 72,1434 73,1433 74 L1411 74 L1411 73 C1411 72,1412 71,1412 70 C1413 69,1413 68,1414 67 C1415 66,1416 65,1417 64 C1417 63,1418 62,1420 61 C1421 59,1423 58,1424 57 C1425 55,1426 54,1426 53 C1427 52,1427 52,1427 51 C1428 50,1428 49,1428 48 C1428 47,1428 47,1427 46 C1427 45,1427 44,1426 44 C1426 43,1425 43,1424 43 C1424 42,1423 42,1422 42 C1420 42,1419 43,1418 43 C1417 44,1416 45,1415 47 L1412 47 L1412 42 C1414 41,1416 40,1418 40 C1420 39,1422 39,1423 39 C1425 39,1427 39,1428 40 C1429 40,1430 41,1431 41 C1432 42,1432 43,1433 44 C1433 45,1433 46,1433 47 C1433 48,1433 49,1433 49 C1433 50,1433 51,1433 51 C1432 52,1432 52,1432 53 C1431 54,1431 54,1430 55 C1430 56,1429 56,1429 57 C1428 58,1427 59,1426 59 C1425 60,1424 61,1424 62 C1423 63,1422 64,1421 65 C1420 66,1419 67,1418 68 C1418 69,1417 69,1417 70 L1427 70 Z" fill="#212121"/></svg></span></p>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; page-break-after: avoid; border-color: #d8dfea; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExample" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExample" style="color: #808080;">//---&nbsp;Adjust&nbsp;the&nbsp;memory&nbsp;gradient&nbsp;to&nbsp;the&nbsp;derivative&nbsp;TANH</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">grad</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #333333;">grad</span><span class="f_CodeExample">&nbsp;*&nbsp;</span><span class="f_CodeExample" style="color: #333333;">og</span><span class="f_CodeExample">&nbsp;*&nbsp;(</span><span class="f_Normal" style="font-family: Arial,Helvetica,sans-serif; color: #000000; background-color: transparent;">1</span><span class="f_CodeExample">&nbsp;-&nbsp;</span><span class="f_Functions">pow</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">m</span><span class="f_CodeExample">,&nbsp;</span><span class="f_Normal" style="font-family: Arial,Helvetica,sans-serif; color: #000000; background-color: transparent;">2</span><span class="f_CodeExample">));</span></p>
</td>
</tr>
</table>
</div>
<p class="p_Text"><span class="f_Text">Now we only need to propagate the error gradient across the remaining internal layers. The algorithm will be the same for all neural layers. The only difference is in the buffer used as a derivative of the multiplication function. After determining the error gradient, we immediately write its value into the appropriate buffer.</span></p>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; page-break-after: avoid; border-color: #d8dfea; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExample" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExample" style="color: #808080;">//---&nbsp;InputGate&nbsp;gradient</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">temp</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #333333;">grad</span><span class="f_CodeExample">&nbsp;*&nbsp;</span><span class="f_CodeExample" style="color: #333333;">nc</span><span class="f_CodeExample">;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">D4ToArray</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">ig_gradients</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">temp</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">shift</span><span class="f_CodeExample">,&nbsp;</span><span class="f_Normal" style="font-family: Arial,Helvetica,sans-serif; color: #000000; background-color: transparent;">1</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">outputs_total</span><span class="f_CodeExample">,&nbsp;</span><span class="f_Normal" style="font-family: Arial,Helvetica,sans-serif; color: #000000; background-color: transparent;">0</span><span class="f_CodeExample">);</span>
<br><span class="f_CodeExample" style="color: #808080;">//---&nbsp;NewContent&nbsp;gradient</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">temp</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #333333;">grad</span><span class="f_CodeExample">&nbsp;*&nbsp;</span><span class="f_CodeExample" style="color: #333333;">ig</span><span class="f_CodeExample">;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">D4ToArray</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">nc_gradients</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">temp</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">shift</span><span class="f_CodeExample">,&nbsp;</span><span class="f_Normal" style="font-family: Arial,Helvetica,sans-serif; color: #000000; background-color: transparent;">1</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">outputs_total</span><span class="f_CodeExample">,&nbsp;</span><span class="f_Normal" style="font-family: Arial,Helvetica,sans-serif; color: #000000; background-color: transparent;">0</span><span class="f_CodeExample">);</span>
<br><span class="f_CodeExample" style="color: #808080;">//---&nbsp;ForgetGates&nbsp;gradient</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">temp</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #333333;">grad</span><span class="f_CodeExample">&nbsp;*&nbsp;</span><span class="f_CodeExample" style="color: #333333;">mem</span><span class="f_CodeExample">;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">D4ToArray</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">fg_gradients</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">temp</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">shift</span><span class="f_CodeExample">,&nbsp;</span><span class="f_Normal" style="font-family: Arial,Helvetica,sans-serif; color: #000000; background-color: transparent;">1</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">outputs_total</span><span class="f_CodeExample">,&nbsp;</span><span class="f_Normal" style="font-family: Arial,Helvetica,sans-serif; color: #000000; background-color: transparent;">0</span><span class="f_CodeExample">);</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;}</span></p>
</td>
</tr>
</table>
</div>
<p class="p_Text"><span class="f_Text">After completing the operations, we exit the kernel.</span></p>
<p class="p_Text"><span class="f_Text">Thus, we implemented the missing kernels to organize forward and backward passes as part of performing operations for a recurrent </span><span class="f_Text" style="font-style: italic;">LSTM </span><span class="f_Text">block. This completes the modification of the OpenCL program, and we move on to performing operations on the side of the main program.</span></p>
<p class="p_Text"><span class="f_Text">&nbsp;</span></p>
<p class="p_H3"><span class="f_H3">4.2.3.2 Implementing functionality on the side of the main program</span></p>
<p class="p_Text"><span class="f_Text">After making changes to the OpenCL program, we must do the second part of the work and organize the process on the side of the main program. The first thing we will do is create constants for working with kernels. Here we need to create constants to identify kernels and their parameters. We will add the specified constants to those previously created in the file </span><span class="f_Text" style="font-style: italic;"><a href="3_4_1_constants.htm#mql5includeneuronetworksbookrealizationdefines.mqh" class="topiclink">defines.mqh</a></span><span class="f_Text">.</span></p>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; page-break-after: avoid; border-color: #d8dfea; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExample" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExample" style="color: #0000ff;">#define</span><span class="f_CodeExample">&nbsp;</span><span class="f_Definition">def_k_LSTMFeedForward</span><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_Normal" style="font-family: Arial,Helvetica,sans-serif; color: #000000; background-color: transparent;">26</span>
<br><span class="f_CodeExample" style="color: #0000ff;">#define</span><span class="f_CodeExample">&nbsp;</span><span class="f_Definition">def_k_LSTMHiddenGradients</span><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_Normal" style="font-family: Arial,Helvetica,sans-serif; color: #000000; background-color: transparent;">27</span></p>
</td>
</tr>
</table>
</div>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; page-break-after: avoid; border-color: #d8dfea; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExample" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExample" style="color: #808080;">//---&nbsp;LSTM&nbsp;Feed&nbsp;Forward</span>
<br><span class="f_CodeExample" style="color: #0000ff;">#define</span><span class="f_CodeExample">&nbsp;</span><span class="f_Definition">def_lstmff_forgetgate</span><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_Normal" style="font-family: Arial,Helvetica,sans-serif; color: #000000; background-color: transparent;">0</span>
<br><span class="f_CodeExample" style="color: #0000ff;">#define</span><span class="f_CodeExample">&nbsp;</span><span class="f_Definition">def_lstmff_inputgate</span><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_Normal" style="font-family: Arial,Helvetica,sans-serif; color: #000000; background-color: transparent;">1</span>
<br><span class="f_CodeExample" style="color: #0000ff;">#define</span><span class="f_CodeExample">&nbsp;</span><span class="f_Definition">def_lstmff_outputgate</span><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_Normal" style="font-family: Arial,Helvetica,sans-serif; color: #000000; background-color: transparent;">2</span>
<br><span class="f_CodeExample" style="color: #0000ff;">#define</span><span class="f_CodeExample">&nbsp;</span><span class="f_Definition">def_lstmff_newcontent</span><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_Normal" style="font-family: Arial,Helvetica,sans-serif; color: #000000; background-color: transparent;">3</span>
<br><span class="f_CodeExample" style="color: #0000ff;">#define</span><span class="f_CodeExample">&nbsp;</span><span class="f_Definition">def_lstmff_memory</span><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_Normal" style="font-family: Arial,Helvetica,sans-serif; color: #000000; background-color: transparent;">4</span>
<br><span class="f_CodeExample" style="color: #0000ff;">#define</span><span class="f_CodeExample">&nbsp;</span><span class="f_Definition">def_lstmff_hiddenstate</span><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_Normal" style="font-family: Arial,Helvetica,sans-serif; color: #000000; background-color: transparent;">5</span>
<br><span class="f_CodeExample" style="color: #0000ff;">#define</span><span class="f_CodeExample">&nbsp;</span><span class="f_Definition">def_lstmff_outputs_total</span><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_Normal" style="font-family: Arial,Helvetica,sans-serif; color: #000000; background-color: transparent;">6</span></p>
</td>
</tr>
</table>
</div>
<p class="p_Text"><span class="f_Text">When adding constants, we follow the previously defined naming rules. All kernel constants begin with the prefix </span><span class="f_Text" style="font-style: italic;">def_k_</span><span class="f_Text">, and parameter constants contain the kernel abbreviation: </span><span class="f_Text" style="font-style: italic;">def_lstmff_</span><span class="f_Text"> for feed-forward kernel parameters and </span><span class="f_Text" style="font-style: italic;">def_lstmhgr_</span><span class="f_Text"> for gradient backpropagation kernel parameters.</span></p>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; page-break-after: avoid; border-color: #d8dfea; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExample" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExample" style="color: #808080;">//---&nbsp;LSTM&nbsp;Hidden&nbsp;Gradients</span>
<br><span class="f_CodeExample" style="color: #0000ff;">#define</span><span class="f_CodeExample">&nbsp;</span><span class="f_Definition">def_lstmhgr_outputs</span><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_Normal" style="font-family: Arial,Helvetica,sans-serif; color: #000000; background-color: transparent;">0</span>
<br><span class="f_CodeExample" style="color: #0000ff;">#define</span><span class="f_CodeExample">&nbsp;</span><span class="f_Definition">def_lstmhgr_gradients</span><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_Normal" style="font-family: Arial,Helvetica,sans-serif; color: #000000; background-color: transparent;">1</span>
<br><span class="f_CodeExample" style="color: #0000ff;">#define</span><span class="f_CodeExample">&nbsp;</span><span class="f_Definition">def_lstmhgr_inputgate</span><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_Normal" style="font-family: Arial,Helvetica,sans-serif; color: #000000; background-color: transparent;">2</span>
<br><span class="f_CodeExample" style="color: #0000ff;">#define</span><span class="f_CodeExample">&nbsp;</span><span class="f_Definition">def_lstmhgr_outputgate</span><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_Normal" style="font-family: Arial,Helvetica,sans-serif; color: #000000; background-color: transparent;">3</span>
<br><span class="f_CodeExample" style="color: #0000ff;">#define</span><span class="f_CodeExample">&nbsp;</span><span class="f_Definition">def_lstmhgr_newcontent</span><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_Normal" style="font-family: Arial,Helvetica,sans-serif; color: #000000; background-color: transparent;">4</span>
<br><span class="f_CodeExample" style="color: #0000ff;">#define</span><span class="f_CodeExample">&nbsp;</span><span class="f_Definition">def_lstmhgr_memory</span><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_Normal" style="font-family: Arial,Helvetica,sans-serif; color: #000000; background-color: transparent;">5</span>
<br><span class="f_CodeExample" style="color: #0000ff;">#define</span><span class="f_CodeExample">&nbsp;</span><span class="f_Definition">def_lstmhgr_fg_gradients</span><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_Normal" style="font-family: Arial,Helvetica,sans-serif; color: #000000; background-color: transparent;">6</span>
<br><span class="f_CodeExample" style="color: #0000ff;">#define</span><span class="f_CodeExample">&nbsp;</span><span class="f_Definition">def_lstmhgr_ig_gradients</span><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_Normal" style="font-family: Arial,Helvetica,sans-serif; color: #000000; background-color: transparent;">7</span>
<br><span class="f_CodeExample" style="color: #0000ff;">#define</span><span class="f_CodeExample">&nbsp;</span><span class="f_Definition">def_lstmhgr_og_gradients</span><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_Normal" style="font-family: Arial,Helvetica,sans-serif; color: #000000; background-color: transparent;">8</span>
<br><span class="f_CodeExample" style="color: #0000ff;">#define</span><span class="f_CodeExample">&nbsp;</span><span class="f_Definition">def_lstmhgr_nc_gradients</span><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_Normal" style="font-family: Arial,Helvetica,sans-serif; color: #000000; background-color: transparent;">9</span>
<br><span class="f_CodeExample" style="color: #0000ff;">#define</span><span class="f_CodeExample">&nbsp;</span><span class="f_Definition">def_lstmhgr_outputs_total</span><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_Normal" style="font-family: Arial,Helvetica,sans-serif; color: #000000; background-color: transparent;">10</span></p>
</td>
</tr>
</table>
</div>
<p class="p_Text"><span class="f_Text">We then go to the </span><span class="f_Text" style="font-style: italic;"><a href="3_4_3_neuron_base.htm" class="topiclink">neuronnet.mqh</a> </span><span class="f_Text">file, which contains the code for our neural network class. In the </span><span class="f_Text" style="font-style: italic;">CNet::InitOpenCL</span><span class="f_Text"> method, we need to change the number of used kernels and simultaneously open buffers.</span></p>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; page-break-after: avoid; border-color: #d8dfea; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExample" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">if</span><span class="f_CodeExample">(!</span><span class="f_CodeExample" style="color: #333333;">m_cOpenCL</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">SetKernelsCount</span><span class="f_CodeExample">(</span><span class="f_Normal" style="font-family: Arial,Helvetica,sans-serif; color: #000000; background-color: transparent;">28</span><span class="f_CodeExample">))</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">m_cOpenCL</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">Shutdown</span><span class="f_CodeExample">();</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">delete</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">m_cOpenCL</span><span class="f_CodeExample">;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">return</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #ff0000;">false</span><span class="f_CodeExample">;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">if</span><span class="f_CodeExample">(!</span><span class="f_CodeExample" style="color: #333333;">m_cOpenCL</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">SetBuffersCount</span><span class="f_CodeExample">(</span><span class="f_Normal" style="font-family: Arial,Helvetica,sans-serif; color: #000000; background-color: transparent;">10</span><span class="f_CodeExample">))</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">m_cOpenCL</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">Shutdown</span><span class="f_CodeExample">();</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">delete</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">m_cOpenCL</span><span class="f_CodeExample">;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">return</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #ff0000;">false</span><span class="f_CodeExample">;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></p>
</td>
</tr>
</table>
</div>
<p class="p_Text"><span class="f_Text">Changing the last parameter is not critical since in our buffer creation method, we, if necessary, change the size of the array for storing buffer handles. However, using the standard </span><span class="f_Text" style="font-style: italic;">OpenCL.mqh</span><span class="f_Text"> library, there is no such functionality. This may result in a runtime error.</span></p>
<p class="p_Text"><span class="f_Text">Next, we declare the kernels for use within our program, while always controlling the process of operations.</span></p>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; page-break-after: avoid; border-color: #d8dfea; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExample" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">if</span><span class="f_CodeExample">(!</span><span class="f_CodeExample" style="color: #333333;">m_cOpenCL</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">KernelCreate</span><span class="f_CodeExample">(</span><span class="f_Definition">def_k_LSTMFeedForward</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #008080;">&quot;LSTMFeedForward&quot;</span><span class="f_CodeExample">))</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">m_cOpenCL</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">Shutdown</span><span class="f_CodeExample">();</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">delete</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">m_cOpenCL</span><span class="f_CodeExample">;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">return</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #ff0000;">false</span><span class="f_CodeExample">;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></p>
</td>
</tr>
</table>
</div>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; page-break-after: avoid; border-color: #d8dfea; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExample" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">if</span><span class="f_CodeExample">(!</span><span class="f_CodeExample" style="color: #333333;">m_cOpenCL</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">KernelCreate</span><span class="f_CodeExample">(</span><span class="f_Definition">def_k_LSTMHiddenGradients</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #008080;">&quot;LSTMCalcHiddenGradient&quot;</span><span class="f_CodeExample">))</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">m_cOpenCL</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">Shutdown</span><span class="f_CodeExample">();</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">delete</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">m_cOpenCL</span><span class="f_CodeExample">;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">return</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #ff0000;">false</span><span class="f_CodeExample">;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></p>
</td>
</tr>
</table>
</div>
<p class="p_Text"><span class="f_Text">This completes the preparatory work, and we move on to making changes directly to the code of the executable methods of our recurrent </span><span class="f_Text" style="font-style: italic;">LSTM</span><span class="f_Text"> block class.</span></p>
<p class="p_Text"><span class="f_Text">According to the chronology of the execution of the algorithm of our neural network, we will be the first to make changes to the feed-forward method. In it, we first organize a check for the presence of data in the memory of the OpenCL context.</span></p>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; page-break-after: avoid; border-color: #d8dfea; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExample" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExample" style="color: #0000ff;">bool</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">CNeuronLSTM</span><span class="f_CodeExample">::</span><span class="f_CodeExample" style="color: #333333;">FeedForward</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">CNeuronBase</span><span class="f_CodeExample">&nbsp;*</span><span class="f_CodeExample" style="color: #333333;">prevLayer</span><span class="f_CodeExample">)</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;{</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;....&nbsp;&nbsp;&nbsp;</span>
<br><span class="f_CodeExample" style="color: #808080;">//---&nbsp;Branching&nbsp;of&nbsp;the&nbsp;algorithm&nbsp;by&nbsp;the&nbsp;computing&nbsp;device</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">CBufferType</span><span class="f_CodeExample">&nbsp;*</span><span class="f_CodeExample" style="color: #333333;">fg</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #333333;">m_cForgetGate</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">GetOutputs</span><span class="f_CodeExample">();</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">CBufferType</span><span class="f_CodeExample">&nbsp;*</span><span class="f_CodeExample" style="color: #333333;">ig</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #333333;">m_cInputGate</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">GetOutputs</span><span class="f_CodeExample">();</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">CBufferType</span><span class="f_CodeExample">&nbsp;*</span><span class="f_CodeExample" style="color: #333333;">og</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #333333;">m_cOutputGate</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">GetOutputs</span><span class="f_CodeExample">();</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">CBufferType</span><span class="f_CodeExample">&nbsp;*</span><span class="f_CodeExample" style="color: #333333;">nc</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #333333;">m_cNewContent</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">GetOutputs</span><span class="f_CodeExample">();</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">if</span><span class="f_CodeExample">(!</span><span class="f_CodeExample" style="color: #333333;">m_cOpenCL</span><span class="f_CodeExample">)</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #808080;">//&nbsp;MQL5&nbsp;Block&nbsp;is&nbsp;missing&nbsp;here</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">else</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #808080;">//&nbsp;Block&nbsp;for&nbsp;working&nbsp;with&nbsp;OpenCL</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #808080;">//---&nbsp;check&nbsp;buffers</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">if</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">fg</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">GetIndex</span><span class="f_CodeExample">()&nbsp;&lt;&nbsp;</span><span class="f_Normal" style="font-family: Arial,Helvetica,sans-serif; color: #000000; background-color: transparent;">0</span><span class="f_CodeExample">&nbsp;||&nbsp;</span><span class="f_CodeExample" style="color: #333333;">ig</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">GetIndex</span><span class="f_CodeExample">()&nbsp;&lt;&nbsp;</span><span class="f_Normal" style="font-family: Arial,Helvetica,sans-serif; color: #000000; background-color: transparent;">0</span><span class="f_CodeExample">&nbsp;||&nbsp;</span><span class="f_CodeExample" style="color: #333333;">og</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">GetIndex</span><span class="f_CodeExample">()&nbsp;&lt;&nbsp;</span><span class="f_Normal" style="font-family: Arial,Helvetica,sans-serif; color: #000000; background-color: transparent;">0</span><span class="f_CodeExample">&nbsp;||</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">nc</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">GetIndex</span><span class="f_CodeExample">()&nbsp;&lt;&nbsp;</span><span class="f_Normal" style="font-family: Arial,Helvetica,sans-serif; color: #000000; background-color: transparent;">0</span><span class="f_CodeExample">&nbsp;||&nbsp;</span><span class="f_CodeExample" style="color: #333333;">memory</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">GetIndex</span><span class="f_CodeExample">()&nbsp;&lt;&nbsp;</span><span class="f_Normal" style="font-family: Arial,Helvetica,sans-serif; color: #000000; background-color: transparent;">0</span><span class="f_CodeExample">&nbsp;||&nbsp;</span><span class="f_CodeExample" style="color: #333333;">hidden</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">GetIndex</span><span class="f_CodeExample">()&nbsp;&lt;&nbsp;</span><span class="f_Normal" style="font-family: Arial,Helvetica,sans-serif; color: #000000; background-color: transparent;">0</span><span class="f_CodeExample">)</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">return</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #ff0000;">false</span><span class="f_CodeExample">;</span></p>
</td>
</tr>
</table>
</div>
<p class="p_Text"><span class="f_Text">We then pass pointers to the created buffers to our kernel parameters. Here we indicate the constants necessary for the correct execution of the program code. Again, we check the results of the operations.</span></p>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; page-break-after: avoid; border-color: #d8dfea; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExample" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #808080;">//---&nbsp;pass&nbsp;parameters&nbsp;to&nbsp;the&nbsp;kernel</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">if</span><span class="f_CodeExample">(!</span><span class="f_CodeExample" style="color: #333333;">m_cOpenCL</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">SetArgumentBuffer</span><span class="f_CodeExample">(</span><span class="f_Definition">def_k_LSTMFeedForward</span><span class="f_CodeExample">,&nbsp;</span><span class="f_Definition">def_lstmff_forgetgate</span><span class="f_CodeExample">,</span>
<br><span class="f_CodeExample" style="color: #333333;">&nbsp;fg</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">GetIndex</span><span class="f_CodeExample">()))</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">return</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #ff0000;">false</span><span class="f_CodeExample">;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">if</span><span class="f_CodeExample">(!</span><span class="f_CodeExample" style="color: #333333;">m_cOpenCL</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">SetArgumentBuffer</span><span class="f_CodeExample">(</span><span class="f_Definition">def_k_LSTMFeedForward</span><span class="f_CodeExample">,&nbsp;</span><span class="f_Definition">def_lstmff_inputgate</span><span class="f_CodeExample">,</span>
<br><span class="f_CodeExample" style="color: #333333;">&nbsp;ig</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">GetIndex</span><span class="f_CodeExample">()))</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">return</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #ff0000;">false</span><span class="f_CodeExample">;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">if</span><span class="f_CodeExample">(!</span><span class="f_CodeExample" style="color: #333333;">m_cOpenCL</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">SetArgumentBuffer</span><span class="f_CodeExample">(</span><span class="f_Definition">def_k_LSTMFeedForward</span><span class="f_CodeExample">,&nbsp;</span><span class="f_Definition">def_lstmff_newcontent</span><span class="f_CodeExample">,</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">nc</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">GetIndex</span><span class="f_CodeExample">()))</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">return</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #ff0000;">false</span><span class="f_CodeExample">;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">if</span><span class="f_CodeExample">(!</span><span class="f_CodeExample" style="color: #333333;">m_cOpenCL</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">SetArgumentBuffer</span><span class="f_CodeExample">(</span><span class="f_Definition">def_k_LSTMFeedForward</span><span class="f_CodeExample">,&nbsp;</span><span class="f_Definition">def_lstmff_outputgate</span><span class="f_CodeExample">,</span>
<br><span class="f_CodeExample" style="color: #333333;">&nbsp;og</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">GetIndex</span><span class="f_CodeExample">()))</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">return</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #ff0000;">false</span><span class="f_CodeExample">;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">if</span><span class="f_CodeExample">(!</span><span class="f_CodeExample" style="color: #333333;">m_cOpenCL</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">SetArgumentBuffer</span><span class="f_CodeExample">(</span><span class="f_Definition">def_k_LSTMFeedForward</span><span class="f_CodeExample">,&nbsp;</span><span class="f_Definition">def_lstmff_memory</span><span class="f_CodeExample">,</span>
<br><span class="f_CodeExample" style="color: #333333;">&nbsp;memory</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">GetIndex</span><span class="f_CodeExample">()))</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">return</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #ff0000;">false</span><span class="f_CodeExample">;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">if</span><span class="f_CodeExample">(!</span><span class="f_CodeExample" style="color: #333333;">m_cOpenCL</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">SetArgumentBuffer</span><span class="f_CodeExample">(</span><span class="f_Definition">def_k_LSTMFeedForward</span><span class="f_CodeExample">,&nbsp;</span><span class="f_Definition">def_lstmff_hiddenstate</span><span class="f_CodeExample">,</span>
<br><span class="f_CodeExample" style="color: #333333;">&nbsp;hidden</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">GetIndex</span><span class="f_CodeExample">()))</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">return</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #ff0000;">false</span><span class="f_CodeExample">;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">if</span><span class="f_CodeExample">(!</span><span class="f_CodeExample" style="color: #333333;">m_cOpenCL</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">SetArgument</span><span class="f_CodeExample">(</span><span class="f_Definition">def_k_LSTMFeedForward</span><span class="f_CodeExample">,&nbsp;</span><span class="f_Definition">def_lstmff_outputs_total</span><span class="f_CodeExample">,</span>
<br><span class="f_CodeExample" style="color: #333333;">&nbsp;m_cOutputs</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">Total</span><span class="f_CodeExample">()))</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">return</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #ff0000;">false</span><span class="f_CodeExample">;</span></p>
</td>
</tr>
</table>
</div>
<p class="p_Text"><span class="f_Text">This completes the preparatory work stage. Let's move on to launching the kernel to perform operations. First, let's determine the number of required threads. In the kernel body, we use vector operations and therefore the number of threads will be four times less than the size of the buffers.</span></p>
<p class="p_Text"><span class="f_Text">We write the calculated number of threads into the </span><span class="f_Text" style="font-style: italic;">NDRange</span><span class="f_Text">array and indicate the zero offset in the data buffers in the </span><span class="f_Text" style="font-style: italic;">off_set </span><span class="f_Text">array. The kernel is added in the execution queue. If an error occurs when queuing the kernel, the </span><span class="f_Text" style="font-style: italic;">m_cOpenCL.Execute</span><span class="f_Text"> function will return a </span><span class="f_Text" style="font-style: italic;">false </span><span class="f_Text">result, which we must check and process.</span></p>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; page-break-after: avoid; border-color: #d8dfea; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExample" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #808080;">//---&nbsp;launch&nbsp;the&nbsp;kernel</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">int</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">NDRange</span><span class="f_CodeExample">[]&nbsp;=&nbsp;{(</span><span class="f_CodeExample" style="color: #0000ff;">int</span><span class="f_CodeExample">)(</span><span class="f_CodeExample" style="color: #333333;">m_cOutputs</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">Total</span><span class="f_CodeExample">()&nbsp;+&nbsp;</span><span class="f_Normal" style="font-family: Arial,Helvetica,sans-serif; color: #000000; background-color: transparent;">3</span><span class="f_CodeExample">)&nbsp;/&nbsp;</span><span class="f_Normal" style="font-family: Arial,Helvetica,sans-serif; color: #000000; background-color: transparent;">4</span><span class="f_CodeExample">};</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">int</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">off_set</span><span class="f_CodeExample">[]&nbsp;=&nbsp;{</span><span class="f_Normal" style="font-family: Arial,Helvetica,sans-serif; color: #000000; background-color: transparent;">0</span><span class="f_CodeExample">};</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">if</span><span class="f_CodeExample">(!</span><span class="f_CodeExample" style="color: #333333;">m_cOpenCL</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">Execute</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">def_k_LSTMFeedForward</span><span class="f_CodeExample">,&nbsp;</span><span class="f_Normal" style="font-family: Arial,Helvetica,sans-serif; color: #000000; background-color: transparent;">1</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">off_set</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">NDRange</span><span class="f_CodeExample">))</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">return</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #ff0000;">false</span><span class="f_CodeExample">;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></p>
</td>
</tr>
</table>
</div>
<p class="p_Text"><span class="f_Text">This completes the work on the </span><span class="f_Text" style="font-style: italic;">LSTM </span><span class="f_Text">feed-forward method. Let's move on to making additions to the backpropagation method.</span></p>
<p class="p_Text"><span class="f_Text">As in the case of the feed-forward pass, we will begin work in the error gradient distribution method </span><span class="f_Text" style="font-style: italic;">CNeuronLSTM::CalcHiddenGradient</span><span class="f_Text"> by checking the presence of source data in the OpenCL context memory.</span></p>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; page-break-after: avoid; border-color: #d8dfea; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExample" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExample" style="color: #0000ff;">bool</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">CNeuronLSTM</span><span class="f_CodeExample">::</span><span class="f_CodeExample" style="color: #333333;">CalcHiddenGradient</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">CNeuronBase</span><span class="f_CodeExample">&nbsp;*</span><span class="f_CodeExample" style="color: #333333;">prevLayer</span><span class="f_CodeExample">)</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;{</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;....&nbsp;&nbsp;&nbsp;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #808080;">//---&nbsp;Branching&nbsp;the&nbsp;algorithm&nbsp;by&nbsp;the&nbsp;computing&nbsp;device</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">if</span><span class="f_CodeExample">(!</span><span class="f_CodeExample" style="color: #333333;">m_cOpenCL</span><span class="f_CodeExample">)</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #808080;">//&nbsp;MQL5&nbsp;Block&nbsp;is&nbsp;missing&nbsp;here</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></p>
</td>
</tr>
</table>
</div>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; page-break-after: avoid; border-color: #d8dfea; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExample" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">else</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #808080;">//&nbsp;Block&nbsp;for&nbsp;working&nbsp;with&nbsp;OpenCL</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #808080;">//---&nbsp;check&nbsp;buffers</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">if</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">hidden</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">GetIndex</span><span class="f_CodeExample">()&nbsp;&lt;&nbsp;</span><span class="f_Normal" style="font-family: Arial,Helvetica,sans-serif; color: #000000; background-color: transparent;">0</span><span class="f_CodeExample">)</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">return</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #ff0000;">false</span><span class="f_CodeExample">;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">if</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">m_cGradients</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">GetIndex</span><span class="f_CodeExample">()&nbsp;&lt;&nbsp;</span><span class="f_Normal" style="font-family: Arial,Helvetica,sans-serif; color: #000000; background-color: transparent;">0</span><span class="f_CodeExample">)</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">return</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #ff0000;">false</span><span class="f_CodeExample">;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">if</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">ig</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">GetIndex</span><span class="f_CodeExample">()&nbsp;&lt;&nbsp;</span><span class="f_Normal" style="font-family: Arial,Helvetica,sans-serif; color: #000000; background-color: transparent;">0</span><span class="f_CodeExample">)</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">return</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #ff0000;">false</span><span class="f_CodeExample">;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">if</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">og</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">GetIndex</span><span class="f_CodeExample">()&nbsp;&lt;&nbsp;</span><span class="f_Normal" style="font-family: Arial,Helvetica,sans-serif; color: #000000; background-color: transparent;">0</span><span class="f_CodeExample">)</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">return</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #ff0000;">false</span><span class="f_CodeExample">;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">if</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">nc</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">GetIndex</span><span class="f_CodeExample">()&nbsp;&lt;&nbsp;</span><span class="f_Normal" style="font-family: Arial,Helvetica,sans-serif; color: #000000; background-color: transparent;">0</span><span class="f_CodeExample">)</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">return</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #ff0000;">false</span><span class="f_CodeExample">;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">if</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">memory</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">GetIndex</span><span class="f_CodeExample">()&nbsp;&lt;&nbsp;</span><span class="f_Normal" style="font-family: Arial,Helvetica,sans-serif; color: #000000; background-color: transparent;">0</span><span class="f_CodeExample">)</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">return</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #ff0000;">false</span><span class="f_CodeExample">;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">if</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">fg_grad</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">GetIndex</span><span class="f_CodeExample">()&nbsp;&lt;&nbsp;</span><span class="f_Normal" style="font-family: Arial,Helvetica,sans-serif; color: #000000; background-color: transparent;">0</span><span class="f_CodeExample">)</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">return</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #ff0000;">false</span><span class="f_CodeExample">;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">if</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">ig_grad</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">GetIndex</span><span class="f_CodeExample">()&nbsp;&lt;&nbsp;</span><span class="f_Normal" style="font-family: Arial,Helvetica,sans-serif; color: #000000; background-color: transparent;">0</span><span class="f_CodeExample">)</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">return</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #ff0000;">false</span><span class="f_CodeExample">;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">if</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">og_grad</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">GetIndex</span><span class="f_CodeExample">()&nbsp;&lt;&nbsp;</span><span class="f_Normal" style="font-family: Arial,Helvetica,sans-serif; color: #000000; background-color: transparent;">0</span><span class="f_CodeExample">)</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">return</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #ff0000;">false</span><span class="f_CodeExample">;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">if</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">nc_grad</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">GetIndex</span><span class="f_CodeExample">()&nbsp;&lt;&nbsp;</span><span class="f_Normal" style="font-family: Arial,Helvetica,sans-serif; color: #000000; background-color: transparent;">0</span><span class="f_CodeExample">)</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">return</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #ff0000;">false</span><span class="f_CodeExample">;</span></p>
</td>
</tr>
</table>
</div>
<p class="p_Text"><span class="f_Text">Next, we completely repeat the algorithm for working with OpenCL kernels on the side of the main program. After creating the necessary buffers in the OpenCL context memory, we pass the data buffer handles and variable values to the kernel parameters. And it is very important to monitor the execution of all process operations.</span></p>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; page-break-after: avoid; border-color: #d8dfea; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExample" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #808080;">//---&nbsp;pass&nbsp;parameters&nbsp;to&nbsp;the&nbsp;kernel</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">if</span><span class="f_CodeExample">(!</span><span class="f_CodeExample" style="color: #333333;">m_cOpenCL</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">SetArgumentBuffer</span><span class="f_CodeExample">(</span><span class="f_Definition">def_k_LSTMHiddenGradients</span><span class="f_CodeExample">,</span>
<br><span class="f_CodeExample" style="color: #333333;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_Definition">def_lstmhgr_fg_gradients</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">fg_grad</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">GetIndex</span><span class="f_CodeExample">()))</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">return</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #ff0000;">false</span><span class="f_CodeExample">;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">if</span><span class="f_CodeExample">(!</span><span class="f_CodeExample" style="color: #333333;">m_cOpenCL</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">SetArgumentBuffer</span><span class="f_CodeExample">(</span><span class="f_Definition">def_k_LSTMHiddenGradients</span><span class="f_CodeExample">,</span>
<br><span class="f_CodeExample" style="color: #333333;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_Definition">def_lstmhgr_gradients</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">m_cGradients</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">GetIndex</span><span class="f_CodeExample">()))</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">return</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #ff0000;">false</span><span class="f_CodeExample">;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">if</span><span class="f_CodeExample">(!</span><span class="f_CodeExample" style="color: #333333;">m_cOpenCL</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">SetArgumentBuffer</span><span class="f_CodeExample">(</span><span class="f_Definition">def_k_LSTMHiddenGradients</span><span class="f_CodeExample">,</span>
<br><span class="f_CodeExample" style="color: #333333;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_Definition">def_lstmhgr_ig_gradients</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">ig_grad</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">GetIndex</span><span class="f_CodeExample">()))</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">return</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #ff0000;">false</span><span class="f_CodeExample">;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">if</span><span class="f_CodeExample">(!</span><span class="f_CodeExample" style="color: #333333;">m_cOpenCL</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">SetArgumentBuffer</span><span class="f_CodeExample">(</span><span class="f_Definition">def_k_LSTMHiddenGradients</span><span class="f_CodeExample">,</span>
<br><span class="f_CodeExample" style="color: #333333;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_Definition">def_lstmhgr_inputgate</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">ig</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">GetIndex</span><span class="f_CodeExample">()))</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">return</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #ff0000;">false</span><span class="f_CodeExample">;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">if</span><span class="f_CodeExample">(!</span><span class="f_CodeExample" style="color: #333333;">m_cOpenCL</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">SetArgumentBuffer</span><span class="f_CodeExample">(</span><span class="f_Definition">def_k_LSTMHiddenGradients</span><span class="f_CodeExample">,</span>
<br><span class="f_CodeExample" style="color: #333333;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_Definition">def_lstmhgr_memory</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">memory</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">GetIndex</span><span class="f_CodeExample">()))</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">return</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #ff0000;">false</span><span class="f_CodeExample">;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">if</span><span class="f_CodeExample">(!</span><span class="f_CodeExample" style="color: #333333;">m_cOpenCL</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">SetArgumentBuffer</span><span class="f_CodeExample">(</span><span class="f_Definition">def_k_LSTMHiddenGradients</span><span class="f_CodeExample">,&nbsp;</span>
<br><span class="f_Definition">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;def_lstmhgr_nc_gradients</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">nc_grad</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">GetIndex</span><span class="f_CodeExample">()))</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">return</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #ff0000;">false</span><span class="f_CodeExample">;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">if</span><span class="f_CodeExample">(!</span><span class="f_CodeExample" style="color: #333333;">m_cOpenCL</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">SetArgumentBuffer</span><span class="f_CodeExample">(</span><span class="f_Definition">def_k_LSTMHiddenGradients</span><span class="f_CodeExample">,</span>
<br><span class="f_CodeExample" style="color: #333333;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_Definition">def_lstmhgr_newcontent</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">nc</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">GetIndex</span><span class="f_CodeExample">()))</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">return</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #ff0000;">false</span><span class="f_CodeExample">;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">if</span><span class="f_CodeExample">(!</span><span class="f_CodeExample" style="color: #333333;">m_cOpenCL</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">SetArgumentBuffer</span><span class="f_CodeExample">(</span><span class="f_Definition">def_k_LSTMHiddenGradients</span><span class="f_CodeExample">,</span>
<br><span class="f_CodeExample" style="color: #333333;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_Definition">def_lstmhgr_og_gradients</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">og_grad</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">GetIndex</span><span class="f_CodeExample">()))</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">return</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #ff0000;">false</span><span class="f_CodeExample">;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">if</span><span class="f_CodeExample">(!</span><span class="f_CodeExample" style="color: #333333;">m_cOpenCL</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">SetArgumentBuffer</span><span class="f_CodeExample">(</span><span class="f_Definition">def_k_LSTMHiddenGradients</span><span class="f_CodeExample">,</span>
<br><span class="f_CodeExample" style="color: #333333;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_Definition">def_lstmhgr_outputgate</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">og</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">GetIndex</span><span class="f_CodeExample">()))</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">return</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #ff0000;">false</span><span class="f_CodeExample">;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">if</span><span class="f_CodeExample">(!</span><span class="f_CodeExample" style="color: #333333;">m_cOpenCL</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">SetArgumentBuffer</span><span class="f_CodeExample">(</span><span class="f_Definition">def_k_LSTMHiddenGradients</span><span class="f_CodeExample">,</span>
<br><span class="f_CodeExample" style="color: #333333;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_Definition">def_lstmhgr_outputs</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">hidden</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">GetIndex</span><span class="f_CodeExample">()))</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">return</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #ff0000;">false</span><span class="f_CodeExample">;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">if</span><span class="f_CodeExample">(!</span><span class="f_CodeExample" style="color: #333333;">m_cOpenCL</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">SetArgument</span><span class="f_CodeExample">(</span><span class="f_Definition">def_k_LSTMHiddenGradients</span><span class="f_CodeExample">,</span>
<br><span class="f_CodeExample" style="color: #333333;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_Definition">def_lstmhgr_outputs_total</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">m_cOutputs</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">Total</span><span class="f_CodeExample">()))</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">return</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #ff0000;">false</span><span class="f_CodeExample">;</span></p>
</td>
</tr>
</table>
</div>
<p class="p_Text"><span class="f_Text">This concludes the stage of preparatory work. We move on to the procedure for launching the kernel. First of all, here we write the number of threads to start in the </span><span class="f_Text" style="font-style: italic;">NDRange</span><span class="f_Text"> array and the zero offset in the </span><span class="f_Text" style="font-style: italic;">off_set </span><span class="f_Text">array.</span></p>
<p class="p_Text"><span class="f_Text">Thanks to the use of vector operations in the kernel body, we need four times fewer threads for the full cycle of operations. Therefore, before we write the value to the </span><span class="f_Text" style="font-style: italic;">NDRange</span><span class="f_Text">array, we need to calculate it.</span></p>
<p class="p_Text"><span class="f_Text">After this, we will send our kernel to the execution queue.</span></p>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; page-break-after: avoid; border-color: #d8dfea; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExample" style="page-break-inside: avoid; page-break-after: avoid;"><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #808080;">//---&nbsp;launch&nbsp;the&nbsp;kernel</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">int</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">NDRange</span><span class="f_CodeExample">[]&nbsp;=&nbsp;{&nbsp;(</span><span class="f_CodeExample" style="color: #0000ff;">int</span><span class="f_CodeExample">)(</span><span class="f_CodeExample" style="color: #333333;">m_cOutputs</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">Total</span><span class="f_CodeExample">()&nbsp;+&nbsp;</span><span class="f_Normal" style="font-family: Arial,Helvetica,sans-serif; color: #000000; background-color: transparent;">3</span><span class="f_CodeExample">)&nbsp;/&nbsp;</span><span class="f_Normal" style="font-family: Arial,Helvetica,sans-serif; color: #000000; background-color: transparent;">4</span><span class="f_CodeExample">&nbsp;};</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">int</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">off_set</span><span class="f_CodeExample">[]&nbsp;=&nbsp;{</span><span class="f_Normal" style="font-family: Arial,Helvetica,sans-serif; color: #000000; background-color: transparent;">0</span><span class="f_CodeExample">};</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">if</span><span class="f_CodeExample">(!</span><span class="f_CodeExample" style="color: #333333;">m_cOpenCL</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">Execute</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #333333;">def_k_LSTMHiddenGradients</span><span class="f_CodeExample">,&nbsp;</span><span class="f_Normal" style="font-family: Arial,Helvetica,sans-serif; color: #000000; background-color: transparent;">1</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">off_set</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #333333;">NDRange</span><span class="f_CodeExample">))</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #0000ff;">return</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #ff0000;">false</span><span class="f_CodeExample">;</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></p>
</td>
</tr>
</table>
</div>
<p class="p_Text"><span class="f_Text">I might sound repetitive, but I want to stress the importance of checking the result of each operation. This is a crucial point since any error in performing the operation can both distort the entire result of our neural network and cause a critical error, resulting in the termination of the entire program.</span></p>
<p class="p_Text"><span class="f_Text">With this, we have completed the work on the recurrent </span><span class="f_Text" style="font-style: italic;">LSTM </span><span class="f_Text">block class. We have organized the class to work in two environments:</span></p>
<ul style="list-style-type:disc">
<li class="p_li"><span class="f_li">Implemented operation on the CPU using standard MQL5 tools.</span></li>
<li class="p_li"><span class="f_li">Created the ability to implement multi-threaded parallel calculations using OpenCL.</span></li>
</ul>
<p class="p_Text"><span class="f_Text">Now, we can evaluate the results of our work by creating and testing a recurrent neural network model.</span></p>

</div>

</body>
</html>
