# MQL5 Help MCP Server

[![npm package](https://img.shields.io/npm/v/mql5-help-mcp.svg)](https://npmjs.org/package/mql5-help-mcp)

`mql5-help-mcp` 让你的 AI 编程助手（Claude Code、Cursor、Copilot、Gemini CLI 等）直接访问本地的 MQL5 文档与学习资料库。基于 Model Context Protocol (MCP)，为 AI 助手提供 4500+ 官方文档与两本补充电子书（HTML）的快速检索能力，助你更高效地完成 EA/指标/脚本开发与调试。

## 有哪些资料被内置？

- 官方 MQL5 文档：`MQL5_HELP/`（4500+ .htm）
- MQL5 算法交易手册（HTML）：`MQL5_Algo_Book/`
- 神经网络与机器学习手册（HTML）：`Neural_Networks_Book/`

> 说明：两本电子书版权归原作者所有，仅作为学习参考随仓库分发；当前版本主要对 `MQL5_HELP/` 做了完整索引，电子书的统一索引与搜索将在后续版本补充（Roadmap 已列出）。

## 面向问题的能力（结合用户建议重构）

当前可用 + 规划中功能一览：

- 搜索文档（已提供）
  - 通过函数名、类名或关键词快速定位官方文档
  - 覆盖交易函数、指标、标准库、ONNX 等常用主题
- 智能匹配（已提供基础能力）
  - 支持精确/模糊匹配，兼容常见类名变体（如 CTrade/Trade）
- 常见错误解决方案库（进行中）
  - 错误 256/undeclared identifier 等典型问题的成因与对照表
  - MQL4→MQL5 迁移差异：Symbol()→_Symbol，Period()→_Period，ResultCode()→ResultRetcode()
- 智能错误匹配（规划中）
  - 直接用“编译器错误文本”搜索：如 `error 256: undeclared identifier ResultCode`
- 上下文感知搜索（规划中）
  - 术语映射与别名：如 MQL4 的 `iMA` → MQL5 的 `IndicatorCreate`
- 代码分析与诊断（规划中）
  - `analyze_code`：指出 API 更名与常见误用
  - `diagnose_error`：基于编译错误日志给出定位与替代建议
- 交互式帮助（规划中）
  - 支持“针对某一行代码/某一错误”的追问式问答
- 学习路径推荐（规划中）
  - 从“语法差异 → 标准库 → 指标/交易 → 性能优化”的循序内容
- 多维标签与版本标注（规划中）
  - 难度/用途/版本/主题等维度过滤；明确 MQL4 兼容信息

> 优先级：
> - 高：智能错误匹配、错误解决方案库、代码示例
> - 中：上下文感知搜索、交互式帮助、学习路径
> - 低：代码分析、标签系统、版本标注（细化）

## 快速开始

### 前提条件

- Node.js 18.0 或更高版本
- npm 或 npx

### 🚀 Claude Code 用户快速安装（最简单）

如果你使用 Claude Code，可以直接在命令行运行：

```bash
claude mcp add mql5-help npx -- -y github:caoshuo594/mql5-help-mcp
```

安装后验证：

```bash
claude mcp list
```

你应该看到 `mql5-help` 显示为 `✓ Connected`。

> **首次安装注意**：第一次运行时，npx 需要从 GitHub 下载源代码、安装依赖并编译 TypeScript，可能需要 10-30 秒。如果首次显示连接失败，请稍等片刻后再次运行 `claude mcp list` 检查状态。

---

### 安装方式 1：直接从 GitHub 安装（手动配置）

使用 `npx` 直接从 GitHub 运行，无需手动克隆或构建：

```json
{
  "mcpServers": {
    "mql5-help": {
      "command": "npx",
      "args": ["-y", "github:caoshuo594/mql5-help-mcp"]
    }
  }
}
```

> **提示**：使用 `github:caoshuo594/mql5-help-mcp` 可直接从 GitHub 获取最新版本。npm 会自动：
> 1. 下载源代码
> 2. 安装依赖
> 3. 运行 `prepare` 脚本编译 TypeScript
> 4. 启动服务器

### 安装方式 2：从 npm 安装

如果包已发布到 npm：

```json
{
  "mcpServers": {
    "mql5-help": {
      "command": "npx",
      "args": ["-y", "mql5-help-mcp"]
    }
  }
}
```

### 安装方式 3：本地开发模式

适用于需要修改代码或贡献的开发者：

```bash
# 1. 克隆仓库
git clone https://github.com/caoshuo594/mql5-help-mcp.git
cd mql5-help-mcp

# 2. 安装依赖
npm install

# 3. 编译 TypeScript 源码
npm run build
```

然后在 MCP 配置中使用绝对路径：

**Windows 示例：**
```json
{
  "mcpServers": {
    "mql5-help": {
      "command": "node",
      "args": ["D:/my-program/mql5-help-mcp/build/index.js"]
    }
  }
}
```

**macOS/Linux 示例：**
```json
{
  "mcpServers": {
    "mql5-help": {
      "command": "node",
      "args": ["/home/user/projects/mql5-help-mcp/build/index.js"]
    }
  }
}
```

> **Windows 路径注意**：使用正斜杠 `/` 或双反斜杠 `\\\\`（在 JSON 中）

### Claude Code 配置位置

配置文件位置：
- **Windows**: `%USERPROFILE%\.claude\claude_desktop_config.json`
- **macOS**: `~/Library/Application Support/Claude/claude_desktop_config.json`
- **Linux**: `~/.config/claude/claude_desktop_config.json`

### 测试你的配置

配置完成后，在 Claude Code 或其他 AI 助手中测试以下命令：

#### 示例 1：搜索函数文档

```
搜索 MQL5 的 OrderSend 函数用法
```

AI 助手会调用 `search` 工具，返回相关文档列表。

#### 示例 2：获取详细文档

```
获取 CTrade 类的完整文档
```

AI 助手会调用 `get` 工具，返回 CTrade 类的详细说明。

#### 示例 3：浏览分类

```
浏览 MQL5 的交易相关文档有哪些？
```

AI 助手会调用 `browse` 工具，显示 trading 分类下的所有文档。

#### 示例 4：错误诊断（Smart Query - 推荐）

```
我的代码报错：error 256: undeclared identifier ResultCode，怎么解决？
```

AI 助手会自动调用 `smart_query`，直接返回解决方案：
- 诊断: ResultCode → ResultRetcode (MQL5迁移)
- 语法: ulong CTrade::ResultRetcode() const
- 示例代码
- 只消耗 ~500 tokens (vs 传统方式 4000+)

#### 验证 MCP 工具可用性

你也可以直接要求 AI 列出可用的 MQL5 工具：

```
列出你可以使用的 MQL5 文档工具
```

AI 应该会显示三个工具：`search`、`get`、`browse`。

## 工具列表（现有）

本 MCP 服务器当前提供 3 个工具：

1) `search` - 搜索文档
- 参数：`query`（必填，关键词），`limit`（可选，默认 10）
- 示例：
  - “搜索与订单发送相关的函数”
  - “查找 ONNX 模型相关的文档”

2) `get` - 获取文档详情
- 参数：`filename`（必填，如 `ordersend.htm` 或 `ordersend`）
- 示例：
  - “获取 OrderSend 的完整文档”
  - “查看 CTrade 类的详细说明”

3) `browse` - 浏览分类目录
- 参数：`category`（可选，如 `trading`, `indicators`, `math` 等）
- 常见分类：`trading`, `indicators`, `math`, `array`, `string`, `datetime`, `files`, `chart`, `objects`, `onnx`

> 关于两本电子书：当前版本优先索引 `MQL5_HELP/`；对 `MQL5_Algo_Book/` 与 `Neural_Networks_Book/` 的“统一搜索与浏览分类”将随 Roadmap 开启，届时可通过 `browse` 与 `search` 在一个入口里检索。

## 示例与最佳实践

### 1. MQL4 → MQL5 迁移常见差异

- 预定义变量：`Symbol()` → `_Symbol`，`Period()` → `_Period`
- CTrade 结果：`ResultCode()` → `ResultRetcode()`
- 指标创建：`iMA(...)`（MQL4 习惯）→ `IndicatorCreate(...)`（MQL5 推荐）

示例（买入操作）：

```mql5
CTrade trade;
trade.SetExpertMagicNumber(12345);
if (trade.Buy(0.1, _Symbol)) {
  Print("买入成功，retcode=", trade.ResultRetcode());
}
```

### 2. 以错误文本驱动的搜索（规划中）

输入：

```
error 256: undeclared identifier ResultCode
```

期望返回：

- 解释“ResultCode 已改名为 ResultRetcode（MQL5）”
- 指向 CTrade 类文档与迁移指南

### 3. 交互式诊断（规划中）

```
mcp__mql5-help__diagnose_error(`
ma_cross_ea.mq5(155,39) : error 256: undeclared identifier 'ResultCode'
`)
```

期望：定位第 155 行问题并给出替代 API。

## 项目结构（含电子书）

```
mql5-help-mcp/
├── src/                       # TypeScript 源码
│   └── index.ts               # MCP 服务器实现
├── build/                     # 编译输出
├── MQL5_HELP/                 # 官方 MQL5 文档（4500+ .htm）
├── MQL5_Algo_Book/            # 算法交易手册（HTML 电子书）
├── Neural_Networks_Book/      # 神经网络/机器学习手册（HTML 电子书）
├── scripts/
├── package.json
├── tsconfig.json
└── README.md
```

## 工作原理（概览）

```
AI 助手（MCP 客户端） → MQL5 Help MCP Server → 本地 HTML 文档（解析/索引/检索）
```

1) 客户端基于 MCP 调用工具；2) 服务端查询内存索引或解析 HTML；3) 返回结果给助手整合回答。

## 故障排除

### 1. 首次安装显示 "Failed to connect"

**症状**：运行 `claude mcp list` 显示 `mql5-help - ✗ Failed to connect`

**原因**：首次从 GitHub 安装时，npx 需要下载、安装依赖并编译 TypeScript，这个过程需要时间。

**解决方法**：
1. 等待 10-30 秒
2. 再次运行 `claude mcp list` 检查状态
3. 如果仍然失败，手动测试服务器：
   ```bash
   npx -y github:caoshuo594/mql5-help-mcp
   ```
   你应该看到：
   ```
   🚀 MQL5 Help MCP Server 启动中...
   📂 文档目录: MQL5_HELP:... | MQL5_Algo_Book:... | Neural_Networks_Book:...
   ✅ 服务器就绪，等待连接...
   ```

### 2. Claude Code 命令行工具相关

**使用 Claude Code CLI 管理 MCP**：

```bash
# 查看所有 MCP 服务器
claude mcp list

# 查看特定 MCP 详情
claude mcp get mql5-help

# 删除 MCP 服务器
claude mcp remove mql5-help
```

### 3. 手动配置 MCP（不使用 CLI）

如果你想手动编辑配置文件，配置文件位置：
- **Windows**: `%USERPROFILE%\.claude\claude_desktop_config.json`（Claude Desktop）或 `%USERPROFILE%\.claude.json`（Claude Code）
- **macOS**: `~/Library/Application Support/Claude/claude_desktop_config.json`
- **Linux**: `~/.config/claude/claude_desktop_config.json`

添加如下配置：

```json
{
  "mcpServers": {
    "mql5-help": {
      "command": "npx",
      "args": ["-y", "github:caoshuo594/mql5-help-mcp"]
    }
  }
}
```

### 4. 本地开发模式问题

**模块未找到/未编译**：

```bash
cd /path/to/mql5-help-mcp
npm install
npm run build
```

确保 `build/index.js` 存在。

### 5. 搜索不到文档

- 优先使用英文函数名（如 `OrderSend`、`CopyBuffer`、`OnTick`）
- 确认拼写正确，或试试更短的关键词
- 类名支持变体：`CTrade` 和 `Trade` 都可以搜索到

### 6. Windows 路径问题

在 JSON 配置文件中，路径需要正确转义：

```json
// ✅ 正确 - 使用正斜杠
"args": ["D:/my-program/mql5-help-mcp/build/index.js"]

// ✅ 正确 - 使用双反斜杠
"args": ["D:\\my-program\\mql5-help-mcp\\build\\index.js"]

// ❌ 错误 - 单反斜杠会被解析为转义字符
"args": ["D:\my-program\mql5-help-mcp\build\index.js"]
```

## 路线图（Roadmap）

- [高] 智能错误匹配：从编译错误文本直达解决方案
- [高] 常见错误解决方案库：成因、定位、替代 API 表
- [高] 代码示例库：EA 模板、常用策略与 CTrade 用法
- [中] 上下文感知搜索：术语映射、别名与常见写法
- [中] 交互式帮助：基于行号与上下文的追问式诊断
- [中] 学习路径推荐：迁移→标准库→指标/交易→优化
- [低] 统一索引两本电子书，纳入 `search/browse`
- [低] 标签系统与版本标注：难度/用途/版本/主题

## 许可证与鸣谢

- 许可证：MIT（详见 [LICENSE](LICENSE)）
- 文档版权：MQL5 官方文档归 MetaQuotes Ltd. 所有；两本电子书版权归原作者所有
- 致谢：Model Context Protocol、MQL5 社区与贡献者

---

专为量化开发者打造的“问题驱动”MQL5 知识助手：不仅能查文档，更帮你定位与解决真实问题。
