# MQL5 错误收集系统使用指南

## 概述

MQL5 Help MCP v1.3.0 引入了**本地错误收集系统**,让你可以积累和共享 MQL5 编译错误的解决方案。这是一个**完全本地化**的系统,无需网络服务器,数据存储在你的电脑上(`~/.mql5-help-mcp/mql5_errors.db`)。

## 核心理念

**不需要网络服务器!** 这个系统采用纯本地方案:

- ✅ 使用 SQLite 本地数据库
- ✅ 完全离线运行
- ✅ 零网络依赖
- ✅ 数据存储在用户主目录
- ✅ 跨项目共享错误库
- ✅ 支持导出/导入 JSON（团队协作）

## 工作流程

### 1. 遇到编译错误时

当你的 MQL5 代码编译出错时,先使用 `smart_query` 查询:

```
我的代码报错: error E512: undeclared identifier ResultCode
```

**`smart_query` 会自动:**
1. 首先从错误数据库搜索历史解决方案
2. 如果数据库中有记录,直接返回解决方案(出现次数、解决方法、相关文档)
3. 如果数据库中没有,再从 MQL5 官方文档搜索

### 2. 解决问题后记录

解决问题后,使用 `log_error` 记录到数据库:

```
记录这个错误到数据库:
- 错误代码: E512
- 错误消息: undeclared identifier ResultCode
- 解决方案: ResultCode 在 MQL5 中改为 ResultRetcode(),使用 trade.ResultRetcode() 获取交易结果
- 相关文档: ["CTrade.htm", "trade_constants.htm"]
```

**系统会:**
- 自动检查是否已存在相同错误
- 如果存在,增加出现次数并更新解决方案
- 如果不存在,创建新记录
- 记录首次和最后遇到时间

### 3. 查看高频错误

定期查看最常见的错误,了解自己的常见问题:

```
显示最常见的 10 个编译错误
```

输出示例:
```
📊 最常见的MQL5编译错误 (TOP 10)

1. E512 - undeclared identifier ResultCode
   🔢 出现次数: 15
   📅 最后遇到: 2024-11-25T10:30:00.000Z
   💡 解决方案: 改用 ResultRetcode()

2. E308 - invalid function call
   🔢 出现次数: 8
   📅 最后遇到: 2024-11-24T15:20:00.000Z
   💡 解决方案: 检查函数参数类型和数量

...
```

### 4. 团队协作 - 导出/导入

**导出错误库（匿名模式）:**

```
导出错误数据库,使用匿名模式保护隐私
```

这会生成 JSON 格式的数据,你可以分享给团队成员:

```json
[
  {
    "id": 1,
    "error_code": "E512",
    "error_message": "undeclared identifier ResultCode",
    "solution": "改用 ResultRetcode()",
    "related_docs": "[\"CTrade.htm\"]",
    "occurrence_count": 15,
    "first_seen": "2024-11-01T08:00:00.000Z",
    "last_seen": "2024-11-25T10:30:00.000Z"
  }
]
```

注意:`anonymize=true` 时文件路径会被移除,保护隐私。

**导入团队错误库:**

```
从这个 JSON 导入错误库: [复制上面的 JSON 数据]
```

系统会智能合并:
- 新错误直接导入
- 已存在的错误保留更高的出现次数
- 更新最后遇到时间

### 5. 查看数据库统计

```
查看错误数据库的统计信息
```

输出示例:
```
📈 错误数据库统计信息

📊 数据统计:
  • 总错误类型: 25
  • 总出现次数: 156
  • 平均每错误: 6.2 次

💾 数据库信息:
  • 位置: C:\Users\YourName\.mql5-help-mcp\mql5_errors.db
```

## 使用场景

### 场景 1: 个人学习

**问题:** 初学者经常遇到相同的错误,每次都要重新搜索解决方案。

**解决方案:**
1. 第一次遇到错误 → `smart_query` 查询(从文档)
2. 解决后 → `log_error` 记录
3. 第二次遇到 → `smart_query` 自动从数据库返回之前的解决方案
4. 定期 → `list_common_errors` 复习常见问题

**收益:** 节省查询时间,建立个人知识库

### 场景 2: 团队协作

**问题:** 团队多人开发,新人经常遇到老问题。

**解决方案:**
1. 资深开发者积累错误库 → 定期 `manage_error_db(action="export")`
2. 导出 JSON 文件 → 分享到团队仓库
3. 新人导入 → `manage_error_db(action="import", data="{...}")`
4. 新人遇到问题 → `smart_query` 自动查询团队知识库

**收益:** 团队知识共享,减少重复问题

### 场景 3: 培训材料

**问题:** 需要整理常见错误清单用于培训。

**解决方案:**
1. 收集各种错误 → 使用 `log_error`
2. 导出完整列表 → `manage_error_db(action="export")`
3. 编辑美化 JSON → 制作培训文档
4. 学员导入 → 快速建立错误知识库

**收益:** 标准化培训材料,提升学习效率

## 数据库结构

错误记录包含以下字段:

```typescript
interface ErrorRecord {
  id?: number;                   // 自动递增ID
  error_code: string;            // 错误代码 (如 "E512")
  error_message: string;         // 完整错误消息
  file_path?: string;            // 文件路径 (可选)
  solution?: string;             // 解决方案
  related_docs?: string;         // 相关文档 (JSON数组)
  occurrence_count: number;      // 出现次数
  first_seen: string;            // 首次遇到 (ISO 8601)
  last_seen: string;             // 最后遇到 (ISO 8601)
}
```

**去重逻辑:** `error_code` + `error_message` 作为唯一键,相同错误只保留一条记录,但会增加 `occurrence_count`。

## 性能与存储

### 性能优化

- **索引:** 对 `error_code`、`occurrence_count`、`last_seen` 建立索引
- **WAL 模式:** 提升并发性能
- **智能缓存:** 单例模式,启动时初始化一次

### 存储位置

```
Windows:  C:\Users\YourName\.mql5-help-mcp\mql5_errors.db
macOS:    /Users/yourname/.mql5-help-mcp/mql5_errors.db
Linux:    /home/yourname/.mql5-help-mcp/mql5_errors.db
```

**为什么在用户主目录?**
- 跨项目共享同一个错误库
- 避免每个项目都有独立数据库
- 备份和迁移更方便

### 存储大小

- 每条错误记录约 1-2 KB
- 1000 条记录约 1-2 MB
- SQLite 自动压缩存储

## 隐私保护

### 文件路径处理

错误记录中的 `file_path` 可能包含敏感信息(项目路径、用户名等)。

**建议:**
1. 个人使用 → 可以记录完整路径,方便定位
2. 团队分享 → 使用 `anonymize=true` 导出,自动移除路径
3. 公开分享 → 务必使用匿名模式

**匿名导出:**
```
导出错误数据库,匿名模式
```

导出的 JSON 中 `file_path` 字段会被移除。

## 常见问题

### Q1: 数据库文件在哪里?

A: 运行 `manage_error_db(action="stats")` 查看数据库路径。

### Q2: 如何备份数据库?

A: 两种方式:
1. 直接复制 `~/.mql5-help-mcp/mql5_errors.db` 文件
2. 使用 `manage_error_db(action="export")` 导出 JSON(更易读)

### Q3: 可以删除某条错误记录吗?

A: 当前版本不支持通过工具删除,但可以:
1. 导出 JSON
2. 手动编辑 JSON(删除不需要的记录)
3. 删除数据库文件
4. 重新导入编辑后的 JSON

### Q4: 错误数据库会无限增长吗?

A: 不会,因为:
1. 相同错误只记录一次(增加计数)
2. SQLite 自动优化存储
3. 定期导出清理也很方便

### Q5: 如何清空数据库?

A: 删除 `~/.mql5-help-mcp/mql5_errors.db` 文件即可,服务器重启时会自动创建新的空数据库。

### Q6: 为什么不需要网络服务器?

A: 本地 SQLite 数据库已经足够满足需求:
- ✅ 速度更快(本地访问)
- ✅ 零配置(无需安装数据库服务器)
- ✅ 完全离线(无需网络连接)
- ✅ 隐私更好(数据在本地)
- ✅ 零成本(无需服务器费用)

**团队协作** 通过导出/导入 JSON 实现,比网络服务器更灵活:
- 可以通过 Git 版本控制
- 可以通过任何文件共享方式
- 每个人保留完整副本
- 不依赖中心服务器可用性

### Q7: 能同时记录中英文错误吗?

A: 可以!`error_message` 和 `solution` 字段支持 UTF-8,可以记录任何语言的内容。

## 最佳实践

### 1. 及时记录

- ✅ 解决问题后立即记录
- ✅ 解决方案写清楚步骤
- ✅ 附上相关文档链接

### 2. 规范化错误代码

- ✅ 使用标准格式: `E512`、`E308`
- ❌ 避免: `error 512`、`e512`、`512`

### 3. 解决方案质量

好的解决方案:
```
错误代码: E512
错误消息: undeclared identifier ResultCode
解决方案:
1. ResultCode 在 MQL5 中改为 ResultRetcode()
2. 使用方法: ulong code = trade.ResultRetcode()
3. 常见值: TRADE_RETCODE_DONE (10009) 表示成功
相关文档: ["CTrade.htm", "trade_constants.htm"]
```

差的解决方案:
```
解决方案: 改个名字
```

### 4. 定期维护

- 每周查看一次 `list_common_errors`,复习常见问题
- 每月导出一次备份
- 团队每季度同步一次错误库

### 5. 团队协作规范

- 建立团队错误库仓库(如 Git)
- 指定专人维护(合并新错误、更新解决方案)
- 新人入职时导入最新版本
- 定期审查和优化记录质量

## 与其他工具对比

| 特性 | 本地错误库 | 在线文档 | 笔记软件 | 网络服务器方案 |
|------|----------|---------|---------|---------------|
| 查询速度 | ⚡ 极快 | 🐢 较慢 | 🚀 快 | 🌐 依赖网络 |
| 离线可用 | ✅ 是 | ❌ 否 | ✅ 是 | ❌ 否 |
| 自动集成 | ✅ 是 | ❌ 否 | ❌ 否 | ✅ 是 |
| 团队共享 | ✅ JSON导出 | ✅ URL | ⚠️ 手动 | ✅ 在线 |
| 隐私保护 | ✅ 本地 | ⚠️ 公开 | ✅ 本地 | ⚠️ 服务器 |
| 维护成本 | ✅ 零 | N/A | ✅ 低 | ❌ 高 |
| 配置难度 | ✅ 零配置 | N/A | 🔧 需配置 | 🔧 复杂配置 |

## 未来规划

- [ ] Web 界面浏览错误库
- [ ] 错误趋势分析(时间序列)
- [ ] 智能推荐相关错误
- [ ] 自动从编译输出提取错误
- [ ] 支持附件(截图、代码片段)
- [ ] 错误分类和标签
- [ ] 多语言解决方案

## 总结

MQL5 错误收集系统是一个**完全本地化**的知识管理工具:

✅ **无需网络服务器** - SQLite 本地数据库,完全离线
✅ **智能查询优先** - `smart_query` 自动从数据库搜索
✅ **团队协作友好** - JSON 导出/导入,灵活共享
✅ **隐私保护** - 数据在本地,可选匿名导出
✅ **零配置成本** - 开箱即用,无需安装数据库服务器

开始使用:
1. 升级到 v1.3.0
2. 遇到错误用 `smart_query` 查询
3. 解决后用 `log_error` 记录
4. 积累个人/团队知识库

---

有问题或建议? 欢迎提 Issue: https://github.com/caoshuo594/mql5-help-mcp/issues
