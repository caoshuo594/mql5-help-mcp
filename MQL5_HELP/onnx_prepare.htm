<!DOCTYPE html>
<html>
  <head>
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta http-equiv="Content-Type" content="text/html; charset=Windows-1252" />
  <title>Creating a Model</title>
  <meta name="keywords" content="" />
  <link type="text/css" href="default.css" rel="stylesheet" />
  <link type="text/css" href="screenshot.css" rel="stylesheet" />
  

   
   
   


</head>

<body style="background-color:#FFFFFF; font-family:'Trebuchet MS',Tahoma,Arial,Helvetica,sans-serif; margin:0px;">



<table width="100%" height="49"  border="0" cellpadding="0" cellspacing="0" style="margin-top:0px; background-color:#1660af;">
  <tr>
    <td></td>
    <td valign="middle">
      <table style="margin-top:4px; margin-bottom:5px;" width="100%"  border="0" cellspacing="0" cellpadding="5">
        <tr valign="middle">
          <td class="nav">
<a class="h_m" href="index.htm">          MQL5 Reference </a> / <a class="h_m" href="onnx.htm"> ONNX models </a>/ Creating a Model
          </td>
          <td width="70" align="right">
          <a href="onnx_types_autoconversion.htm"><img style="vertical-align:middle;" src="previous.png" alt="Previous" width="27" height="27" border=0></a>&nbsp;
          <a href="onnx_mql5.htm"><img style="vertical-align:middle;" src="next.png" alt="Next" width="27" height="27" border="0"></a>
          </td>
        </tr>
      </table>
    </td>
    <td width="5"></td>
  </tr>
</table>



<div id="help">
<p class="p_H1"><span class="f_H1">Creating a Model</span></p>
<p class="p_Text"><span class="f_Text">Multiple methods are available to obtain a ready model in the ONNX format. The popular <a href="https://github.com/onnx/models" target="_blank" class="weblink">ONNX Model Zoo</a> library contains several pre-trained ONNX models for different types of tasks. The advantage of this collection is that each model's notebook contains links to the training dataset and references to the original paper that describes the model architecture. </span></p>
<p class="p_Text"><span class="f_Text">Most machine learning frameworks use Python. To install the ONNX runtime for Python, use one of the following commands:</span></p>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; border-color: #b3b3b3; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExample" style="page-break-inside: avoid;"><span class="f_CodeExample" style="color: #333333;">pip</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">install</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">onnxruntime</span><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">#</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">CPU</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">build</span>
<br><span class="f_CodeExample" style="color: #333333;">pip</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">install</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">onnxruntime</span><span class="f_CodeExample">-</span><span class="f_CodeExample" style="color: #333333;">gpu</span><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #333333;">#</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">GPU</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">build</span></p>
</td>
</tr>
</table>
</div>
<p class="p_Text"><span class="f_Text">To invoke the ONNX runtime in Python, use the following command</span></p>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; border-color: #b3b3b3; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExample" style="page-break-inside: avoid;"><span class="f_CodeExample" style="color: #333333;">import</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">onnxruntime</span>
<br><span class="f_CodeExample" style="color: #333333;">session</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #333333;">onnxruntime</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">InferenceSession</span><span class="f_CodeExample">(</span><span class="f_CodeExample" style="color: #008080;">&quot;path&nbsp;to&nbsp;model&quot;</span><span class="f_CodeExample">)</span></p>
</td>
</tr>
</table>
</div>
<p class="p_Text"><span class="f_Text">For model <a href="onnxsetinputshape.htm" class="topiclink">inputs</a> and <a href="onnxsetoutputshape.htm" class="topiclink">outputs</a>, check out the relevant model's documentation. You can also use visualization tools to view the model, such as <a href="https://github.com/lutzroeder/Netron" target="_blank" class="weblink">Netron</a> or <a href="https://learn.microsoft.com/en-us/windows/ai/windows-ml/dashboard" target="_blank" class="weblink">WinML Dashboard</a>. In the ONNX runtime, you can also query a model's metadata and its inputs and outputs:</span></p>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; border-color: #b3b3b3; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExample" style="page-break-inside: avoid;"><span class="f_CodeExample" style="color: #333333;">results</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #333333;">session</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">run</span><span class="f_CodeExample">([</span><span class="f_CodeExample" style="color: #008080;">&quot;output1&quot;</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #008080;">&quot;output2&quot;</span><span class="f_CodeExample">],&nbsp;{</span>
<br><span class="f_CodeExample">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="f_CodeExample" style="color: #008080;">&quot;input1&quot;</span><span class="f_CodeExample">:&nbsp;</span><span class="f_CodeExample" style="color: #333333;">indata1</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #008080;">&quot;input2&quot;</span><span class="f_CodeExample">:&nbsp;</span><span class="f_CodeExample" style="color: #333333;">indata2</span><span class="f_CodeExample">})</span>
<br><span class="f_CodeExample" style="color: #333333;">results</span><span class="f_CodeExample">&nbsp;=&nbsp;</span><span class="f_CodeExample" style="color: #333333;">session</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">run</span><span class="f_CodeExample">([],&nbsp;{</span><span class="f_CodeExample" style="color: #008080;">&quot;input1&quot;</span><span class="f_CodeExample">:&nbsp;</span><span class="f_CodeExample" style="color: #333333;">indata1</span><span class="f_CodeExample">,&nbsp;</span><span class="f_CodeExample" style="color: #008080;">&quot;input2&quot;</span><span class="f_CodeExample">:&nbsp;</span><span class="f_CodeExample" style="color: #333333;">indata2</span><span class="f_CodeExample">})</span></p>
</td>
</tr>
</table>
</div>
<p class="p_Text"><span class="f_Text">You can create ONNX models directly in the MetaTrader 5 terminal or in MetaEditor using Python.</span></p>
<p class="p_H3"><span class="f_H3">Python in MetaTrader 5</span></p>
<p class="p_Text"><span class="f_Text">The MetaTrader 5 provides out-of-the-box support for Python scripts. To enable these operations, the terminal developers provide MetaTrader5 module for Python: <a href="https://pypi.org/project/MetaTrader5" target="_blank" class="weblink">https://pypi.org/project/MetaTrader5</a>.</span></p>
<p class="p_Text"><span class="f_Text">In the MetaEditor integrated development environment, in addition to creating applications in MQL5, you can also run Python scripts directly from the editor. To do this, specify the path to the executable in <a href="https://www.metatrader5.com/ru/metaeditor/help/development/python" target="_blank" class="weblink">MetaEditor settings</a>:</span></p>
<p class="p_H3" style="text-align: left;"><img class="help" alt="Setting the path to the Python executable file in MetaEditor settings" title="Setting the path to the Python executable file in MetaEditor settings" width="549" height="385" style="margin:0;width:549px;height:385px;border:none" src="metaeditor__settings.png"/></p>
<p class="p_Text"><span class="f_Text">If Python is not installed on your computer, click Install to download the installation file.</span></p>
<p class="p_Text"><span class="f_Text">You can create a Python script in MetaEdtior or upload it to the terminal's data folder and immediately run it using the F7 (Compile) key. This will open the MetaTrader 5 terminal with the script running on the current chart. Messages from the Python console (stdout, stderr) will be displayed under the <a href="https://www.metatrader5.com/ru/metaeditor/help/workspace/toolbox#errors" target="_blank" class="weblink">Errors</a> section.</span></p>
<p class="p_H3"><span class="f_H3">Operations with models in MetaTrader 5</span></p>
<p class="p_Text"><span class="f_Text">The MQL5 language allows you to run ONNX models directly in the MetaTrader 5 terminal. This is done in three steps:</span></p>
<ol style="list-style-type:decimal">
<li value="1" class="p_li"><span class="f_li">Train the model in a third-party platform, such as Python.</span></li>
<li value="2" class="p_li"><span class="f_li">Convert the model to ONNX.</span></li>
<li value="3" class="p_li"><span class="f_li">Include the ONNX model into an Expert Advisor using <a href="onnx.htm" class="topiclink">ONNX function</a> and run in the MetaTrader 5 terminal. </span></li>
</ol>
<p class="p_Text"><span class="f_Text"><a href="python_metatrader5.htm" class="topiclink">Python integration</a> in MQL5 allows running a python script and saving an ONNX model in the MetaEditor or run it directly on a chart in MetaTrader 5. You can train the model using a pre-written Python script as often as you need right in the terminal. The library includes ready-made functions for obtaining price data, which can be input into an ONNX model:</span></p>
<ul style="list-style-type:disc">
<li class="p_li"><span class="f_li"><a href="mt5copyratesfrom_py.htm" class="topiclink">copy_rates_from</a> - get bars starting from the specified date</span></li>
<li class="p_li"><span class="f_li"><a href="mt5copyratesfrompos_py.htm" class="topiclink">copy_rates_from_pos</a> - get bars starting from the specified index</span></li>
<li class="p_li"><span class="f_li"><a href="mt5copyratesrange_py.htm" class="topiclink">copy_rates_range</a> - get bars for the specified date range</span></li>
<li class="p_li"><span class="f_li"><a href="mt5copyticksfrom_py.htm" class="topiclink">copy_ticks_from</a> - get ticks starting from the specified date</span></li>
<li class="p_li"><span class="f_li"><a href="mt5copyticksrange_py.htm" class="topiclink">copy_ticks_range</a> - get ticks for the specified date range</span></li>
</ul>
<p class="p_li"><span class="f_li">&nbsp;</span></p>
<p class="p_H3"><a name="model_sample" class="hmanchor"></a><span class="f_H3">Model example</span></p>
<p class="p_Text"><span class="f_Text">En example of a finished ONNX model is available in <a href="https://www.metatrader5.com/ru/metaeditor/help/mql5storage/projects#public" target="_blank" class="weblink">public projects</a>. You should first activate <a href="https://www.metatrader5.com/ru/metaeditor/help/mql5storage/mql5storage_connect" target="_blank" class="weblink">MQL5 Storage</a> in the Navigator by specifying you MQL5 login in MetaEditor settings (case sensitive).</span></p>
<p class="p_Text"><img class="help" alt="activate_storage" width="367" height="422" style="margin:0;width:367px;height:422px;border:none" src="activate_storage.png"/></p>
<p class="p_Text"><span class="f_Text">After activation, find the ONNX.Price.Prediction project and join it via the context menu command.</span></p>
<p class="p_Text"><img class="help" alt="project_join" width="876" height="222" style="margin:0;width:876px;height:222px;border:none" src="project_join.png"/></p>
<p class="p_Text"><span class="f_Text">&nbsp;</span></p>
<p class="p_Text"><span class="f_Text">Next, update the project from MQL5 Storage.</span></p>
<p class="p_Text"><img class="help" alt="update_project" width="874" height="790" style="margin:0;width:874px;height:790px;border:none" src="update_project.png"/></p>
<p class="p_Text"><span class="f_Text">The project contains an ONNX model, two python scripts, an MQL5 script for project operation, and an MQL5 project file (ONNX.Price.Prediction.mqproj).</span></p>
<p class="p_Text"><img class="help" alt="python_script" width="947" height="466" style="margin:0;width:947px;height:466px;border:none" src="python_script.png"/></p>
<p class="p_Text"><span class="f_Text">&nbsp;</span></p>
<p class="p_Text"><span class="f_Text">&nbsp;</span></p>
<p class="p_Text"><span class="f_Text">You can create the ONNX model yourself using the PricePredictionTraining.py script included in the project. To do this, you should first install the required modules from the command line.</span></p>
<div style="text-align: left; text-indent: 0; line-height: 1.0; page-break-inside: avoid; border-color: #b3b3b3; border-style: solid; border-width: thin; background: #fbf9f5; padding: 0 0 0 0; margin: 2px 17px 2px 17px;"><table cellspacing="0" cellpadding="3" border="0" style="text-align: justify;border:none; border-spacing:0;">
<tr>
<td style="vertical-align:top; padding:3px; border:none"><p class="p_CodeExample" style="page-break-inside: avoid;"><span class="f_CodeExample" style="color: #333333;">python</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">exe</span><span class="f_CodeExample">&nbsp;-</span><span class="f_CodeExample" style="color: #333333;">m</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">pip</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">install</span><span class="f_CodeExample">&nbsp;--</span><span class="f_CodeExample" style="color: #333333;">upgrade</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">pip</span>
<br><span class="f_CodeExample" style="color: #333333;">python&nbsp;-m&nbsp;pip</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">install</span><span class="f_CodeExample">&nbsp;--</span><span class="f_CodeExample" style="color: #333333;">upgrade</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">tensorflow</span>
<br><span class="f_CodeExample" style="color: #333333;">python&nbsp;-m&nbsp;pip</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">install</span><span class="f_CodeExample">&nbsp;--</span><span class="f_CodeExample" style="color: #333333;">upgrade</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">pandas</span>
<br><span class="f_CodeExample" style="color: #333333;">python&nbsp;-m&nbsp;pip</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">install</span><span class="f_CodeExample">&nbsp;--</span><span class="f_CodeExample" style="color: #333333;">upgrade</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">scikit</span><span class="f_CodeExample">-</span><span class="f_CodeExample" style="color: #333333;">learn</span>
<br><span class="f_CodeExample" style="color: #333333;">python&nbsp;-m&nbsp;pip</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">install</span><span class="f_CodeExample">&nbsp;--</span><span class="f_CodeExample" style="color: #333333;">upgrade</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">matplotlib</span>
<br><span class="f_CodeExample" style="color: #333333;">python&nbsp;-m&nbsp;pip</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">install</span><span class="f_CodeExample">&nbsp;--</span><span class="f_CodeExample" style="color: #333333;">upgrade</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">tqdm</span>
<br><span class="f_CodeExample" style="color: #333333;">python&nbsp;-m&nbsp;pip</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">install</span><span class="f_CodeExample">&nbsp;--</span><span class="f_CodeExample" style="color: #333333;">upgrade</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">metatrader5</span>
<br><span class="f_CodeExample" style="color: #333333;">python&nbsp;-m&nbsp;pip</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">install</span><span class="f_CodeExample">&nbsp;--</span><span class="f_CodeExample" style="color: #333333;">upgrade</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">onnx</span><span class="f_CodeExample">==</span><span class="f_CodeExample" style="color: #333333;">1</span><span class="f_CodeExample">.</span><span class="f_CodeExample" style="color: #333333;">12</span>
<br><span class="f_CodeExample" style="color: #333333;">python&nbsp;-m&nbsp;pip</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">install</span><span class="f_CodeExample">&nbsp;--</span><span class="f_CodeExample" style="color: #333333;">upgrade</span><span class="f_CodeExample">&nbsp;</span><span class="f_CodeExample" style="color: #333333;">tf2onnx</span>
<br><span class="f_CodeExample" style="color: #333333;">python&nbsp;-m&nbsp;pip&nbsp;install&nbsp;--upgrade&nbsp;numpy</span>
<br><span class="f_CodeExample" style="color: #333333;">python&nbsp;-m&nbsp;pip&nbsp;install&nbsp;onnxruntime</span></p>
</td>
</tr>
</table>
</div>
<p class="p_Text"><span class="f_Text">After installing the modules, open the PricePredictionTraining.py script in MetaEditor and run it with the Compile button or with the F7 key.</span></p>
<p class="p_Text"><span class="f_Text"> </span><img class="help" alt="python_script_compile" width="895" height="644" style="margin:0;width:895px;height:644px;border:none" src="python_script_compile_zoom100.png"/></p>
<p class="p_Text"><span class="f_Text">&nbsp;</span></p>
<p class="p_Text"><span class="f_Text">Before running the Python script, make sure that the MetaTrader 5 terminal is connected to a server with the EURUSD symbol available. For example, connect to the MetaQuotes-Demo server and check &quot;Integration with Python&quot; in terminal <a href="https://www.metatrader5.com/ru/terminal/help/startworking/settings#community" target="_blank" class="weblink">settings</a>.</span></p>
<p class="p_Text"><img class="help" alt="terminal_py_integration_check_box" width="622" height="402" style="margin:0;width:622px;height:402px;border:none" src="terminal_py_integration_check_box.png"/></p>
<p class="p_Text"><span class="f_Text">&nbsp;</span></p>
<p class="p_Text"><span class="f_Text">While training the network, MetaEditor will print messages from the Python script until the training is complete.</span></p>
<p class="p_Text"><img class="help" alt="onnx_model_ready" width="676" height="468" style="margin:0;width:676px;height:468px;border:none" src="onnx_model_ready.png"/></p>
<p class="p_Text"><span class="f_Text">&nbsp;</span></p>
<p class="p_Text"><span class="f_Text">When the result is 100%, the ONNX model is ready and it is saved to the project folder at &lt;terminal data directory&gt;\MQL5\Shared Projects\ONNX.Price.Prediction\Python.</span></p>
<p class="p_Text"><span class="f_Text">You can check the resulting model by running the second script PricePrediction.py, pressing </span><span class="f_Text" style="font-weight: bold;"> F7</span><span class="f_Text">.</span></p>
<p class="p_Text"><img class="help" alt="prediction_result" width="676" height="373" style="margin:0;width:676px;height:373px;border:none" src="prediction_result.png"/></p>
<p class="p_Text"><span class="f_Text">&nbsp;</span></p>

</div>

</body>
</html>
